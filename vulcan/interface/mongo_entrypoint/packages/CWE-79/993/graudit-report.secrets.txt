/src/red/api/auth/strategies.js-52-    Clients.get(clientId).then(function(client) {
/src/red/api/auth/strategies.js:53:        if (client && client.secret == clientSecret) {
/src/red/api/auth/strategies.js-54-            done(null,client);
##############################################
/src/red/api/auth/index.js-68-function ensureClientSecret(req,res,next) {
/src/red/api/auth/index.js:69:    if (!req.body.client_secret) {
/src/red/api/auth/index.js:70:        req.body.client_secret = 'not_available';
/src/red/api/auth/index.js-71-    }
##############################################
/src/red/runtime/storage/localfilesystem/projects/Project.js-62-    this.missingFiles = [];
/src/red/runtime/storage/localfilesystem/projects/Project.js:63:    this.credentialSecret = null;
/src/red/runtime/storage/localfilesystem/projects/Project.js-64-}
##############################################
/src/red/runtime/storage/localfilesystem/projects/Project.js-75-
/src/red/runtime/storage/localfilesystem/projects/Project.js:76:    this.credentialSecret = projectSettings.credentialSecret;
/src/red/runtime/storage/localfilesystem/projects/Project.js-77-    this.git = projectSettings.git || { user:{} };
##############################################
/src/red/runtime/storage/localfilesystem/projects/Project.js-144-        projects.projects[project.name] = projects.projects[project.name] || {};
/src/red/runtime/storage/localfilesystem/projects/Project.js:145:        projects.projects[project.name].credentialSecret = data.credentialSecret;
/src/red/runtime/storage/localfilesystem/projects/Project.js-146-        promises.push(settings.set('projects',projects));
##############################################
/src/red/runtime/storage/localfilesystem/projects/Project.js-254-    if (data.credentialSecret && data.credentialSecret !== this.credentialSecret) {
/src/red/runtime/storage/localfilesystem/projects/Project.js:255:        var existingSecret = data.currentCredentialSecret;
/src/red/runtime/storage/localfilesystem/projects/Project.js-256-        var isReset = data.resetCredentialSecret;
/src/red/runtime/storage/localfilesystem/projects/Project.js:257:        var secret = data.credentialSecret;
/src/red/runtime/storage/localfilesystem/projects/Project.js-258-
##############################################
/src/red/runtime/storage/localfilesystem/projects/Project.js-272-        }
/src/red/runtime/storage/localfilesystem/projects/Project.js:273:        this.credentialSecret = secret;
/src/red/runtime/storage/localfilesystem/projects/Project.js-274-
/src/red/runtime/storage/localfilesystem/projects/Project.js:275:        globalProjectSettings.projects[this.name].credentialSecret = project.credentialSecret;
/src/red/runtime/storage/localfilesystem/projects/Project.js-276-        delete this.credentialSecretInvalid;
##############################################
/src/red/runtime/storage/localfilesystem/projects/Project.js-757-        settings: {
/src/red/runtime/storage/localfilesystem/projects/Project.js:758:            credentialsEncrypted: (typeof this.credentialSecret === "string"),
/src/red/runtime/storage/localfilesystem/projects/Project.js-759-            credentialSecretInvalid: this.credentialSecretInvalid
##############################################
/src/red/runtime/storage/localfilesystem/projects/Project.js-927-                if (metadata.hasOwnProperty('credentialSecret')) {
/src/red/runtime/storage/localfilesystem/projects/Project.js:928:                    projects.projects[project].credentialSecret = metadata.credentialSecret;
/src/red/runtime/storage/localfilesystem/projects/Project.js-929-                }
##############################################
/src/red/runtime/storage/localfilesystem/projects/index.js-362-        if (!metadata.hasOwnProperty('credentialSecret')) {
/src/red/runtime/storage/localfilesystem/projects/index.js:363:            metadata.credentialSecret = currentEncryptionKey;
/src/red/runtime/storage/localfilesystem/projects/index.js-364-        }
##############################################
/src/red/runtime/storage/localfilesystem/projects/index.js-373-        metadata.files.oldCredentials = credentialsFile;
/src/red/runtime/storage/localfilesystem/projects/index.js:374:        metadata.files.credentialSecret = currentEncryptionKey;
/src/red/runtime/storage/localfilesystem/projects/index.js-375-    }
##############################################
/src/public/red/red.js-21847-                                    }
/src/public/red/red.js:21848:                                    projectData.credentialSecret = projectSecretInput.val();
/src/public/red/red.js-21849-                                    var repoUrl = projectRepoInput.val();
##############################################
/src/public/red/red.js-22205-                                        if (encryptionKeyType === 'custom') {
/src/public/red/red.js:22206:                                            createProjectOptions.credentialSecret = emptyProjectCredentialInput.val();
/src/public/red/red.js-22207-                                        } else {
##############################################
/src/public/red/red.js-22213-                                        // Disabled encryption by explicitly setting credSec to false
/src/public/red/red.js:22214:                                        createProjectOptions.credentialSecret = false;
/src/public/red/red.js-22215-                                    }
##############################################
/src/public/red/red.js-22729-                                        if (encryptionState === 'enabled') {
/src/public/red/red.js:22730:                                            projectData.credentialSecret = emptyProjectCredentialInput.val();
/src/public/red/red.js-22731-                                        } else {
/src/public/red/red.js-22732-                                            // Disabled encryption by explicitly setting credSec to false
/src/public/red/red.js:22733:                                            projectData.credentialSecret = false;
/src/public/red/red.js-22734-                                        }
##############################################
/src/public/red/red.js-22739-                                    } else if (projectType === 'clone') {
/src/public/red/red.js:22740:                                        projectData.credentialSecret = projectSecretInput.val();
/src/public/red/red.js-22741-                                        var repoUrl = projectRepoInput.val();
##############################################
/src/public/red/red.js-24638-                if (credentialSecretResetButton.hasClass('selected')) {
/src/public/red/red.js:24639:                    payload.resetCredentialSecret = true;
/src/public/red/red.js-24640-                }
/src/public/red/red.js-24641-                if (credentialSecretResetButton.hasClass('selected') || credentialSecretEditButton.hasClass('selected')) {
/src/public/red/red.js:24642:                    payload.credentialSecret = credentialSecretNewInput.val();
/src/public/red/red.js-24643-                    if (credentialSecretExistingInput.is(":visible")) {
/src/public/red/red.js:24644:                        payload.currentCredentialSecret = credentialSecretExistingInput.val();
/src/public/red/red.js-24645-                    }
##############################################
/src/public/red/red.min.js-15- **/
/src/public/red/red.min.js:16:var RED={};RED.events=function(){var a={};return{on:function(e,t){a[e]=a[e]||[],a[e].push(t)},off:function(e,t){var n=a[e];if(n)for(var o=0;o<n.length;o++)if(n[o]===t)return void n.splice(o,1)},emit:function(t,e){if(a[t])for(var n=0;n<a[t].length;n++)try{a[t][n](e)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n={init:function(e){i18n.init({resGetPath:"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1},function(){e()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(n,o){var e=i18n.functions.toLanguages(i18n.detectLanguage()),a=e.length;e.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/"+n+"?lng="+t,success:function(e){i18n.addResourceBundle(t,n,e),0==--a&&o()}})})},loadNodeCatalogs:function(e){var t=i18n.functions.toLanguages(i18n.detectLanguage()),o=t.length;t.forEach(function(n){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/nodes?lng="+n,success:function(t){Object.keys(t).forEach(function(e){i18n.addResourceBundle(n,e,t[e])}),0==--o&&e()}})})}},RED.settings=function(){var e,n={},o={},a=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},i=function(o){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(e){!function(e){for(var t in n)n.hasOwnProperty(t)&&RED.settings.hasOwnProperty(t)&&delete RED.settings[t];for(t in e)e.hasOwnProperty(t)&&(RED.settings[t]=e[t]);n=e}(e),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+e.version),t(o)},error:function(e,t,n){401===e.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){i(o)})):console.log("Unexpected error loading settings:",e.status,t)}})};function t(t){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(e){o=e,t()},error:function(e,t,n){console.log("Unexpected error loading user settings:",e.status,t)}})}function s(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout(function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(o),success:function(e){},error:function(e,t,n){console.log("Unexpected error saving user settings:",e.status,t)}})},300))}return{init:function(e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var n=t[1];RED.settings.set("auth-tokens",{access_token:n}),window.location.search=""}$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){var n=RED.settings.get("auth-tokens");n&&e.setRequestHeader("Authorization","Bearer "+n.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),i(e)},load:i,loadUserSettings:t,set:function(e,t){a()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(o[e]=t,s()))},get:function(e){if(a())return"auth-tokens"===e?JSON.parse(localStorage.getItem(e)):o[e]},remove:function(e){a()&&("auth-tokens"===e?localStorage.removeItem(e):(delete o[e],s()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var n=e.split("."),o=RED.settings.editorTheme;try{for(var a=0;a<n.length;a++)o=o[n[a]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function p(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),p(),RED.events.emit("login",RED.settings.user.username)})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var a=/^((.+)\.)?read$/,i=/^((.+)\.)?write$/;return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var e=$('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"></a></li>').prependTo(".header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(e.find("a")):$('<i class="fa fa-user"></i>').appendTo(e.find("a")),RED.menu.init({id:"btn-usermenu",options:[]}),p()}},login:function(d,l){"function"==typeof d&&(l=d,d={});var c=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');c.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!!d.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(a){var e=0;if("credentials"==a.type){for(;e<a.prompts.length;e++){var t=a.prompts[e],n=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+t.id+'">'+RED._(t.label)+":</label><br/>").appendTo(n);var o=$('<input style="width: 100%" id="node-dialog-login-'+t.id+'" type="'+t.type+'" tabIndex="'+(e+1)+'"/>').appendTo(n);e<a.prompts.length-1&&o.keypress(function(){var t=n;return function(e){13==e.keyCode&&(t.next("div").find("input").focus(),e.preventDefault())}}()),n.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(d.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(e+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(e+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(e){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var t={client_id:"node-red-editor",grant_type:"password",scope:""},n=0;n<a.prompts.length;n++){var o=a.prompts[n];t[o.id]=$("#node-dialog-login-"+o.id).val()}$.ajax({url:"auth/token",type:"POST",data:t}).done(function(e,t,n){RED.settings.set("auth-tokens",e),$("#node-dialog-login").dialog("destroy").remove(),d.updateMenu&&p(),l()}).fail(function(e,t,n){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),e.preventDefault()})}else if("strategy"==a.type)for(e=0;e<a.prompts.length;e++){t=a.prompts[e],n=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var i=$('<a href="#"></a>',{style:"padding: 10px"}).appendTo(n).click(function(){document.location=t.url});if(t.image)$("<img>",{src:t.image}).appendTo(i);else if(t.label){var s=$("<span></span>").text(t.label);t.icon&&($("<i></i>",{class:"fa fa-2x "+t.icon,style:"vertical-align: middle"}).appendTo(i),s.css({verticalAlign:"middle",marginLeft:"8px"})),s.appendTo(i)}i.button()}d.cancelable&&$("#node-dialog-login-cancel").button().click(function(e){$("#node-dialog-login").dialog("destroy").remove()});var r=a.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){c.dialog("open")}).attr("src",r)}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done(function(e,t,n){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,n){401===e.status?document.location.reload(!0):console.log(t)})},hasPermission:function(e){return""===e||!RED.settings.user||function e(t,n){if(""===n)return!0;var o;if(Array.isArray(n)){for(o=0;o<n.length;o++)if(!e(t,n[o]))return!1;return!0}if(Array.isArray(t)){if(0===t.length)return!1;for(o=0;o<t.length;o++)if(e(t[o],n))return!0;return!1}return"*"===t||t===n||("read"===t||"*.read"===t?a.test(n):("write"===t||"*.write"===t)&&i.test(n))}(RED.settings.user.permissions||"",e)}}}(),RED.comms=function(){var o,a=null,i=null,s=null,l=10,c={},p=!1,u=0,f=!1;return{connect:function r(){f=!0;var e=location.hostname,t=location.port;0!==t.length&&(e=e+":"+t),e=(e+=document.location.pathname)+("/"==e.slice(-1)?"":"/")+"comms",e="ws"+("https:"==document.location.protocol?"s":"")+"://"+e;var n=RED.settings.get("auth-tokens");function d(){for(var e in c)c.hasOwnProperty(e)&&o.send(JSON.stringify({subscribe:e}))}p=null!=n,(o=new WebSocket(e)).onopen=function(){u=0,a&&(i=setTimeout(function(){a.close(),a=null},1e3)),p?o.send(JSON.stringify({auth:n.access_token})):d()},o.onmessage=function(e){for(var t=JSON.parse(e.data),n=0;n<t.length;n++){var o=t[n];if(p&&o.auth)"ok"===o.auth?(p=!1,d()):"fail"===o.auth&&(f=!1,RED.user.login({updateMenu:!0},function(){r()}));else if(o.topic)for(var a in c)if(c.hasOwnProperty(a)&&new RegExp("^"+a.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(o.topic)){var i=c[a];if(i)for(var s=0;s<i.length;s++)i[s](o.topic,o.data)}}},o.onclose=function(){f&&(i&&(clearTimeout(i),i=null),++u<10?(setTimeout(r,1e3),5<u&&null==a&&(a=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):u<20?setTimeout(r,2e3):(l=60,s=setInterval(function(){if(0==--l)a.update(RED._("notification.errors.lostConnection")),clearInterval(s),r();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:l})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";a.update(e),$(a).find("a").click(function(e){e.preventDefault(),a.update(RED._("notification.errors.lostConnection")),clearInterval(s),r()})}},1e3)))}},subscribe:function(e,t){null==c[e]&&(c[e]=[]),c[e].push(t),o&&1==o.readyState&&o.send(JSON.stringify({subscribe:e}))},unsubscribe:function(e,t){if(c[e]){for(var n=0;n<c[e].length;n++)if(c[e][n]===t){c[e].splice(n,1);break}0===c[e].length&&delete c[e]}}}}(),RED.text={},RED.text.bidi=function(){var t="";function n(e){return"auto"==t?function(e){for(var t,n,o=e.length,a=0;a<o;a++){if(1488<=(n=e.charCodeAt(a))&&n<=1535||1536<=n&&n<=1631||1642<=n&&n<=1775||1786<=n&&n<=2047||64285<=n&&n<=65023||65136<=n&&n<=65276)return!0;if(64<(t=e.charCodeAt(a))&&t<91||96<t&&t<123)return!1}return!1}(e)?"rtl":"ltr":t}function o(){$(this).attr("dir",n($(this).val()))}return{setTextDirection:function(e){t=e,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",n($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",n($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var t=n(e);if("ltr"==t)return"‪"+e+"‬";if("rtl"==t)return"‫"+e+"‬"}return e},resolveBaseTextDir:n,prepareInput:function(e){e.on("keyup",o).on("paste",o).on("cut",o),o.call(e)}}}(),RED.text.format=function(){var f=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},d=function(){function p(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var n=parseInt(e.length,10);return isNaN(n)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function u(e,t){var n={};for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o]);var a=e.content,i=n.usePos&&n.startPos<a.length;i&&(n.start="",n.loops=!1),n.bStart=i?n.startPos:0<n.start.length?a.indexOf(n.start):0;var s=n.useLength&&0<n.length&&n.bStart+n.length<a.length;return s&&(n.end=""),n.bEnd=s?n.bStart+n.length:0<n.end.length?a.indexOf(n.end,n.bStart+n.start.length)+1:a.length,n.after||(n.start=""),n.before||(n.end=""),n}return{handleSubcontents:function(e,t,n,o,a){if(!n.content||"string"!=typeof n.content||0===n.content.length)return e;var i=!0;void 0!==n.loops&&(i=!!n.loops);for(var s=0;!(s>=e.length);s++)if(!(e[s].isParsed||e.keep||e[s].isSeparator)){var r=e[s].content,d=r.indexOf(n.content);if(!(d<0)){var l,c=0;if(n.continued)for(;c++,0===(l=r.indexOf(n.content,d+c*n.content.length)););else c=1;if(l=d+c*n.content.length,e.splice(s,1),0<d&&(e.splice(s,0,new f({content:r.substring(0,d),localGui:t.dir,keep:!0})),s++),e.splice(s,0,new f({content:r.substring(d,l),textDirection:n.subDir,localGui:t.dir})),l<r.length&&e.splice(s+1,0,new f({content:r.substring(l,r.length),localGui:t.dir,keep:!0})),!i)break}}},handleBounds:function(e,t,n,o,a){for(var i=0;i<n.length;i++)if(p(n[i]))for(var s=0;!(s>=e.length);s++)if(!(e[s].isParsed||e[s].inBounds||e.keep||e[s].isSeparator)){var r=u(e[s],n[i]),d=r.bStart,l=r.bEnd;if(!(d<0||l<0)){var c=e[s].content;if(e.splice(s,1),0<d&&(e.splice(s,0,new f({content:c.substring(0,d),localGui:t.dir,keep:!0})),s++),r.start&&(e.splice(s,0,new f({content:r.start,localGui:t.dir,isSeparator:!0})),s++),e.splice(s,0,new f({content:c.substring(d+r.start.length,l-r.end.length),textDirection:r.subDir,localGui:t.dir,inBounds:!0})),r.end&&(s++,e.splice(s,0,new f({content:r.end,localGui:t.dir,isSeparator:!0}))),l+r.end.length<c.length&&e.splice(s+1,0,new f({content:c.substring(l+r.end.length,c.length),localGui:t.dir,keep:!0})),!r.loops)break}}for(i=0;i<e.length;i++)e[i].inBounds=!1;return e},handleCases:function(e,t,n,o,a){if(0===n.length)return e;var i={};for(var s in t)t.hasOwnProperty(s)&&(i[s]=t[s]);for(var r=0;r<n.length;r++)n[r].handler&&"function"==typeof n[r].handler.handle||(n[r].handler=t.commonHandler),n[r].args?(i.cases=n[r].args.cases,i.points=n[r].args.points,i.bounds=n[r].args.bounds,i.subs=n[r].args.subs):(i.cases=[],i.points=[],i.bounds=[],i.subs={}),n[r].handler.handle(o,e,i,a);return e},handlePoints:function(e,t,n,o,a){for(var i=0;i<n.length;i++)for(var s=0;!(s>=e.length);s++)if(!(e[s].isParsed||e[s].keep||e[s].isSeparator)){var r=e[s].content,d=r.indexOf(n[i]);0<=d&&(e.splice(s,1),0<d&&(e.splice(s,0,new f({content:r.substring(0,d),textDirection:t.subDir,localGui:t.dir,inPoints:!0})),s++),e.splice(s,0,new f({content:n[i],localGui:t.dir,isSeparator:!0})),d+n[i].length+1<=r.length&&e.splice(s+1,0,new f({content:r.substring(d+n[i].length),textDirection:t.subDir,localGui:t.dir,inPoints:!0})))}for(i=0;i<e.length;i++)e[i].keep?e[i].keep=!1:e[i].inPoints&&(e[i].isParsed=!0,e[i].inPoints=!1);return e}}}(),r={handle:function(e,t,n,o){var a=[];Array.isArray(n.cases)&&(a=n.cases);var i=[];void 0!==n.points&&(Array.isArray(n.points)?i=n.points:"string"==typeof n.points&&(i=n.points.split("")));var s={};"object"==typeof n.subs&&(s=n.subs);var r=[];return Array.isArray(n.bounds)&&(r=n.bounds),d.handleBounds(t,n,r,e,o),d.handleSubcontents(t,n,s,e,o),d.handleCases(t,n,a,e,o),d.handlePoints(t,n,i,e,o),t}},p={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),e=e.toLowerCase(),(o=(n=e)?n.split("-")[0]:"")&&!(o.length<2)&&["iw","he","ar","fa","ur"].some(function(e){return e===o})){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}var n,o;return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,n,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;n=/^(rtl|ltr)$/i.test(n)?n:"ltr";var a=o?e.split("").reverse().join(""):e,i=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(a);return i?i[0]<="z"?"ltr":"rtl":n},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var n="",o=0;o<e.length;o++){var a=""+e.charAt(o);switch(a){case"‎":n+="<LRM>";break;case"‏":n+="<RLM>";break;case"‪":n+="<LRE>";break;case"‫":n+="<RLE>";break;case"‭":n+="<LRO>";break;case"‮":n+="<RLO>";break;case"‬":n+="<PDF>";break;default:n+=a}}var i=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return i+n+(""===i?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},l=function(){var e={};function s(e,t){var n=Array.isArray(e)?e[0]:e;return n.guiDir||(n.guiDir="ltr"),n.dir||(n.dir=n.guiDir),t&&(void 0===n.points&&(n.points=[]),n.cases||(n.cases=[]),n.bounds||(n.bounds=[]),n.commonHandler=r),n}function a(e,t,n){if(!e||!t)return new f({content:""});var o=s(t,!0),a=[new f({content:e,actual:e,localGui:o.dir})],i=r.handle;return o.handler&&"function"==typeof o.handler&&(i=o.handler.handle),i(e,a,o,n),a}function i(e,t,n){var o=s(t,!1);return n?function(e,t,n){for(var o="",a="",i=0;i<e.length;i++)if(e[i].isVisible){var s=e[i].textDirection,r=e[i].localGui;if(""!==r&&""===a?o+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>":""===a||""!==r&&r===a&&!stop||(o+="</bdi>"+(i==e.length-1&&""!==r?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==r&&(o+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>")),"auto"===s&&(s=p.getDirection(e[i].content,s,t.guiDir)),/^(rtl|ltr)$/i.test(s)?(o+="<bdi dir='"+("rtl"===s?"rtl":"ltr")+"'>"+e[i].content+"</bdi>",s):(o+=e[i].content,p.getDirection(e[i].content,s,t.guiDir,!0)),i<e.length-1){var d=r&&e[i+1].localGui?r:t.dir;o+="<span style='unicode-bidi: embed; direction: "+("rtl"===d?"rtl":"ltr")+";'></span>"}else""!==a&&(o+="</bdi>");a=r,stop=!1}else stop=!0;var l="auto"===t.dir?p.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;l!==t.guiDir&&(o="<bdi dir='"+("rtl"===l?"rtl":"ltr")+"'>"+o+"</bdi>");return o}(e,o):function(e,t,n){for(var o="",a="",i=!1,s=0;s<e.length;s++)if(e[s].isVisible){var r=e[s].textDirection,d=e[s].localGui;if(""!==d&&""===a?o+="rtl"===d?p.RLE:p.LRE:""===a||""!==d&&d===a&&!i||(o+=p.PDF+(s==e.length-1&&""!==d?"":"rtl"===t.dir?p.RLM:p.LRM),""!==d&&(o+="rtl"===d?p.RLE:p.LRE)),"auto"===r&&(r=p.getDirection(e[s].content,r,t.guiDir)),/^(rtl|ltr)$/i.test(r)?(o+=("rtl"===r?p.RLE:p.LRE)+e[s].content+p.PDF,r):(o+=e[s].content,p.getDirection(e[s].content,r,t.guiDir,!0)),s<e.length-1){var l=d&&e[s+1].localGui?d:t.dir;o+="rtl"===l?p.RLM:p.LRM}else""!==a&&(o+=p.PDF);a=d,i=!1}else i=!0;var c="auto"===t.dir?p.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(o=("rtl"===c?p.RLE:p.LRE)+o+p.PDF);return o}(e,o)}return e.parseAndDisplayStructure=function(e,t,n,o){return e&&t?i(a(e,t,o),t,n):e},e.parseStructure=a,e.displayStructure=i,e.restore=function(e,t){return e},e}(),t={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",subs:{content:">",continued:!0,subDir:n?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:n?"ltr":"rtl"}}}]};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},n={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:","};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},o={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:function(e,t){if("ar"!==p.getLocaleDetails(t).lang)return"ltr";var n=e.indexOf("@");return 0<n&&n<e.length-1&&p.hasArabicChar(e.substring(n+1))?"rtl":"ltr"}(e,a),points:"<>.:,;@",cases:[{handler:r,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},a={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:"/\\:."};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},i={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},s={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:r,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:r,args:{subs:{content:" ",continued:!0}}},{handler:r,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},c={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:"_"};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},u={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},h={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",points:" ,.!?;:"};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},g={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:r,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},v={format:function(e,t,n,o,a,i){var s={},r="",d=Array.isArray(t)?t[0]:t;for(r in d)d.hasOwnProperty(r)&&(s[r]=d[r]);return s.guiDir=n?"rtl":"ltr",s.dir=s.dir?s.dir:s.guiDir,i?l.parseStructure(e,s,!!o,a):l.parseAndDisplayStructure(e,s,!!o,a)}},m=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function n(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function o(e){0===e.msgDir.length&&(e.msgDir=n(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:n(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function b(e){switch(e){case"breadcrumb":return t;case"comma":return n;case"email":return o;case"filepath":return a;case"formula":return i;case"sql":return s;case"underscore":return c;case"url":return u;case"word":return h;case"xpath":return g;default:return v}}function y(t,e,n,o,a){if(!t||1!=t.nodeType)return!1;m||(m=document.createEvent("Event")).initEvent("TF",!0,!0),t.setAttribute("data-tf-type",e);var i="undefined"===n?"{}":JSON.stringify(Array.isArray(n)?n[0]:n);t.setAttribute("data-tf-args",i);var s="ltr";if("undefined"===o&&(t.dir?s=t.dir:t.style&&t.style.direction&&(s=t.style.direction),o="rtl"===s.toLowerCase()),t.setAttribute("data-tf-dir",o),t.setAttribute("data-tf-locale",p.getLocaleDetails(a).lang),function(e){var t=window.navigator.userAgent;if(0<=t.indexOf("MSIE")||0<=t.indexOf("Trident")||0<=t.indexOf("Edge"))return!1;var n=document.createElement(e.tagName);n.contentEditable=!0;var o="oninput"in n;return o||(n.setAttribute("oninput","return;"),o="function"==typeof n.oninput),n=null,o}(t)){t.oninput;t.oninput=function(e){w(e.target)}}else t.onkeyup=function(e){w(e.target),t.dispatchEvent(m)},t.onmouseup=function(e){w(e.target),t.dispatchEvent(m)};return w(t),!0}function w(e){var t=e.textContent||"",n=document.getSelection();if(0===t.length||!n||n.rangeCount<=0)e.dispatchEvent(m);else{var o,a,i=n.getRangeAt(0),s=i.cloneRange();o=i.startContainer,a=i.startOffset;var r=0;3===o.nodeType&&(r+=a),s.setStart(e,0),s.setEndBefore(o);var d=document.createElement("div");d.appendChild(s.cloneContents()),r+=d.textContent.length,e.innerHTML=b(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var l=e,c=e,p=0,u=!1;for(n.removeAllRanges(),i.setStart(e,0),i.setEnd(e,0);c;){if(3===c.nodeType){if(p+c.nodeValue.length>=r){i.setStart(c,r-p);break}p+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(l=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(l===e){u=!0;break}c=l.nextSibling,l=l.parentNode}if(u)break}n.addRange(i),e.dispatchEvent(m)}}return{getHtml:function(e,t,n,o,a){return b(t).format(e,n,o,!0,a)},attach:function(e,t,n,o,a){return y(e,t,n,o,a)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9},RED.nodes=function(){var V,W,p=[],H={},u=[],K={},s=[],r={},t=null,o=!1;var Y=function(){var a={},i=[],s={},r={},n={},t={};n.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}};var o={setModulePendingUpdated:function(e,t){a[e].pending_version=t,RED.events.emit("registry:module-updated",{module:e,version:t})},getModule:function(e){return a[e]},getNodeSetForType:function(e){return o.getNodeSet(r[e])},getModuleList:function(){return a},getNodeList:function(){return i},getNodeTypes:function(){return Object.keys(n)},setNodeList:function(e){i=[];for(var t=0;t<e.length;t++){var n=e[t];o.addNodeSet(n)}},addNodeSet:function(e){e.added=!1,s[e.id]=e;for(var t=0;t<e.types.length;t++)r[e.types[t]]=e.id;i.push(e),a[e.module]=a[e.module]||{name:e.module,version:e.version,local:e.local,sets:{}},e.pending_version&&(a[e.module].pending_version=e.pending_version),a[e.module].sets[e.name]=e,RED.events.emit("registry:node-set-added",e)},removeNodeSet:function(e){for(var t=s[e],n=0;n<t.types.length;n++)delete r[t.types[n]];delete s[e];for(var o=0;o<i.length;o++)if(i[o].id===e){i.splice(o,1);break}return delete a[t.module].sets[t.name],0===Object.keys(a[t.module].sets).length&&delete a[t.module],RED.events.emit("registry:node-set-removed",t),t},getNodeSet:function(e){return s[e]},enableNodeSet:function(e){var t=s[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=s[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var o;((n[e]=t).type=e,"subflows"!=t.category)&&(t.set=s[r[e]],s[r[e]].added=!0,s[r[e]].enabled=!0,o="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=o+":"+e[0]);var n=RED._.apply(null,e);return n===e[0]&&(n=t),n});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete n[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return n[e]},setIconSets:function(e){t=e},getIconSets:function(){return t}};return o}();function Z(){return(1+4294967295*Math.random()).toString(16)}function X(e){if(0!==e.type.indexOf("subflow")?e._=e._def._:e._=RED._,"config"==e._def.category)H[e.id]=e;else{if(e.ports=[],e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.outputs)for(var t=0;t<e.outputs;t++)e.ports.push(t);if(e.dirty=!0,a(e),"subflows"==e._def.category&&void 0===e.i){var n=0;RED.nodes.eachNode(function(e){n=Math.max(n,e.i||0)}),e.i=n+1}p.push(e)}RED.events.emit("nodes:add",e)}function Q(e){u.push(e)}function f(e){if(e in H)return H[e];for(var t in p)if(p[t].id==e)return p[t];return null}function h(e){var t,o=[],a=[];if(e in H)t=H[e],delete H[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=f(e)){p.splice(p.indexOf(t),1),(o=u.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){u.splice(u.indexOf(e),1)});var i=!1;for(var s in t._def.defaults)if(t._def.defaults.hasOwnProperty(s)){var r=t._def.defaults[s];if(r.type){var d=Y.getNodeType(r.type);if(d&&"config"==d.category){var l=H[t[s]];if(l)if(i=!0,l._def.exclusive)h(t[s]),a.push(l);else{var c=l.users;c.splice(c.indexOf(t),1)}}}}i&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:o,nodes:a}}function ee(e){(K[e.id]=e)._def=RED.nodes.getType("tab"),s.push(e.id)}function te(t,e){if(e){var n=Object.keys(r).map(function(e){return r[e].name});n.sort();var o=1,a=t.name;n.forEach(function(e){a==e&&(o++,a=t.name+" ("+o+")")}),t.name=a}r[t.id]=t,RED.nodes.registerType("subflow:"+t.id,{defaults:{name:{value:""}},info:t.info,icon:function(){return t.icon||"subflow.png"},category:"subflows",inputs:t.in.length,outputs:t.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(t.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(t.id).name},inputLabels:function(e){return t.inputLabels?t.inputLabels[e]:null},outputLabels:function(e){return t.outputLabels?t.outputLabels[e]:null},set:{module:"node-red"}}),t._def=RED.nodes.getType("subflow:"+t.id)}function ne(e){return r[e]}function oe(e,t){for(var n=0;n<p.length;n++){var o=p[n];if(o.z===e){var a=/^subflow:(.+)$/.exec(o.type);if(a){if(a[1]===t)return!0;if(oe(a[1],t))return!0}}}return!1}function g(e){var t={};for(var n in t.id=e.id,t.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(t[n]=e[n]);return t}function d(t,e){if("tab"===t.type)return g(t);e=e||!1;var n={};if(n.id=t.id,n.type=t.type,n.z=t.z,"unknown"==n.type)for(var o in t._orig)t._orig.hasOwnProperty(o)&&(n[o]=t._orig[o]);else{for(var a in t._def.defaults)t._def.defaults.hasOwnProperty(a)&&(n[a]=t[a]);if(e&&t.credentials){var i={};for(var s in n.credentials={},t._def.credentials)t._def.credentials.hasOwnProperty(s)&&("password"==t._def.credentials[s].type?(!t.credentials._||t.credentials["has_"+s]!=t.credentials._["has_"+s]||t.credentials["has_"+s]&&t.credentials[s])&&(i[s]=t.credentials[s]):null==t.credentials[s]||t.credentials._&&t.credentials[s]==t.credentials._[s]||(i[s]=t.credentials[s]));0<Object.keys(i).length&&(n.credentials=i)}}if("config"!=t._def.category){n.x=t.x,n.y=t.y,n.wires=[];for(var r=0;r<t.outputs;r++)n.wires.push([]);for(var d=u.filter(function(e){return e.source===t}),l=0;l<d.length;l++){var c=d[l];"subflow"!=c.target.type&&n.wires[c.sourcePort].push(c.target.id)}if(0<t.inputs&&t.inputLabels&&!/^\s*$/.test(t.inputLabels.join(""))&&(n.inputLabels=t.inputLabels.slice()),0<t.outputs&&t.outputLabels&&!/^\s*$/.test(t.outputLabels.join(""))&&(n.outputLabels=t.outputLabels.slice()),(!t._def.defaults||!t._def.defaults.hasOwnProperty("icon"))&&t.icon){var p=RED.utils.getDefaultNodeIcon(t._def,t);t.icon!==p.module+"/"+p.file&&(n.icon=t.icon)}}return n}function v(a){var s={};return s.id=a.id,s.type=a.type,s.name=a.name,s.info=a.info,s.in=[],s.out=[],a.in.forEach(function(t){for(var e={x:t.x,y:t.y,wires:[]},n=u.filter(function(e){return e.source===t}),o=0;o<n.length;o++){var a=n[o];"subflow"!=a.target.type&&e.wires.push({id:a.target.id})}s.in.push(e)}),a.out.forEach(function(t,e){var n={x:t.x,y:t.y,wires:[]},o=u.filter(function(e){return e.target===t});for(i=0;i<o.length;i++)"subflow"!=o[i].source.type?n.wires.push({id:o[i].source.id,port:o[i].sourcePort}):n.wires.push({id:a.id,port:0});s.out.push(n)}),0<s.in.length&&a.inputLabels&&!/^\s*$/.test(a.inputLabels.join(""))&&(s.inputLabels=a.inputLabels.slice()),0<s.out.length&&a.outputLabels&&!/^\s*$/.test(a.outputLabels.join(""))&&(s.outputLabels=a.outputLabels.slice()),a.icon&&"node-red/subflow.png"!==a.icon&&(s.icon=a.icon),s}function m(e,t,n){var o=[];n=n||{},t=t||{};for(var a=0;a<e.length;a++){var i=e[a];if("subflow:"==i.type.substring(0,8)){var s=i.type.substring(8);if(!t[s]){t[s]=!0;var r=[ne(s)];RED.nodes.eachNode(function(e){e.z==s&&r.push(e)}),o=m(r,t,n).concat(o)}}if("subflow"!=i.type){var d=RED.nodes.convertNode(i);for(var l in i._def.defaults)if(i._def.defaults[l].type&&i[l]in H){var c=H[i[l]],p=Y.getNodeType(i._def.defaults[l].type).exportable;null==p||p?i[l]in n||(n[i[l]]=!0,e.push(c)):d[l]=""}o.push(d)}else{var u=v(i);o.push(u)}}return o}function ae(s,r){var d,l=null;try{RED.nodes.eachSubflow(function(e){if(e.name==s.name&&e.info==s.info&&e.in.length==s.in.length&&e.out.length==s.out.length){var t=RED.nodes.filterNodes({z:e.id});if(t.length==r.length){var n=[s].concat(r),o=[e].concat(t),a=JSON.stringify(n),i=JSON.stringify(m(o));for(d=0;d<t.length;d++)a=a.replace(new RegExp('"'+r[d].id+'"',"g"),'"'+t[d].id+'"');if((a=a.replace(new RegExp('"'+s.id+'"',"g"),'"'+e.id+'"'))===i)throw l=e,new Error}}})}catch(e){console.log(e.stack)}return l}function ie(e,t,n){if(n&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var a in o.defaults)if(o.defaults.hasOwnProperty(a)){var i=e[a],s=t[a];if(typeof i!=typeof s)return!1;if(null===i||"string"==typeof i||"number"==typeof i){if(i!==s)return!1}else if(JSON.stringify(i)!==JSON.stringify(s))return!1}return!0}function l(e,t,n){var o,a,i,s={};if("string"==typeof e){if(""===e)return;try{i=JSON.parse(e)}catch(h){var r=new Error(RED._("clipboard.invalidFlow",{message:h.message}));throw r.code="NODE_RED",r}}else i=e;$.isArray(i)||(i=[i]);var d=!1;W||(d=!0,W=JSON.parse(JSON.stringify(i)));var l=[];for(o=0;o<i.length;o++)"workspace"==(a=i[o]).type||"tab"==a.type||"subflow"==a.type||Y.getNodeType(a.type)||"subflow:"==a.type.substring(0,8)||-1!=l.indexOf(a.type)||l.push(a.type),a.z&&(s[a.z]=s[a.z]||[],s[a.z].push(a));if(!d&&0<l.length){var c="<ul><li>"+l.join("</li><li>")+"</li></ul>";l.length;RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:l.length})+"</p>"+c,"error",!1,1e4)}var p=RED.workspaces.active(),u=ne(p);for(o=0;o<i.length;o++){var f=/^subflow:(.+)$/.exec(i[o].type);if(f){var h,g=f[1],v=ne(i[o].z||p);if(v)if(g===v.id&&(h=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),oe(g,v.id)&&(h=new Error(RED._("notification.errors.cannotAddCircularReference"))),h)throw h.code="NODE_RED",h}}var m,b,y,w,D=[],E={},R=[],x={},T={},k={},_=[],C=[],j=null;for(o=0;o<i.length;o++)if("workspace"===(a=i[o]).type||"tab"===a.type)"workspace"===a.type&&(a.type="tab"),null==V&&(V=a),t&&(m=Z(),E[a.id]=m,a.id=m),ee(a),RED.workspaces.add(a),D.push(a);else if("subflow"===a.type){var S=ae(a,s[a.id]);S?T[a.id]=S:(x[a.id]=a,t&&(m=Z(),a.id=m),a.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=a.id,e.i=t,e.id=Z()}),a.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=a.id,e.i=t,e.id=Z()}),R.push(a),te(a,t))}for(null==V&&(ee(V={type:"tab",id:Z(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(V),D.push(V),p=RED.workspaces.active()),o=0;o<i.length;o++)if(a=i[o],(b=Y.getNodeType(a.type))&&"config"==b.category){var O=null;if(t){if(a.z){if(T[a.z])continue;x[a.z]?a.z=x[a.z].id:(a.z=E[a.z],K[a.z]||(n?(null===j&&(j=RED.workspaces.add(null,!0),D.push(j)),a.z=j.id):a.z=p))}if((O=RED.nodes.node(a.id))&&a.z&&O.z!==a.z)for(var L in O=null,H)if(H.hasOwnProperty(L)&&H[L].z===a.z&&ie(H[L],a,!1)){O=H[L],k[a.id]=H[L];break}}if(!O||O._def.exclusive){for(w in y={id:a.id,z:a.z,type:a.type,users:[],_config:{}},b.defaults)b.defaults.hasOwnProperty(w)&&(y[w]=a[w],y._config[w]=JSON.stringify(a[w]));if(b.hasOwnProperty("credentials")&&a.hasOwnProperty("credentials"))for(w in y.credentials={},b.credentials)b.credentials.hasOwnProperty(w)&&a.credentials.hasOwnProperty(w)&&(y.credentials[w]=a.credentials[w]);y.label=b.label,y._def=b,t&&(y.id=Z()),k[a.id]=y,_.push(y),RED.nodes.add(y)}}for(o=0;o<i.length;o++)if("workspace"!==(a=i[o]).type&&"tab"!==a.type&&"subflow"!==a.type&&(!(b=Y.getNodeType(a.type))||"config"!=b.category)){var P={x:a.x,y:a.y,z:a.z,type:0,wires:a.wires,inputLabels:a.inputLabels,outputLabels:a.outputLabels,icon:a.icon,changed:!1,_config:{}};if(t){if(T[a.z])continue;x[P.z]?P.z=x[P.z].id:(P.z=E[P.z],K[P.z]||(n?(null===j&&(j=RED.workspaces.add(null,!0),D.push(j)),P.z=j.id):P.z=p)),P.id=Z()}else P.id=a.id,null!=P.z&&(K[P.z]||x[P.z])||(n?(null===j&&(j=RED.workspaces.add(null,!0),D.push(j)),P.z=j.id):P.z=p);if(P.type=a.type,P._def=b,"subflow"===a.type.substring(0,7)){var N=a.type.split(":")[1],I=T[N]||x[N]||ne(N);t&&(N=I.id,P.type="subflow:"+N,P._def=Y.getNodeType(P.type),delete P.i),P.name=a.name,P.outputs=I.out.length,P.inputs=I.in.length}else{if(!P._def){P.x&&P.y?P._def={color:"#fee",defaults:{},label:"unknown: "+a.type,labelStyle:"node_label_italic",outputs:a.outputs||a.wires.length,set:Y.getNodeSet("node-red/unknown")}:(P._def={category:"config",set:Y.getNodeSet("node-red/unknown")},P.users=[],delete P.x,delete P.y,delete P.wires,delete P.inputLabels,delete P.outputLabels);var A={};for(var z in a)a.hasOwnProperty(z)&&"x"!=z&&"y"!=z&&"z"!=z&&"id"!=z&&"wires"!=z&&(A[z]=a[z]);P._orig=A,P.name=a.type,P.type="unknown"}if("config"!=P._def.category){for(w in P.inputs=a.inputs||P._def.inputs,P.outputs=a.outputs||P._def.outputs,P.hasOwnProperty("wires")&&P.wires.length>P.outputs&&(P.wires=P.wires.slice(0,P.outputs),wireClippedNodes.push(P)),P._def.defaults)P._def.defaults.hasOwnProperty(w)&&(P[w]=a[w],P._config[w]=JSON.stringify(a[w]));if(P._config.x=P.x,P._config.y=P.y,P._def.hasOwnProperty("credentials")&&a.hasOwnProperty("credentials"))for(w in P.credentials={},P._def.credentials)P._def.credentials.hasOwnProperty(w)&&a.credentials.hasOwnProperty(w)&&(P.credentials[w]=a.credentials[w])}}X(P),RED.editor.validateNode(P),"unknown"!==(k[a.id]=P).type&&"config"===P._def.category||_.push(P)}var M={catch:"scope",status:"scope","link in":"links","link out":"links"};for(o=0;o<_.length;o++){if((a=_[o]).wires){for(var B=0;B<a.wires.length;B++)for(var J=a.wires[B]instanceof Array?a.wires[B]:[a.wires[B]],U=0;U<J.length;U++)if(k.hasOwnProperty(J[U]))if(a.z===k[J[U]].z){var G={source:a,sourcePort:B,target:k[J[U]]};Q(G),C.push(G)}else console.log("Warning: dropping link that crosses tabs:",a.id,"->",k[J[U]].id);delete a.wires}for(var F in a._def.defaults)if(a._def.defaults.hasOwnProperty(F))if(a._def.defaults[F].type&&k[a[F]])a[F]=k[a[F]].id,(y=RED.nodes.node(a[F]))&&-1===y.users.indexOf(a)&&y.users.push(a);else if(M.hasOwnProperty(a.type)&&M[a.type]===F&&void 0!==a[F]&&null!==a[F])for(var q=0;q<a[F].length;q++)k[a[F][q]]&&(a[F][q]=k[a[F][q]].id);u&&/^link /.test(a.type)&&a.links&&(a.links=a.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===p})),RED.editor.validateNode(a)}for(o=0;o<R.length;o++)(a=R[o]).in.forEach(function(n){n.wires.forEach(function(e){var t={source:n,sourcePort:0,target:k[e.id]};Q(t),C.push(t)}),delete n.wires}),a.out.forEach(function(n){n.wires.forEach(function(e){var t;Q(t=x[e.id]&&x[e.id].id==a.id?{source:a.in[e.port],sourcePort:e.port,target:n}:{source:k[e.id]||x[e.id],sourcePort:e.port,target:n}),C.push(t)}),delete n.wires});return RED.workspaces.refresh(),[_,C,D,R,j]}function a(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var n=e._def.defaults[t];if(n.type){var o=Y.getNodeType(n.type);if(o&&"config"==o.category){var a=H[e[t]];a&&-1===a.users.indexOf(e)&&a.users.push(e)}}}}return{init:function(){RED.events.on("registry:node-type-added",function(t){Y.getNodeType(t);var n=[];if(RED.nodes.eachNode(function(e){"unknown"===e.type&&e.name===t&&n.push(e)}),RED.nodes.eachConfig(function(e){"unknown"===e.type&&e.name===t&&n.push(e)}),0<n.length){var o=[];n.forEach(function(e){H.hasOwnProperty(e.id)?delete H[e.id]:p.splice(p.indexOf(e),1),o.push(d(e))}),RED.view.redraw(!0);var e=l(o,!1),a={};e[0].forEach(function(e){a[e.id]=e}),RED.nodes.eachLink(function(e){a.hasOwnProperty(e.source.id)&&(e.source=a[e.source.id]),a.hasOwnProperty(e.target.id)&&(e.target=a[e.target.id])}),RED.view.redraw(!0)}})},registry:Y,setNodeList:Y.setNodeList,getNodeSet:Y.getNodeSet,addNodeSet:Y.addNodeSet,removeNodeSet:Y.removeNodeSet,enableNodeSet:Y.enableNodeSet,disableNodeSet:Y.disableNodeSet,setIconSets:Y.setIconSets,getIconSets:Y.getIconSets,registerType:Y.registerNodeType,getType:Y.getNodeType,convertNode:d,add:X,remove:h,clear:function(){p=[],u=[],H={},s=[],Object.keys(r).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(K).forEach(function(e){RED.workspaces.remove(K[e])}),W=V=null,RED.nodes.dirty(!1),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh()},addLink:Q,removeLink:function(e){var t=u.indexOf(e);-1!=t&&u.splice(t,1)},addWorkspace:ee,removeWorkspace:function(e){delete K[e],s.splice(s.indexOf(e),1);var t,n,o=[],a=[];for(t=0;t<p.length;t++)(n=p[t]).z==e&&o.push(n);for(t in H)H.hasOwnProperty(t)&&(n=H[t]).z==e&&o.push(n);for(t=0;t<o.length;t++){var i=h(o[t].id);a=a.concat(i.links)}return{nodes:o,links:a}},getWorkspaceOrder:function(){return s},setWorkspaceOrder:function(e){s=e},workspace:function(e){return K[e]},addSubflow:te,removeSubflow:function(e){delete r[e.id],Y.removeNodeType("subflow:"+e.id)},subflow:ne,subflowContains:oe,eachNode:function(e){for(var t=0;t<p.length;t++)e(p[t])},eachLink:function(e){for(var t=0;t<u.length;t++)e(u[t])},eachConfig:function(e){for(var t in H)H.hasOwnProperty(t)&&e(H[t])},eachSubflow:function(e){for(var t in r)r.hasOwnProperty(t)&&e(r[t])},eachWorkspace:function(e){for(var t=0;t<s.length;t++)e(K[s[t]])},node:f,version:function(e){if(void 0===e)return t;t=e},originalFlow:function(e){if(void 0===e)return W;W=e},filterNodes:function(e){for(var t=[],n=0;n<p.length;n++){var o=p[n];e.hasOwnProperty("z")&&o.z!==e.z||e.hasOwnProperty("type")&&o.type!==e.type||t.push(o)}return t},filterLinks:function(e){for(var t=[],n=0;n<u.length;n++){var o=u[n];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||t.push(o)}return t},import:l,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var n=[e],o=[e];0!==o.length;)for(var a=o.shift(),i=u.filter(function(e){return e.source===a||e.target===a}),s=0;s<i.length;s++){var r=i[s].source===a?i[s].target:i[s].source,d=r.id;d||(d=r.direction+":"+r.i),t[d]||(t[d]=!0,n.push(r),o.push(r))}return n},createExportableNodeSet:m,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,n=[];for(t=0;t<s.length;t++)"tab"==K[s[t]].type&&n.push(g(K[s[t]]));for(t in r)r.hasOwnProperty(t)&&n.push(v(r[t]));for(t in H)H.hasOwnProperty(t)&&n.push(d(H[t],e));for(t=0;t<p.length;t++){var o=p[t];n.push(d(o,e))}return n},updateConfigNodeUsers:a,id:Z,dirty:function(e){if(null==e)return o;o=e,RED.events.emit("nodes:change",{dirty:o})}}}(),RED.history=function(){var t=[];return{markAllDirty:function(){for(var e=0;e<t.length;e++)t[e].dirty=!0},list:function(){return t},depth:function(){return t.length},push:function(e){t.push(e)},pop:function(){!function e(t){var n,o,a,i={};if(t){if("multi"==t.t)for(n=t.events.length-1;0<=n;n--)e(t.events[n]);else if("replace"==t.t)RED.nodes.clear(),RED.nodes.import(t.config)[0].forEach(function(e){t.changed[e.id]&&(e.changed=!0)}),RED.nodes.version(t.rev);else if("add"==t.t){if(t.nodes)for(n=0;n<t.nodes.length;n++)(o=RED.nodes.node(t.nodes[n])).z&&(i[o.z]=!0),RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.removeWorkspace(t.workspaces[n].id),RED.workspaces.remove(t.workspaces[n]);if(t.subflows)for(n=0;n<t.subflows.length;n++)RED.nodes.removeSubflow(t.subflows[n]),RED.workspaces.remove(t.subflows[n]);if(t.subflow&&(t.subflow.instances&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("changed")&&(a=RED.nodes.subflow(t.subflow.id))&&(a.changed=t.subflow.changed)),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("delete"==t.t){if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.addWorkspace(t.workspaces[n]),RED.workspaces.add(t.workspaces[n]);if(t.subflow&&t.subflow.subflow&&RED.nodes.addSubflow(t.subflow.subflow),t.subflowInputs&&0<t.subflowInputs.length&&((a=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),a.in[0].dirty=!0),t.subflowOutputs&&0<t.subflowOutputs.length)for(a=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),n=0;n<t.subflowOutputs.length;n++){var s=t.subflowOutputs[n];a.out.splice(s.i,0,s);for(var r=s.i+1;r<a.out.length;r++)a.out[r].i++,a.out[r].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+a.id&&e.sourcePort>=s.i&&e.sourcePort++})}if(t.subflow&&t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),a&&RED.nodes.filterNodes({type:"subflow:"+a.id}).forEach(function(e){for(e.inputs=a.in.length,e.outputs=a.out.length;e.outputs>e.ports.length;)e.ports.push(e.ports.length);e.resize=!0,e.dirty=!0}),t.nodes)for(n=0;n<t.nodes.length;n++)RED.nodes.add(t.nodes[n]),i[t.nodes[n].z]=!0;if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);if(t.changes)for(n in t.changes)if(t.changes.hasOwnProperty(n)&&(o=RED.nodes.node(n))){for(var d in t.changes[n])t.changes[n].hasOwnProperty(d)&&(o[d]=t.changes[n][d]);o.dirty=!0}}else if("move"==t.t){for(n=0;n<t.nodes.length;n++){var l=t.nodes[n];l.n.x=l.ox,l.n.y=l.oy,l.n.dirty=!0,l.n.moved=l.moved}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("edit"==t.t){for(n in t.changes)if(t.changes.hasOwnProperty(n)){if(t.node._def.defaults&&t.node._def.defaults[n]&&t.node._def.defaults[n].type){var c=RED.nodes.node(t.node[n]);c&&c.users.splice(c.users.indexOf(t.node),1);var p=RED.nodes.node(t.changes[n]);p&&p.users.push(t.node)}t.node[n]=t.changes[n]}if(t.subflow)t.subflow.hasOwnProperty("inputCount")&&(t.node.in.length>t.subflow.inputCount?t.node.in.splice(t.subflow.inputCount):0<t.subflow.inputs.length&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(t.node.out.length>t.subflow.outputCount?t.node.out.splice(t.subflow.outputCount):0<t.subflow.outputs.length&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),RED.editor.validateNode(t.node),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e),RED.editor.validateNode(e)});else{var u;if(t.outputMap)for(var f in u={},t.outputMap)t.outputMap.hasOwnProperty(f)&&"-1"!==t.outputMap[f]&&(u[t.outputMap[f]]=f);RED.editor.updateNodeProperties(t.node,u),RED.editor.validateNode(t.node)}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(t.nodes)for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).forEach(function(e){e.z=t.activeWorkspace,e.dirty=!0}),n=0;n<t.nodes.length;n++)RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else"reorder"==t.t&&t.order&&RED.workspaces.order(t.order);Object.keys(i).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(t.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}}(t.pop())},peek:function(){return t[t.length-1]},clear:function(){t=[]}}}(),RED.validators={number:function(t){return function(e){return t&&(""===e||void 0===e)||""!==e&&!isNaN(e)}},regex:function(t){return function(e){return t.test(e)}},typedInput:function(n,o){return function(e){var t=$("#node-"+(o?"config-":"")+"input-"+n).val()||this[n];if("json"===t)try{return JSON.parse(e),!0}catch(e){return!1}else{if("msg"===t||"flow"===t||"global"===t)return RED.utils.validatePropertyExpression(e);if("num"===t)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(e)}return!0}}},RED.utils=function(){function P(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function N(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function I(e){var t;if(Array.isArray(e))t=$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+e.length+"]");else if(null===e)t=$('<span class="debug-message-object-value debug-message-type-null">null</span>');else if("object"==typeof e)t=e.hasOwnProperty("type")&&"Buffer"===e.type&&e.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("buffer["+e.length+"]"):e.hasOwnProperty("type")&&"array"===e.type&&e.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+e.length+"]"):$('<span class="debug-message-object-value debug-message-type-meta">object</span>');else if("string"==typeof e){var n;n=30<e.length?N(e.substring(0,30))+"&hellip;":N(e),t=$('<span class="debug-message-object-value debug-message-type-string"></span>').html('"'+P(n)+'"')}else t=$('<span class="debug-message-object-value debug-message-type-other"></span>').text(""+e);return t}function A(n,o,a,e){n.addClass("debug-message-expandable"),n.prop("toggle",function(){return function(e){var t=n.parent();if(t.hasClass("collapsed")){if(e)return o&&!t.hasClass("built")&&(o(),t.addClass("built")),t.removeClass("collapsed"),!0}else if(!e)return t.addClass("collapsed"),!0;return!1}}),n.click(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&a&&a(!t),e.preventDefault()}),e&&n.click()}var z={},r={};function M(e,t,n,o){if(t&&0<t.length){if(""===e&&void 0===n)return!0;for(var a=0;a<t.length;a++){var i=t[a];if(0===i.indexOf(e)&&("."===i[e.length]||"["===i[e.length])){if(void 0===n||"["!==i[e.length])return!0;var s=i.substring(e.length),r=/\[(\d+)\]/.exec(s);if(r){var d=parseInt(r[1]);return n<=d&&d<=o}}}}return!1}function B(e,t,n,o,a,i){var s=r[n]&&r[n][o]&&r[n][o].number||i||"dec";a?(s="dec"===s?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===s||"dateS"==s?"hex":"dec",r[n]=r[n]||{},r[n][o]=r[n][o]||{},r[n][o].number=s):void 0!==i&&(r[n]=r[n]||{},r[n][o]=r[n][o]||{},r[n][o].number=s),"dec"===s?e.text(""+t):"dateMS"===s?e.text(new Date(t).toISOString()):"dateS"===s?e.text(new Date(1e3*t).toISOString()):"hex"===s&&e.text("0x"+t.toString(16))}function J(e,t,n,o,a){var i=r[n]&&r[n][o]&&r[n][o].buffer||"raw";a&&(i="raw"===i?"string":"raw",r[n]=r[n]||{},r[n][o]=r[n][o]||{},r[n][o].buffer=i),"raw"===i?(t.text("raw"),e.removeClass("debug-message-buffer-string").addClass("debug-message-buffer-raw")):"string"===i&&(t.text("string"),e.addClass("debug-message-buffer-string").removeClass("debug-message-buffer-raw"))}function U(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var n,o,a=[],i=0,s=!1,r=!1,d=0;d<t;d++){var l=e[d];if(s){if(l===n){if(d-i==0)throw new Error("Invalid property expression: zero-length string at position "+i);if(a.push(e.substring(i,d)),r&&!/\]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected array expression at position "+i);if(!r&&d+1!==t&&!/[\[\.]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" expression at position "+(d+1));i=d+1,s=!1}}else if("'"===l||'"'===l){if(d!=i)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);s=!0,n=l,i=d+1}else if("."===l){if(0===d)throw new Error("Invalid property expression: unexpected . at position 0");if(i!=d&&(o=e.substring(i,d),/^\d+$/.test(o)?a.push(parseInt(o)):a.push(o)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));i=d+1}else if("["===l){if(0===d)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(i!=d&&a.push(e.substring(i,d)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));i=d+1,r=!0}else if("]"===l){if(!r)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(i!=d){if(o=e.substring(i,d),!/^\d+$/.test(o))throw new Error("Invalid property expression: unexpected array expression at position "+i);a.push(parseInt(o))}i=d+1,r=!1}else if(" "===l)throw new Error("Invalid property expression: unexpected ' ' at position "+d)}if(r||s)throw new Error("Invalid property expression: unterminated expression");return i<t&&a.push(e.substring(i)),a}function G(e,t){var n,o=null;return"string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),n=U(t)):n=t,n.reduce(function(e,t){return void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(o=void 0!==e.data[t]?e.data[t]:void 0),o},e),o}function a(e){var t={module:"",file:""};if(e){var n=e.indexOf("/");-1!==n?(t.module=e.slice(0,n),t.file=e.slice(n+1)):t.file=e}return t}function o(t,e){var n;if(e&&"subflow"===e.type)n="node-red/subflow.png";else if("function"==typeof t.icon)try{n=t.icon.call(e)}catch(e){console.log("Definition error: "+t.type+".icon",e),n="arrow-in.png"}else n=t.icon;var o=a(n);return o.module||(t.set?o.module=t.set.module:o.module="node-red"),o}function i(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}return{createObjectElement:function r(n,e){var d,t,o,l,c,p,u=(e=e||{}).key,f=e.typeHint,a=e.hideKey,h=e.path,g=e.sourceId,v=e.rootPath,m=e.expandPaths,b=e.ontoggle,y=e.exposeApi,w={};void 0!==h&&void 0!==v&&(p=h.substring(v.length+("."===h[v.length]?1:0)));var D=$('<span class="debug-message-element"></span>');if(D.collapse=function(){D.find(".debug-message-expandable").parent().addClass("collapsed")},l=$('<span class="debug-message-row"></span>').appendTo(D),g&&function(n,o,t,a,e,i){z.hasOwnProperty(o)||(z[o]={});var s=$('<span class="debug-message-tools"></span>').appendTo(n),r=$('<span class="debug-message-tools-copy button-group"></span>').appendTo(s);if(t)var d=$('<button class="editor-button editor-button-small"><i class="fa fa-terminal"></i></button>').appendTo(r).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(t,d,"clipboard.copyMessagePath")});var l=$('<button class="editor-button editor-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(r).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(a,l,"clipboard.copyMessageValue")});if(""!==i){var c=z[o].hasOwnProperty(i);$('<button class="editor-button editor-button-small debug-message-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(s).click(function(e){if(e.preventDefault(),e.stopPropagation(),z[o].hasOwnProperty(i))delete z[o][i],$(this).removeClass("selected"),n.removeClass("debug-message-row-pinned");else{var t="$"+("["===i[0]?"":".")+i;z[o][i]=U(t),$(this).addClass("selected"),n.addClass("debug-message-row-pinned")}}).toggleClass("selected",c),n.toggleClass("debug-message-row-pinned",c)}}(l,g,h,n,0,p),u)a||($('<span class="debug-message-object-key"></span>').text(u).appendTo(l),$("<span>: </span>").appendTo(l));else if(D.addClass("debug-message-top-level"),g){var i=z[g];if(m=[],i){for(var s in i)if(i.hasOwnProperty(s))try{void 0!==G({$:n},i[s])&&m.push(s)}catch(e){}m.sort()}D.clearPinned=function(){D.find(".debug-message-row-pinned").removeClass("debug-message-row-pinned"),z[g]={}}}o=$('<span class="debug-message-object-value"></span>').appendTo(l);var E=Array.isArray(n),R=!1;if(n&&"object"==typeof n&&n.hasOwnProperty("type")&&n.hasOwnProperty("data")&&(n.__encoded__&&"array"===n.type||"Buffer"===n.type)&&(R=E=!0),null==n)$('<span class="debug-message-type-null">'+n+"</span>").appendTo(o);else if("string"==typeof n)/[\t\n\r]/.test(n)&&(D.addClass("collapsed"),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(l),A(l,function(){$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(f||"string").appendTo(l);var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(D);$('<pre class="debug-message-type-string"></pre>').text(n).appendTo(e)},function(e){b&&b(h,e)},M(p,m))),t=$('<span class="debug-message-type-string debug-message-object-header"></span>').html('"'+P(N(n))+'"').appendTo(o),/^#[0-9a-f]{6}$/i.test(n)&&$('<span class="debug-message-type-string-swatch"></span>').css("backgroundColor",n).appendTo(t);else if("number"==typeof n)t=$('<span class="debug-message-type-number"></span>').appendTo(o),Number.isInteger(n)&&0<=n&&(t.addClass("debug-message-type-number-toggle"),t.click(function(e){e.preventDefault(),B($(this),n,g,h,!0)})),B(t,n,g,h,!1,"hex"===f?"hex":void 0);else if(E){D.addClass("collapsed");var x=n.length;if(f){var T=/\[(\d+)\]/.exec(f);T&&(x=parseInt(T[1]))}var k=n,_="array";R?(k=n.data,void 0===x&&(x=k.length),k.__encoded__&&(k=k.data),_=n.type.toLowerCase()):/buffer/.test(f)&&(_="buffer");var C=k.length;if(0<x){$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(l);var j=$('<div class="debug-message-array-rows"></div>').appendTo(D);D.addClass("debug-message-buffer-raw")}if(u)c=$('<span class="debug-message-type-meta"></span>').html(f||_+"["+x+"]").appendTo(o);else{c=$('<span class="debug-message-object-header"></span>').appendTo(o),$("<span>[ </span>").appendTo(c);var S=Math.min(x,10);for(d=0;d<S;d++)I(k[d]).appendTo(c),d<S-1&&$("<span>, </span>").appendTo(c);S<x&&$("<span> &hellip;</span>").appendTo(c),0===S&&$('<span class="debug-message-type-meta">empty</span>').appendTo(c),$("<span> ]</span>").appendTo(c)}0<x&&A(l,function(){if(u||(c=$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(f||_+"["+x+"]").appendTo(l)),"buffer"===_){var e=$('<div class="debug-message-string-rows"></div>').appendTo(D),t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(e),n="";try{n=String.fromCharCode.apply(null,new Uint16Array(k))}catch(e){console.log(e)}$('<pre class="debug-message-type-string"></pre>').text(n).appendTo(t);var o=$('<span class="debug-message-buffer-opts"></span>').appendTo(c),a=$('<a href="#"></a>').addClass("selected").html("raw").appendTo(o).click(function(e){e.preventDefault(),e.stopPropagation(),J(D,$(this),g,h,!0)});J(D,a,g,h,!1)}var i;if(C<=10)for(d=0;d<C;d++)i=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(j),w[h+"["+d+"]"]=r(k[d],{key:""+d,typeHint:"buffer"===_&&"hex",hideKey:!1,path:h+"["+d+"]",sourceId:g,rootPath:v,expandPaths:m,ontoggle:b,exposeApi:y}).appendTo(i);else{for(d=0;d<C;d+=10){var s=d;i=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(j),l=$("<span></span>").appendTo(i),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').appendTo(l),A(l,function(){var n=s,o=Math.min(C-1,s+9),a=i;return function(){for(var e=n;e<=o;e++){var t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(a);w[h+"["+e+"]"]=r(k[e],{key:""+e,typeHint:"buffer"===_&&"hex",hideKey:!1,path:h+"["+e+"]",sourceId:g,rootPath:v,expandPaths:m,ontoggle:b,exposeApi:y}).appendTo(t)}}}(),function(){var t=t+"["+d+"]";return function(e){b&&b(t,e)}}(),M(p,m,s,Math.min(C-1,s+9))),$('<span class="debug-message-object-key"></span>').html("["+s+" &hellip; "+Math.min(C-1,s+9)+"]").appendTo(l)}C<x&&$('<div class="debug-message-object-entry collapsed"><span class="debug-message-object-key">['+C+" &hellip; "+x+"]</span></div>").appendTo(j)}},function(e){b&&b(h,e)},M(p,m))}else if("object"==typeof n){D.addClass("collapsed");var O=Object.keys(n);if((u||0<O.length)&&($('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(l),A(l,function(){for(u||$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html("object").appendTo(l),d=0;d<O.length;d++){var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(D),t=h;void 0!==t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(O[d])?t+=(0<t.length?".":"")+O[d]:t+='["'+O[d].replace(/"/,'\\"')+'"]'),w[t]=r(n[O[d]],{key:O[d],typeHint:!1,hideKey:!1,path:t,sourceId:g,rootPath:v,expandPaths:m,ontoggle:b,exposeApi:y}).appendTo(e)}0===O.length&&$('<div class="debug-message-object-entry debug-message-type-meta collapsed"></div>').text("empty").appendTo(D)},function(e){b&&b(h,e)},M(p,m))),u)$('<span class="debug-message-type-meta"></span>').html("object").appendTo(o);else{c=$('<span class="debug-message-object-header"></span>').appendTo(o),$("<span>{ </span>").appendTo(c);var L=Math.min(O.length,5);for(d=0;d<L;d++)$('<span class="debug-message-object-key"></span>').text(O[d]).appendTo(c),$("<span>: </span>").appendTo(c),I(n[O[d]]).appendTo(c),d<L-1&&$("<span>, </span>").appendTo(c);O.length>L&&$("<span> &hellip;</span>").appendTo(c),0===L&&$('<span class="debug-message-type-meta">empty</span>').appendTo(c),$("<span> }</span>").appendTo(c)}}else $('<span class="debug-message-type-other"></span>').text(""+n).appendTo(o);return y&&D.prop("expand",function(){return function(e,t){if(h===e)l.prop("toggle")&&l.prop("toggle")(t);else if(w[e]&&w[e].prop("expand"))w[e].prop("expand")(e,t);else for(var n in w)if(w.hasOwnProperty(n)&&0===e.indexOf(n)){w[n].prop("expand")&&w[n].prop("expand")(e,t);break}}}),D},getMessageProperty:G,normalisePropertyExpression:U,validatePropertyExpression:function(e){try{return U(e),!0}catch(e){return!1}},separateIconPath:a,getDefaultNodeIcon:o,getNodeIcon:function(e,t){if("config"===e.category)return"icons/node-red/cog.png";if(t&&"tab"===t.type)return"icons/node-red/subflow.png";if(t&&"unknown"===t.type)return"icons/node-red/alert.png";if(t&&t.icon&&i(n=a(t.icon)))return"icons/"+t.icon;var n=o(e,t);return"subflows"!==e.category||i(n)?"icons/"+n.module+"/"+n.file:"icons/node-red/subflow.png"},getNodeLabel:function(t,n){var o;if(n=n||"","tab"===t.type)o=t.label||n;else{o=t._def.label;try{o=("function"==typeof o?o.call(t):o)||n}catch(e){console.log("Definition error: "+t.type+".label",e),o=n}}return RED.text.bidi.enforceTextDirectionWithUCC(o)},addSpinnerOverlay:function(e,t){var n=$('<div class="projects-dialog-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&n.addClass("projects-dialog-spinner-contain"),n}}}(),function(r){r.widget("nodered.editableList",{_create:function(){var e,n=this;(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton)&&(e="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",r('<a href="#" class="editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+e+"</a>").appendTo(this.topContainer).click(function(e){e.preventDefault(),n.addItem({})}));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=n.element.css(e);"auto"!==t&&""!==t&&(n.topContainer.css(e,t),n.uiContainer.css(e,"0"),n.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var t=this.element.css("minHeight");"0px"!==t&&(this.uiContainer.css("minHeight",t),this.element.css("minHeight",0));var o=this.element.css("maxHeight");"0px"!==o&&(this.uiContainer.css("maxHeight",o),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var a,i=this.element.attr("style");if(null!==(a=/width\s*:\s*(\d+%)/i.exec(i))&&(this.element.width("100%"),this.uiContainer.width(a[1])),this.options.sortable){var s={axis:"y",update:function(e,t){n.options.sortItems&&n.options.sortItems(n.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(s.connectWith=this.options.connectWith),this.element.sortable(s)}this._resize()},_resize:function(){var e=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-e),this.options.resize&&this.options.resize(),this.options.resizeItem){var t=this;this.element.children().each(function(e){t.options.resizeItem(r(this).find(".red-ui-editableList-item-content"),e)})}},_destroy:function(){},_refreshFilter:function(){var o=this,a=0;return this.activeFilter?(this.items().each(function(e,t){var n=t.data("data");try{o.activeFilter(n)?(t.parent().show(),a++):t.parent().hide()}catch(e){console.log(e),t.parent().show(),a++}}),a):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var e=this.element.children(),n=this;e.sort(function(e,t){return n.activeSort(r(e).find(".red-ui-editableList-item-content").data("data"),r(t).find(".red-ui-editableList-item-content").data("data"))}),r.each(e,function(e,t){n.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},addItem:function(o){var a=this;o=o||{};var i=r("<li>"),s=!1;if(this.activeSort){this.items().each(function(e,t){if(!s){var n=t.data("data");a.activeSort(o,n)<0&&(i.insertBefore(t.closest("li")),s=!0)}})}s||i.appendTo(this.element);var n=r("<div/>").addClass("red-ui-editableList-item-content").appendTo(i);if(n.data("data",o),!0===this.options.sortable&&(r('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(i),i.addClass("red-ui-editableList-item-sortable")),this.options.removable){var e=r("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(i);r("<i/>",{class:"fa fa-remove"}).appendTo(e),i.addClass("red-ui-editableList-item-removable"),e.click(function(e){e.preventDefault();var t=n.data("data");i.addClass("red-ui-editableList-item-deleting"),i.fadeOut(300,function(){r(this).remove(),a.options.removeItem&&a.options.removeItem(t)})})}if(this.options.addItem){var t=a.element.children().length-1;setTimeout(function(){if(a.options.addItem(n,t,o),a.activeFilter)try{a.activeFilter(o)||i.hide()}catch(e){}!a.activeSort&&a.scrollOnAdd&&setTimeout(function(){a.uiContainer.scrollTop(a.element.height())},0)},0)}},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t){this.element.children().filter(function(e){return t===r(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(e){return r(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length}})}(jQuery),function(t){t.widget("nodered.checkboxSet",{_create:function(){var n=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var e=this.element.prop("checked");this.options=[t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],e?this.options[1].show():this.options[0].show(),this.element.change(function(){this.checked?(n.options[0].hide(),n.options[1].show()):(n.options[1].hide(),n.options[0].show()),n.options[2].hide();var t=this.checked;n.children.forEach(function(e){e.checkboxSet("state",t,!1,!0)})}),this.uiElement.click(function(e){e.stopPropagation(),n.state(!1===n.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);-1<t&&this.children.splice(t,1)},updateChild:function(e){var n=0;this.children.forEach(function(e,t){!0===e.checkboxSet("state")&&n++}),0===n?this.state(!1,!0):n===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,n){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var o=this.partialFlag||e;this.element.prop("checked",o),!0===e?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):!1===e?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===e&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),t||this.element.trigger("change",null),!n&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var d={};function l(a){var e,t;if(null!==a&&a.id&&!1===RED.settings.theme("menu."+a.id))return null;if(null===a)e=$('<li class="divider"></li>');else{e=$("<li></li>"),a.group&&e.addClass("menu-group-"+a.group);var n="<a "+(a.id?'id="'+a.id+'" ':"")+'tabindex="-1" href="#">';a.toggle&&(n+='<i class="fa fa-square pull-left"></i>',n+='<i class="fa fa-check-square pull-left"></i>'),void 0!==a.icon&&(/\.png/.test(a.icon)?n+='<img src="'+a.icon+'"/> ':n+='<i class="'+(a.icon?a.icon:'" style="display: inline-block;"')+'"></i> '),a.sublabel?n+='<span class="menu-label-container"><span class="menu-label">'+a.label+'</span><span class="menu-sublabel">'+a.sublabel+"</span></span>":n+='<span class="menu-label">'+a.label+"</span>",n+="</a>";var o=$(n).appendTo(e);if((d[a.id]=a).onselect?(o.click(function(e){if(e.preventDefault(),!$(this).parent().hasClass("disabled"))if(a.toggle){var t=p(a.id);if("string"==typeof a.toggle){if(!t){for(var n in d)if(d.hasOwnProperty(n)){var o=d[n];o.id!=a.id&&a.toggle==o.toggle&&u(o.id,!1)}u(a.id,!0)}}else u(a.id,!t)}else c(a.id)}),a.toggle&&(t=RED.settings.get("menu-"+a.id),a.setting&&(null!==t?(RED.settings.set(a.setting,t),RED.settings.remove("menu-"+a.id)):t=RED.settings.get(a.setting)),t?(o.addClass("active"),c(a.id,!0)):!1===t?(o.removeClass("active"),c(a.id,!1)):a.hasOwnProperty("selected")&&(a.selected?o.addClass("active"):o.removeClass("active"),c(a.id,a.selected)))):a.href?o.attr("target","_blank").attr("href",a.href):a.options||(e.addClass("disabled"),o.click(function(e){e.preventDefault()})),a.options){e.addClass("dropdown-submenu pull-left");for(var i=$('<ul id="'+a.id+'-submenu" class="dropdown-menu"></ul>').appendTo(e),s=0;s<a.options.length;s++){var r=l(a.options[s]);r&&r.appendTo(i)}}a.disabled&&e.addClass("disabled")}return e}function c(e,t){var n=d[e],o=n.onselect;"string"==typeof n.onselect&&(o=RED.actions.get(n.onselect)),o?o.call(n,t):console.log("No callback for",e,n.onselect)}function p(e){return $("#"+e).hasClass("active")}function u(e,t){if(p(e)!=t){var n=d[e];t?$("#"+e).addClass("active"):$("#"+e).removeClass("active"),n&&n.onselect&&c(n.id,t),RED.settings.set(n.setting||"menu-"+n.id,t)}}return{init:function(e){var t=$("#"+e.id),n=$("<ul/>",{id:e.id+"-submenu",class:"dropdown-menu pull-right"});1===t.length&&n.insertAfter(t);for(var o=!1,a=0;a<e.options.length;a++){var i=e.options[a];if(null!==i||!o){var s=l(i);s&&(s.appendTo(n),o=null===i)}}return n},setSelected:u,isSelected:p,toggleSelected:function(e){u(e,!p(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,t){var n=l(t);if(t.group){var o=$("#"+e+"-submenu").children(".menu-group-"+t.group);if(0===o.length)n.appendTo("#"+e+"-submenu");else{for(var a=0;a<o.length;a++){var i=o[a],s=$(i).find(".menu-label").html();if(t.label<s){$(i).before(n);break}}a===o.length&&n.appendTo("#"+e+"-submenu")}}else n.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(e,t){var n=d[e];n&&(n.onselect=t)}}}(),RED.panels={create:function(i){var s=i.container||$("#"+i.id),r=s.children();if(2!==r.length)throw new Error("Container must have exactly two children");s.addClass("red-ui-panels");var d,l,e=$('<div class="red-ui-panels-separator"></div>').insertAfter(r[0]),c=[],o=!1;return e.draggable({axis:"y",containment:s,scroll:!1,start:function(e,t){s.height(),d=t.position.top,c=[$(r[0]).height(),$(r[1]).height()]},drag:function(e,t){var n=s.height(),o=t.position.top-d,a=[c[0]+o,c[1]-o];$(r[0]).height(a[0]),$(r[1]).height(a[1]),i.resize&&i.resize(a[0],a[1]),t.position.top-=o,l=a[0]/n},stop:function(e,t){o=!0}}),{resize:function(e){var t=[$(r[0]).height(),$(r[1]).height()];if(s.height(e),o){var n=l*e;t=[n,e-n-48],$(r[0]).height(t[0]),$(r[1]).height(t[1])}i.resize&&i.resize(t[0],t[1])}}}},RED.popover=function(){var g={default:{top:10,leftRight:17,leftLeft:25},small:{top:5,leftRight:17,leftLeft:16}};return{create:function(e){var s=e.target,r=e.direction||"right",t=e.trigger,d=e.content,n=e.delay,o=e.autoClose,l=e.width||"auto",c=e.size||"default";if(!g[c])throw new Error("Invalid RED.popover size value:",c);var p,u,a=null,i=function(e){if(p){u=$('<div class="red-ui-popover red-ui-popover-'+r+'"></div>').appendTo("body"),"default"!==c&&u.addClass("red-ui-popover-size-"+c),"function"==typeof d?d.call(h).appendTo(u):u.html(d),"auto"!==l&&u.width(l);var t=s.offset(),n=s.width(),o=s.height(),a=u.height(),i=u.width();"right"===r?u.css({top:t.top+o/2-a/2-g[c].top,left:t.left+n+g[c].leftRight}):"left"===r&&u.css({top:t.top+o/2-a/2-g[c].top,left:t.left-g[c].leftLeft-i}),e?u.show():u.fadeIn("fast")}},f=function(e){p||u&&(e?$(this).remove():u.fadeOut("fast",function(){$(this).remove()}),u=null)};"hover"===t?(s.on("mouseenter",function(e){clearTimeout(a),p=!0,a=setTimeout(i,n.show)}),s.on("mouseleave",function(e){a&&clearTimeout(a),p=!1,setTimeout(f,n.hide)})):"click"===t?s.click(function(e){e.preventDefault(),e.stopPropagation(),(p=!p)?i():f()}):o&&setTimeout(function(){p=!1,f()},o);var h={setContent:function(e){return d=e,h},open:function(e){return p=!0,i(e),h},close:function(e){return p=!1,f(e),h}};return h}}}(),function(n){n.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),n('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=n('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.focus()}),this.resultCount=n("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(e){t._change(n(this).val())}),this.element.on("focus",function(){n("body").one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var n=!1;""===e?(this.clearButton.hide(),n=!0):(this.clearButton.show(),n=e.length>=(this.options.minimumLength||0));var o=this.element.val();if(n=n&&o!==this.lastSent)if(!t&&0<this.options.delay){clearTimeout(this.currentTimeout);var a=this;this.currentTimeout=setTimeout(function(){a.lastSent=a.element.val(),a._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs={create:function(d){var i,o,a,l={},s=0,c=d.element||$("#"+d.id),r=c.wrap("<div>").parent(),p=c.wrap("<div>").parent();function t(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var n=p.scrollLeft();p.animate({scrollLeft:t},100);var o=setInterval(function(){var e=p.scrollLeft();e!==n?(n=e,p.animate({scrollLeft:t},100)):clearInterval(o)},100);$(this).one("mouseup",function(){clearInterval(o)})}}function u(){return d.onclick&&d.onclick(l[$(this).attr("href").slice(1)]),g($(this)),!1}function f(){if(0!==c.children().length){var e=p.scrollLeft(),t=p.width(),n=c.width();0===e?o.hide():o.show(),e===n-t?a.hide():a.show()}}function h(){return d.ondblclick&&d.ondblclick(l[$(this).attr("href").slice(1)]),!1}function g(e){if("string"==typeof e&&(e=c.find("a[href='#"+e+"']")),0!==e.length&&!e.parent().hasClass("active")){if(c.children().removeClass("active"),c.children().css({transition:"width 100ms"}),e.parent().addClass("active"),d.scrollable){var t=e.parent().position().left;t-21<0?p.animate({scrollLeft:"+="+(t-50)},300):t+120>p.width()&&p.animate({scrollLeft:"+="+(t+140-p.width())},300)}d.onchange&&d.onchange(l[e.attr("href").slice(1)]),v(),setTimeout(function(){c.children().css({transition:""})},100)}}function v(){if(!d.vertical){var e=c.find("li.red-ui-tab"),t=r.width(),n=e.size(),o=(t-12-6*n)/n;if(s=(i=100*o/t+"%")+"%",d.scrollable){o=Math.max(o,140),i=o+"px",s=0;var a=Math.max(r.width(),12+(o+6)*n);c.width(a),f()}else d.hasOwnProperty("minimumActiveTabWidth")&&(o<d.minimumActiveTabWidth?(n-=1,o=(t-12-d.minimumActiveTabWidth-6*n)/n,i=100*o/t+"%",s=d.minimumActiveTabWidth+"px"):s=0);e.css({width:i}),o<50?(c.find(".red-ui-tab-close").hide(),c.find(".red-ui-tab-icon").hide(),c.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,o-38))+"px"})):(c.find(".red-ui-tab-close").show(),c.find(".red-ui-tab-icon").show(),c.find(".red-ui-tab-label").css({paddingLeft:""})),0!==s&&(c.find("li.red-ui-tab.active").css({width:d.minimumActiveTabWidth}),c.find("li.red-ui-tab.active .red-ui-tab-close").show(),c.find("li.red-ui-tab.active .red-ui-tab-icon").show(),c.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}function m(e){var t=c.find("a[href='#"+e+"']").parent();if(t.hasClass("active")){var n=t.prev();0===n.size()&&(n=t.next()),g(n.find("a"))}t.remove(),d.onremove&&d.onremove(l[e]),delete l[e],v()}return r.addClass("red-ui-tabs"),d.vertical&&r.addClass("red-ui-tabs-vertical"),d.addButton&&"function"==typeof d.addButton&&(r.addClass("red-ui-tabs-add"),$('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(r).find("a").click(function(e){e.preventDefault(),d.addButton()})),d.scrollable&&(r.addClass("red-ui-tabs-scrollable"),p.addClass("red-ui-tabs-scroll-container"),p.scroll(f),(o=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(r).find("a")).on("mousedown",function(e){t(e,"-=150")}).on("click",function(e){e.preventDefault()}),(a=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(r).find("a")).on("mousedown",function(e){t(e,"+=150")}).on("click",function(e){e.preventDefault()})),c.children().first().addClass("active"),c.children().addClass("red-ui-tab"),c.find("li.red-ui-tab a").on("click",u).on("dblclick",h),setTimeout(function(){v()},0),{addTab:function(t){l[t.id]=t;var n=$("<li/>",{class:"red-ui-tab"}).appendTo(c);n.attr("id","red-ui-tab-"+t.id.replace(".","-")),n.data("tabId",t.id);var e=$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(n);if(t.icon&&$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(e),$("<span/>",{class:"bidiAware"}).text(t.label).appendTo(e).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),e.on("click",u),e.on("dblclick",h),t.closeable){var o=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(n);o.append('<i class="fa fa-times" />'),o.on("click",function(e){e.preventDefault(),m(t.id)})}if(v(),d.onadd&&d.onadd(t),e.attr("title",t.label),1==c.find("li.red-ui-tab").size()&&g(e),d.onreorder){var a,i,s,r=[];n.draggable({axis:"x",distance:20,start:function(e,t){a=[],r=[],c.children().each(function(e){r[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(n)&&(s=i=e),a.push($(this).data("tabId"))}),c.children().each(function(e){e!==i&&$(this).css({position:"absolute",left:r[e].left+"px",width:r[e].width+2,transition:"left 0.3s"})}),n.hasClass("active")||n.css({zIndex:1})},drag:function(e,t){t.position.left+=r[i].left+p.scrollLeft();for(var n=t.position.left+r[i].width/2-p.scrollLeft(),o=0;o<r.length;o++)if(o!==i&&n>r[o].left&&n<r[o].left+r[o].width){o<i?(r[o].left+=r[i].width+8,r[i].el.detach().insertBefore(r[o].el)):(r[o].left-=r[i].width+8,r[i].el.detach().insertAfter(r[o].el)),r[o].el.css({left:r[o].left+"px"}),r.splice(o,0,r.splice(i,1)[0]),i=o;break}},stop:function(e,t){c.children().css({position:"relative",left:"",transition:""}),n.hasClass("active")||n.css({zIndex:""}),v(),s!==i&&d.onreorder(a,$.makeArray(c.children().map(function(){return $(this).data("tabId")}))),g(r[i].el.data("tabId"))}})}},removeTab:m,activateTab:g,nextTab:function(){var e=c.find("li.active").next();0<e.length&&g(e.find("a"))},previousTab:function(){var e=c.find("li.active").prev();0<e.length&&g(e.find("a"))},resize:v,count:function(){return c.find("li.red-ui-tab").size()},contains:function(e){return 0<c.find("a[href='#"+e+"']").length},renameTab:function(e,t){l[e].label=t;var n=c.find("a[href='#"+e+"']");n.attr("title",t),n.find("span.bidiAware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),v()},order:function(e){var t=$.makeArray(c.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var n,o=!0;for(n=0;n<e.length;n++)if(e[n]!==t[n]){o=!1;break}if(!o){var a={};for(c.children().detach().each(function(){a[$(this).data("tabId")]=$(this)}),n=0;n<e.length;n++)a[e[n]].appendTo(c)}}}}}},RED.stack={create:function(o){var a=o.container;a.addClass("red-ui-stack");var i=0,s=[],r=!0,d=function(){if(0<s.length){var t=0;s.forEach(function(e){t+=e.header.outerHeight()});var e=a.innerHeight();i=e-t-(s.length-1),s.forEach(function(e){e.contentWrap.height(i)})}};return o.fill&&o.singleExpanded&&($(window).resize(d),$(window).focus(d)),{add:function(t){s.push(t),t.container=$('<div class="palette-category">').appendTo(a),r||t.container.hide();var e=$('<div class="palette-header"></div>').appendTo(t.container);if(t.header=e,t.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(t.container),o.fill&&t.contentWrap.css("height",i),t.content=$("<div></div>").appendTo(t.contentWrap),!1!==t.collapsible){e.click(function(){if(o.singleExpanded){if(!t.isExpanded()){for(var e=0;e<s.length;e++)s[e].isExpanded()&&s[e].collapse();t.expand()}}else t.toggle()});var n=$('<i class="fa fa-angle-down"></i>').appendTo(e);t.expanded?(t.container.addClass("palette-category-expanded"),n.addClass("expanded")):t.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(e),e.css("cursor","default");return t.title=$("<span></span>").html(t.title).appendTo(e),t.toggle=function(){return t.isExpanded()?(t.collapse(),!1):(t.expand(),!0)},t.expand=function(){if(!t.isExpanded())return t.onexpand&&t.onexpand.call(t),o.singleExpanded&&s.forEach(function(e){e!==t&&e.collapse()}),n.addClass("expanded"),t.container.addClass("palette-category-expanded"),t.contentWrap.slideDown(200),!0},t.collapse=function(){if(t.isExpanded())return n.removeClass("expanded"),t.container.removeClass("palette-category-expanded"),t.contentWrap.slideUp(200),!0},t.isExpanded=function(){return t.container.hasClass("palette-category-expanded")},o.fill&&o.singleExpanded&&d(),t},hide:function(){return r=!1,s.forEach(function(e){e.container.hide()}),this},show:function(){return r=!0,s.forEach(function(e){e.container.show()}),this},resize:function(){d()}}}},function(d){var i={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",validate:RED.utils.validatePropertyExpression},global:{value:"global",label:"global.",validate:RED.utils.validatePropertyExpression},str:{value:"str",label:"string",icon:"red/images/typedInput/az.png"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.png",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var n=this,e=this.value();try{e=JSON.stringify(JSON.parse(e),null,4)}catch(e){}RED.editor.editJSON({value:e,complete:function(e){var t=e;try{t=JSON.stringify(JSON.parse(e))}catch(e){}n.value(t)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.png"},date:{value:"date",label:"timestamp",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.png",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var t=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(e){t.value(e.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.png",expand:function(){var t=this;RED.editor.editBuffer({value:this.value(),complete:function(e){t.value(e)}})}}},s=!1;d.widget("nodered.typedInput",{_create:function(){if(!s&&RED&&RED._)for(var e in i)i.hasOwnProperty(e)&&(i[e].label=RED._("typedInput.type."+e,{defaultValue:i[e].label}));s=!0;var n=this;this.disarmClick=!1,this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.element.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var t,o=this.element.attr("style");if(null!==(t=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(o))?(this.element.css("width","100%"),this.uiSelect.width(t[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=n.element.css("margin"+e);n.uiSelect.css("margin"+e,t),n.element.css("margin"+e,0)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.options.types=this.options.types||Object.keys(i),this.selectTrigger=d('<button tabindex="0"></button>').prependTo(this.uiSelect),1<this.options.types.length&&d('<i class="fa fa-sort-desc"></i>').appendTo(this.selectTrigger),this.selectLabel=d("<span></span>").appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=d(this.options.typeField).hide();var a=this.typeField.val();a&&this.typeMap[a]&&(this.options.default=a)}else this.typeField=d("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.element.on("focus",function(){n.uiSelect.addClass("red-ui-typedInput-focus")}),this.element.on("blur",function(){n.uiSelect.removeClass("red-ui-typedInput-focus")}),this.element.on("change",function(){n.validate()}),this.selectTrigger.click(function(e){e.preventDefault(),n._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&n._showTypeMenu()}).on("focus",function(){n.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=d('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="fa fa-sort-desc"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=d('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),this.optionSelectTrigger.click(function(e){e.preventDefault(),n._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&n._showOptionSelectMenu()}).on("blur",function(){n.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){n.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=d('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"><i class="fa fa-ellipsis-h"></i></button>').appendTo(this.uiSelect),this.type(this.options.default||this.typeList[0].value)},_showTypeMenu:function(){1<this.typeList.length?(this._showMenu(this.menu,this.selectTrigger),this.menu.find("[value='"+this.propertyType+"']").focus()):this.element.focus()},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectLabel);var e=this.optionMenu.find("[value='"+this.value()+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.focus()}},_hideMenu:function(e){d(document).off("mousedown.close-property-select"),e.hide(),this.elementDiv.is(":visible")?this.element.focus():this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.focus():this.selectTrigger.focus()},_createMenu:function(e,n){var o=this,a=d("<div>").addClass("red-ui-typedInput-options");return e.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var e=d('<a href="#"></a>').attr("value",t.value).appendTo(a);t.label&&e.text(t.label),t.icon?d("<img>",{src:t.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(e):e.css({paddingLeft:"18px"}),e.click(function(e){e.preventDefault(),n(t.value),o._hideMenu(a)})}),a.css({display:"none"}),a.appendTo(document.body),a.on("keydown",function(e){40===e.keyCode?d(this).children(":focus").next().focus():38===e.keyCode?d(this).children(":focus").prev().focus():27===e.keyCode&&o._hideMenu(a)}),a},_showMenu:function(t,n){if(this.disarmClick)this.disarmClick=!1;else{var o=this,e=n.offset(),a=n.height(),i=t.height(),s=a+e.top-3;s+i>d(window).height()&&(s-=s+i-d(window).height()+5),t.css({top:s+"px",left:2+e.left+"px"}),t.slideDown(100),this._delay(function(){o.uiSelect.addClass("red-ui-typedInput-focus"),d(document).on("mousedown.close-property-select",function(e){d(e.target).closest(t).length||o._hideMenu(t),d(e.target).closest(n).length&&(o.disarmClick=!0,e.preventDefault())})})}},_getLabelWidth:function(e){var t=e.outerWidth();if(0===t){var n=d('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body);t=e.clone().appendTo(n).outerWidth(),n.remove()}return t},_resize:function(){if(null!==this.uiWidth&&this.uiSelect.width(this.uiWidth),this.typeMap[this.propertyType]&&!1===this.typeMap[this.propertyType].hasValue)this.selectTrigger.addClass("red-ui-typedInput-full-width");else{this.selectTrigger.removeClass("red-ui-typedInput-full-width");var e=this._getLabelWidth(this.selectTrigger);this.elementDiv.css("left",e+"px"),this.optionExpandButton.is(":visible")?this.elementDiv.css("right","22px"):this.elementDiv.css("right","0"),this.optionSelectTrigger&&this.optionSelectTrigger.css({left:e+"px",width:"calc( 100% - "+e+"px )"})}},_destroy:function(){this.menu.remove()},types:function(e){var n=this,t=this.type();this.typeMap={},this.typeList=e.map(function(e){var t;return t="string"==typeof e?i[e]:e,n.typeMap[t.value]=t}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(e){n.type(e)}),t&&!this.typeMap.hasOwnProperty(t)&&this.type(this.typeList[0].value)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){if(!arguments.length)return this.element.val();if(this.typeMap[this.propertyType].options){for(var t,n=!1,o=0;o<this.typeMap[this.propertyType].options.length;o++){var a=this.typeMap[this.propertyType].options[o];if("string"==typeof a){if(a===e){t=e,n=!0;break}}else if(a.value===e){t=a.label||a.value,n=!0;break}}n||(t=e=""),this.optionSelectLabel.text(t)}this.element.val(e),this.element.trigger("change",this.type(),e)},type:function(e){if(!arguments.length)return this.propertyType;var t=this,n=this.typeMap[e];if(n&&this.propertyType!==e){var o;if(this.propertyType=e,this.typeField.val(e),this.selectLabel.empty(),n.icon?((o=new Image).name=n.icon,o.src=n.icon,d("<img>",{src:n.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):this.selectLabel.text(n.label),n.options){if(this.optionExpandButton&&this.optionExpandButton.hide(),this.optionSelectTrigger){this.optionSelectTrigger.show(),this.elementDiv.hide(),this.optionMenu=this._createMenu(n.options,function(e){t.optionSelectLabel.text(e),t.value(e)});for(var a,i=this.element.val(),s=!1,r=0;r<n.options.length;r++)if("string"==typeof(a=n.options[r])){if(a===i){this.optionSelectLabel.text(i),s=!0;break}}else if(a.value===i){this.optionSelectLabel.text(a.label||a.value),s=!0;break}s||("string"==typeof(a=n.options[0])?this.value(a):this.value(a.value)),console.log(s)}}else this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===n.hasValue?(this.oldValue=this.element.val(),this.element.val(""),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.element.val(this.oldValue),delete this.oldValue),this.elementDiv.show()),n.expand&&"function"==typeof n.expand?(this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){e.preventDefault(),n.expand.call(t)})):this.optionExpandButton.hide(),this.element.trigger("change",this.propertyType,this.value());o?(o.onload=function(){t._resize()},o.onerror=function(){t._resize()}):this._resize()}},validate:function(){var e,t=this.value(),n=this.type();if(this.typeMap[n]&&this.typeMap[n].validate){var o=this.typeMap[n].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.actions=function(){var o={};return{add:function(e,t){o[e]=t},remove:function(e){delete o[e]},get:function(e){return o[e]},invoke:function(e){o.hasOwnProperty(e)&&o[e]()},list:function(){var n=[];return Object.keys(o).forEach(function(e){var t=RED.keyboard.getShortcut(e);n.push({id:e,scope:t?t.scope:void 0,key:t?t.key:void 0,user:t?t.user:void 0})}),n}}}(),RED.deploy=function(){var t={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},g={unknown:!1,unusedConfig:!1,invalid:!1},v="full",m=!1,l=null;function i(e){v=e,$("#btn-deploy-icon").attr("src",t[e].img)}function b(e){var t="";if(e.z){var n=RED.nodes.workspace(e.z);t=n?n.label:(n=RED.nodes.subflow(e.z)).name}var o=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:o}}function y(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function w(e,t){var n=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(n);var o=$('<div id="node-dialog-confirm-deploy-conflict-checking" class="node-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(n),a=$('<div class="node-dialog-confirm-conflict-row"><i style="color: #3a3;" class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(n),i=$('<div id="node-dialog-confirm-deploy-conflict-manual-merge" class="node-dialog-confirm-conflict-row"><i style="color: #999;" class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(n);n.i18n(),l=null;var s=[{text:RED._("common.label.cancel"),click:function(){r.close()}},{id:"node-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),r.close())}},{id:"node-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(l),r.close())}}];t&&s.push({id:"node-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){E(!0,t),r.close()}});var r=RED.notify(n,{modal:!0,fixed:!0,width:600,buttons:s}),d=Date.now();RED.diff.getRemoteDiff(function(e){var t=Math.max(1e3-(Date.now()-d),0);l=e,setTimeout(function(){o.hide(),0===Object.keys(e.conflicts).length?(a.show(),$("#node-dialog-confirm-deploy-merge").removeClass("disabled")):i.show(),$("#node-dialog-confirm-deploy-review").removeClass("disabled")},t)})}function D(e){if(5<e.length){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function E(e,t){if(!$("#btn-deploy").hasClass("disabled")){if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");if(!e){var n,o=!1,a=!1,i=[],s=[];RED.nodes.eachNode(function(e){o=o||!e.valid,e.valid||s.push(b(e)),"unknown"===e.type&&-1==i.indexOf(e.name)&&i.push(e.name)}),n=0<i.length;var r=[];RED.nodes.eachConfig(function(e){0===e.users.length&&!1!==e._def.hasUsers&&(r.push(b(e)),a=!0)});var d,l,c=!1,p=[];if(n&&!g.unknown?(c=!0,d="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+D(i).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",p=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){E(!0),l.close()}}]):o&&!g.invalid&&(c=!0,s.sort(y),d="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+D(s.map(function(e){return(e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")"})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",p=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){E(!0),l.close()}}]),c)return p.unshift({text:RED._("common.label.cancel"),click:function(){l.close()}}),void(l=RED.notify(d,{modal:!0,fixed:!0,buttons:p}))}var u=RED.nodes.createCompleteNodeSet(),f=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var h={flows:u};t||(h.rev=RED.nodes.version()),m=!0,$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":v}}).done(function(e,t,n){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(u),a?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachSubflow(function(e){e.changed=!1}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,n){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?w(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){m=!1;var e=Math.max(0,300-(Date.now()-f));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide(),$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide()},e)})}}return{init:function(e){var a,t=(e=e||{}).type||"default";if("default"==t)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&i("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&i("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&i("nodes")}}]});else if("simple"==t){var n=e.label||RED._("deploy.deploy"),o="red/images/deploy-full-o.png";e.hasOwnProperty("icon")&&(o=e.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(o?'<img id="btn-deploy-icon" src="'+o+'"> ':"")+"<span>"+n+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(e){e.preventDefault(),E()}),RED.actions.add("core:deploy-flows",E),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))}),RED.comms.subscribe("notification/runtime-deploy",function(e,t){if(!a){var n=RED.nodes.version();if(null===n||m||n===t.revision)return;var o=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));a=RED.notify(o,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){a.close(),a=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){a.close(),w(RED.nodes.createCompleteNodeSet(),!1),a=null}}]})}})},setDeployInflight:function(e){m=e}}}(),RED.diff=function(){var c=!1;function R(e,t,n){var o=$('<div class="node-dialog-view-diff-panel"></div>').appendTo(e),a=$('<div class="node-dialog-view-diff-headers"></div>').appendTo(o);"merge"===n.mode&&o.addClass("node-dialog-view-diff-panel-merge");var i,O,s,r=(i=o,O=t,(s=$('<ol class="node-dialog-view-diff-diff"></ol>').appendTo(i)).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,t,n){var o=n.diff,a=n.remoteDiff,i=n.tab.n,s=n.def,r=O.conflicts,d=$("<div>",{class:"node-diff-tab"}).appendTo(e);d.addClass("collapsed");var l,c,p=$("<div>",{class:"node-diff-tab-title"}).appendTo(d),u=$("<div>").appendTo(d),f=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(p),h=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(p);a&&(l=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(p)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(f),L(i,s).appendTo(f);var g=(n.newTab||n.tab).n,v=$("<span>",{class:"node-diff-tab-title-meta"}).appendTo(f);"tab"===g.type?v.html(g.label||g.id):"subflow"===i.type?v.html(g.name||g.id):v.html(RED._("diff.globalNodes"));var m={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(n.newTab||n.remoteTab){var b,y={node:o.newConfig.all[i.id],all:o.newConfig.all,diff:o};if(a&&(b={node:a.newConfig.all[i.id]||null,all:a.newConfig.all,diff:a}),void 0!==i.type){var w,D=$("<div>",{class:"node-diff-node-entry node-diff-node-props collapsed"}).appendTo(u),E=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(D),R=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(E),x=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(E);o.newConfig.all[i.id]?o.added[i.id]?(x.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(x)):o.changed[i.id]?(x.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(x)):(x.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(x)):x.addClass("node-diff-empty"),a&&(w=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(E),a.newConfig.all[i.id]?a.added[i.id]?(w.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(w)):a.changed[i.id]?(w.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(w)):(w.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(w)):(w.addClass("node-diff-empty"),a.deleted[i.id])),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(R),$("<span>").html(RED._("diff.flowProperties")).appendTo(R),E.click(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),N(s,i,y,b).appendTo(D),c="",r[i.id]?(m.conflicts++,x.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(x),w.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(w),D.addClass("node-diff-node-entry-conflict")):c=O.resolutions[i.id],I(i,D,x,w,!0,!r[i.id],c,O)}}var T=0,k=0,_={};if(n.tab.nodes.forEach(function(e){_[e.id]=!0,P(e,m,O).appendTo(u)}),n.newTab&&(T=n.newTab.nodes.length,n.newTab.nodes.forEach(function(e){_[e.id]||(_[e.id]=!0,P(e,m,O).appendTo(u))})),n.remoteTab&&(k=n.remoteTab.nodes.length,n.remoteTab.nodes.forEach(function(e){_[e.id]||P(e,m,O).appendTo(u)})),p.click(function(e){p.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".node-diff-node-entry").addClass("collapsed"),$(this).parent().find(".debug-message-element").addClass("collapsed"))}),o.deleted[i.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(n.newTab)if(o.added[i.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{i.id&&(o.changed[i.id]?m.local.changedCount++:m.local.unchangedCount++);var C=$("<span>",{class:"node-diff-tab-stats"}).appendTo(h);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:T})).appendTo(C),0<m.conflicts+m.local.addedCount+m.local.changedCount+m.local.deletedCount&&($('<span class="node-diff-status"> [ </span>').appendTo(C),0<m.conflicts&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+m.conflicts+"</span></span>").appendTo(C),0<m.local.addedCount&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+m.local.addedCount+"</span></span>").appendTo(C),0<m.local.changedCount&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+m.local.changedCount+"</span></span>").appendTo(C),0<m.local.deletedCount&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+m.local.deletedCount+"</span></span>").appendTo(C),$('<span class="node-diff-status"> ] </span>').appendTo(C))}else h.addClass("node-diff-empty");if(a){if(a.deleted[i.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(l);else if(n.remoteTab)if(a.added[i.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(l);else{i.id&&(a.changed[i.id]?m.remote.changedCount++:m.remote.unchangedCount++);var j=$("<span>",{class:"node-diff-tab-stats"}).appendTo(l);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:k})).appendTo(j),0<m.conflicts+m.remote.addedCount+m.remote.changedCount+m.remote.deletedCount&&($('<span class="node-diff-status"> [ </span>').appendTo(j),0<m.conflicts&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+m.conflicts+"</span></span>").appendTo(j),0<m.remote.addedCount&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+m.remote.addedCount+"</span></span>").appendTo(j),0<m.remote.changedCount&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+m.remote.changedCount+"</span></span>").appendTo(j),0<m.remote.deletedCount&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+m.remote.deletedCount+"</span></span>").appendTo(j),$('<span class="node-diff-status"> ] </span>').appendTo(j))}else l.addClass("node-diff-empty");if(c="",0<m.conflicts?p.addClass("node-diff-node-entry-conflict"):c=O.resolutions[i.id],i.id){var S=!(0<m.conflicts&&(o.deleted[i.id]||a.deleted[i.id]));I(i,p,h,l,!1,S,c,O)}}0===d.find(".node-diff-node-entry").length&&d.addClass("node-diff-tab-empty"),e.i18n()}}),s),d=t.localDiff,l=t.remoteDiff,c=(t.conflicts,d.currentConfig),p=d.newConfig;if(void 0!==l){o.addClass("node-diff-three-way");var u=n.oldRevTitle||RED._("diff.local"),f=n.newRevTitle||RED._("diff.remote");$("<div></div>").text(u).appendTo(a),$("<div></div>").text(f).appendTo(a)}else o.removeClass("node-diff-three-way");return{list:r,finish:function(){var e={diff:d,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:c.globals},newTab:{n:{},nodes:p.globals}};void 0!==l&&(e.remoteTab={n:{},nodes:l.newConfig.globals},e.remoteDiff=l),r.editableList("addItem",e);var t,o={};for(t in c.tabOrder.forEach(function(e){var t=c.tabs[e],n={diff:d,def:RED.nodes.getType("tab"),tab:t};p.tabs.hasOwnProperty(e)&&(n.newTab=p.tabs[e]),void 0!==l&&(n.remoteTab=l.newConfig.tabs[e],n.remoteDiff=l),o[e]=!0,r.editableList("addItem",n)}),p.tabOrder.forEach(function(e){if(!o[e]){o[e]=!0;var t=p.tabs[e],n={diff:d,def:RED.nodes.getType("tab"),tab:t,newTab:t};void 0!==l&&(n.remoteDiff=l),r.editableList("addItem",n)}}),void 0!==l&&l.newConfig.tabOrder.forEach(function(e){if(!o[e]){var t=l.newConfig.tabs[e],n={diff:d,remoteDiff:l,def:RED.nodes.getType("tab"),tab:t,remoteTab:t};r.editableList("addItem",n)}}),c.subflows)c.subflows.hasOwnProperty(t)&&(o[t]=!0,e={diff:d,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:c.subflows[t]},p.subflows.hasOwnProperty(t)&&(e.newTab=p.subflows[t]),void 0!==l&&(e.remoteTab=l.newConfig.subflows[t],e.remoteDiff=l),r.editableList("addItem",e));for(t in p.subflows)p.subflows.hasOwnProperty(t)&&!o[t]&&(o[t]=!0,e={diff:d,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:p.subflows[t],newTab:p.subflows[t]},void 0!==l&&(e.remoteDiff=l),r.editableList("addItem",e));if(void 0!==l)for(t in l.newConfig.subflows)l.newConfig.subflows.hasOwnProperty(t)&&!o[t]&&(e={diff:d,remoteDiff:l,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:l.newConfig.subflows[t],remoteTab:l.newConfig.subflows[t]},r.editableList("addItem",e))}}}function E(e,a){var t=$("<div>",{class:"node-diff-property-wires"}),i=$("<ol></ol>"),s=0;return e.forEach(function(e,t){var n=$("<li>").appendTo(i);if(e&&0<e.length){$("<span>").html(t+1).appendTo(n);var o=$("<ul>").appendTo(n);e.forEach(function(e){s++;var t=$("<li>").appendTo(o),n=a[e];n?w(n,RED.nodes.getType(n.type)||{}).appendTo(t):t.html(e)})}else n.html("none")}),0===s?t.html("none"):i.appendTo(t),t}function L(e,t){var n=$("<div>",{class:"node-diff-node-entry-node"}),o=t.color,a=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(o="#C0DEED"),n.css("backgroundColor",o);var i=$("<div/>",{class:"palette_icon_container"}).appendTo(n);return $("<div/>",{class:"palette_icon",style:"background-image: url("+a+")"}).appendTo(i),n}function w(e,t){var n=$("<div>",{class:"node-diff-node-entry-title"});L(e,t).appendTo(n);var o=$("<div>",{class:"node-diff-node-description"}).appendTo(n),a=e.label||e.name||e.id;return $("<span>",{class:"node-diff-node-label"}).html(a).appendTo(o),n}function P(e,t,n){var o=n.localDiff,a=n.remoteDiff,i=n.conflicts[e.id],s=!0;o.added[e.id]&&(t.local.addedCount++,s=!1),a&&a.added[e.id]&&(t.remote.addedCount++,s=!1),o.deleted[e.id]&&(t.local.deletedCount++,s=!1),a&&a.deleted[e.id]&&(t.remote.deletedCount++,s=!1),o.changed[e.id]&&(t.local.changedCount++,s=!!0),a&&a.changed[e.id]&&(t.remote.changedCount++,s=!!0);var r=RED.nodes.getType(e.type);void 0===r&&(r=/^subflow:/.test(e.type)?{icon:"subflow.png",category:"subflows",color:"#da9",defaults:{name:{value:""}}}:{});var d,l=$("<div>",{class:"node-diff-node-entry collapsed"}),c=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(l),p=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(c),u=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(c);if(a&&(d=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(c)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(p),s)t.local.unchangedCount++,w(e,r).appendTo(p),u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u),a&&(t.remote.unchangedCount++,d.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(d)),l.addClass("node-diff-node-unchanged");else if(o.added[e.id])u.addClass("node-diff-node-added"),d&&d.addClass("node-diff-empty"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(u),w(e,r).appendTo(p);else if(a&&a.added[e.id])u.addClass("node-diff-empty"),d.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(d),w(e,r).appendTo(p);else{if(w(e,r).appendTo(p),o.moved[e.id]){var f=o.newConfig.all[e.id];if(o.deleted[e.z]||e.z===f.z||""===e.z||o.newConfig.all[e.z]){u.addClass("node-diff-node-moved");var h="";h=e.z===f.z?RED._("diff.type.movedFrom",{id:o.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:f.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+h+"</span>").appendTo(u)}else u.addClass("node-diff-empty");!0}else o.deleted[e.z]?(u.addClass("node-diff-empty"),!0):o.deleted[e.id]?(u.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(u),!0):o.changed[e.id]?o.newConfig.all[e.id].z!==e.z?u.addClass("node-diff-empty"):(u.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(u),!0):o.newConfig.all[e.id].z!==e.z?u.addClass("node-diff-empty"):(t.local.unchangedCount++,u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u));if(a)if(a.moved[e.id]){var g=a.newConfig.all[e.id];if(a.deleted[e.z]||e.z===g.z||""===e.z||a.newConfig.all[e.z]){d.addClass("node-diff-node-moved");var v="";v=e.z===g.z?RED._("diff.type.movedFrom",{id:a.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:g.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+v+"</span>").appendTo(d)}else d.addClass("node-diff-empty")}else a.deleted[e.z]?d.addClass("node-diff-empty"):a.deleted[e.id]?(d.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(d)):a.changed[e.id]?a.newConfig.all[e.id].z!==e.z?d.addClass("node-diff-empty"):(d.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(d)):a.newConfig.all[e.id].z!==e.z?d.addClass("node-diff-empty"):(t.remote.unchangedCount++,d.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(d))}var m,b={node:o.newConfig.all[e.id],all:o.newConfig.all,diff:o};a&&(m={node:a.newConfig.all[e.id]||null,all:a.newConfig.all,diff:a}),N(r,e,b,m).appendTo(l);var y="";return i?(t.conflicts++,u.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(u),d.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(d),l.addClass("node-diff-node-entry-conflict")):y=n.resolutions[e.id],I(e,l,u,d,!1,!i,y,n),c.click(function(e){$(this).parent().toggleClass("collapsed")}),l}function N(t,o,a,i){var s,r={},d=a.node;i&&(s=i.node);var e=$("<div>",{class:"node-diff-node-entry-properties"}),n=$("<table>").appendTo(e),l=$("<colgroup><col/><col/></colgroup>").appendTo(n);void 0!==s&&$("<col/>").appendTo(l);var c,p,u,f,h,g,v,m=$("<tbody>").appendTo(n),b=!1,y=!1,w=!1;c=$("<tr>").appendTo(m),$("<td>",{class:"node-diff-property-cell-label"}).html("id").appendTo(c),p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),d?(p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"></span>').appendTo(p),f=$('<span class="node-diff-element"></span>').appendTo(p),r["local.id"]=RED.utils.createObjectElement(d.id).appendTo(f)):p.addClass("node-diff-empty"),void 0!==s&&((u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c)).addClass("node-diff-node-unchanged"),s?($('<span class="node-diff-status"></span>').appendTo(u),f=$('<span class="node-diff-element"></span>').appendTo(u),r["remote.id"]=RED.utils.createObjectElement(s.id).appendTo(f)):u.addClass("node-diff-empty")),o.hasOwnProperty("x")&&(d&&(d.x===o.x&&d.y===o.y||(b=!0,0)),s&&(s.x===o.x&&s.y===o.y||(y=!0,0)),(y&&b&&(d.x!==s.x||d.y!==s.y)||!b&&y&&a.diff.deleted[o.id]||b&&!y&&i.diff.deleted[o.id])&&(w=!0),c=$("<tr>").appendTo(m),$("<td>",{class:"node-diff-property-cell-label"}).html("position").appendTo(c),p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),d?(p.addClass("node-diff-node-"+(b?"changed":"unchanged")),$('<span class="node-diff-status">'+(b?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p),f=$('<span class="node-diff-element"></span>').appendTo(p),r["local.position"]=RED.utils.createObjectElement({x:d.x,y:d.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){r["remote."+e]&&r["remote."+e].prop("expand")(e,t)}}).appendTo(f)):p.addClass("node-diff-empty"),void 0!==s&&((u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c)).addClass("node-diff-node-"+(y?"changed":"unchanged")),s?($('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),f=$('<span class="node-diff-element"></span>').appendTo(u),r["remote.position"]=RED.utils.createObjectElement({x:s.x,y:s.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){r["local."+e]&&r["local."+e].prop("expand")(e,t)}}).appendTo(f)):u.addClass("node-diff-empty"))),b=y=w=!1,o.hasOwnProperty("wires")&&(h=JSON.stringify(o.wires),d&&(g=JSON.stringify(d.wires),h!==g&&(b=!0,0)),s&&(v=JSON.stringify(s.wires),h!==v&&(y=!0,0)),(y&&b&&g!==v||!b&&y&&a.diff.deleted[o.id]||b&&!y&&i.diff.deleted[o.id])&&(w=!0),c=$("<tr>").appendTo(m),$("<td>",{class:"node-diff-property-cell-label"}).html("wires").appendTo(c),p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),d?(w?(p.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("node-diff-node-"+(b?"changed":"unchanged")),$('<span class="node-diff-status">'+(b?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),E(d.wires,a.all).appendTo(p)):p.addClass("node-diff-empty"),void 0!==s&&(u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c),s?(w?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(y?"changed":"unchanged")),$('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),E(s.wires,i.all).appendTo(u)):u.addClass("node-diff-empty")));var D=Object.keys(o).filter(function(e){return!("inputLabels"==e||"outputLabels"==e||"z"==e||"wires"==e||"x"===e||"y"===e||"id"===e||"type"===e||t.defaults&&t.defaults.hasOwnProperty(e))});return t.defaults&&(D=D.concat(Object.keys(t.defaults))),"tab"!==o.type&&(D=D.concat(["inputLabels","outputLabels"])),D.forEach(function(n){w=y=b=!1,h=JSON.stringify(o[n]),d&&(g=JSON.stringify(d[n]),h!==g&&(b=!0,0)),s&&(v=JSON.stringify(s[n]),h!==v&&(y=!0,0)),(y&&b&&g!==v||!b&&y&&a.diff.deleted[o.id]||b&&!y&&i.diff.deleted[o.id])&&(w=!0),c=$("<tr>").appendTo(m);var e=$("<td>",{class:"node-diff-property-cell-label"}).html(n).appendTo(c);p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),d?(w?(p.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("node-diff-node-"+(b?"changed":"unchanged")),$('<span class="node-diff-status">'+(b?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),f=$('<span class="node-diff-element"></span>').appendTo(p),r["local."+n]=RED.utils.createObjectElement(d[n],{path:n,exposeApi:!0,ontoggle:function(e,t){r["remote."+n]&&r["remote."+n].prop("expand")(e,t)}}).appendTo(f)):p.addClass("node-diff-empty"),void 0!==s&&(u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c),s?(w?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(y?"changed":"unchanged")),$('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),f=$('<span class="node-diff-element"></span>').appendTo(u),r["remote."+n]=RED.utils.createObjectElement(s[n],{path:n,exposeApi:!0,ontoggle:function(e,t){r["local."+n]&&r["local."+n].prop("expand")(e,t)}}).appendTo(f)):u.addClass("node-diff-empty")),d&&s&&"string"==typeof d[n]&&(/\n/.test(d[n])||/\n/.test(s[n]))&&$('<button class="editor-button editor-button-small node-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').click(function(){_(d[n],s[n])}).appendTo(e)}),e}function I(a,i,e,t,s,n,o,r){var d="node-diff-selectbox-"+a.id.replace(/\./g,"-")+(s?"-props":""),l="";(a.z||s)&&(l="node-diff-selectbox-tab-"+(s?a.id:a.z).replace(/\./g,"-"));var c=!s&&("tab"===a.type||"subflow"===a.type),p=function(e){var t;if(void 0===a.type);else if(c)t="node-diff-selectbox-tab-"+a.id.replace(/\./g,"-"),$("."+t+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+t+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-local"),$("."+t+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-remote")):($("."+t+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-local"),$("."+t+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-remote"));else{var n="node-diff-selectbox-"+(s?a.id:a.z).replace(/\./g,"-");$("#"+n+"-local").prop("checked",!1),$("#"+n+"-remote").prop("checked",!1);var o=$("#"+n+"-local").closest(".node-diff-tab").find(".node-diff-tab-title");o.removeClass("node-diff-select-local"),o.removeClass("node-diff-select-remote")}"local"===this.value?(i.removeClass("node-diff-select-remote"),i.addClass("node-diff-select-local")):"remote"===this.value&&(i.addClass("node-diff-select-remote"),i.removeClass("node-diff-select-local")),x(r)},u=$("<label>",{class:"node-diff-selectbox",for:d+"-local"}).click(function(e){e.stopPropagation()}).appendTo(e),f=$("<input>",{id:d+"-local",type:"radio",value:"local",name:d,class:l+"-local"+(c?"":" node-diff-select-node")}).data("node-id",a.id).change(p).appendTo(u),h=$("<label>",{class:"node-diff-selectbox",for:d+"-remote"}).click(function(e){e.stopPropagation()}).appendTo(t),g=$("<input>",{id:d+"-remote",type:"radio",value:"remote",name:d,class:l+"-remote"+(c?"":" node-diff-select-node")}).data("node-id",a.id).change(p).appendTo(h);"local"===o?f.prop("checked",!0):"remote"===o&&g.prop("checked",!0),(n||e.hasClass("node-diff-empty")||t.hasClass("node-diff-empty"))&&(u.hide(),h.hide())}function x(e){var t=0;$(".node-diff-selectbox>input:checked").each(function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()});var n=Object.keys(e.conflicts).length;n-t==0?$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})):$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})),n===t&&($("#node-diff-view-diff-merge").removeClass("disabled"),$("#node-diff-view-resolve-diff").removeClass("disabled"))}function t(s){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){var t=RED.nodes.createCompleteNodeSet(),n=RED.nodes.originalFlow(),o=e.flows,a=T(n,t),i=T(n,o);i.rev=e.rev,s(k(a,i))}})}function n(e){void 0===e?t(n):function(a,i){if(c)return;(i=i||{}).mode,a.localDiff;var s=a.remoteDiff,r=a.conflicts,e={title:i.title||"Review Changes",width:1/0,overlay:!0,buttons:[{text:RED._("merge"===i.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),n=($('<div class="node-diff-toolbar"><span><span id="node-diff-toolbar-resolved-conflicts"></span></span> </div>').prependTo(t),$('<div class="node-diff-container"></div>').appendTo(t)),o=R(n,a,i);o.list.hide(),s?($("#node-diff-view-diff-merge").show(),0===Object.keys(r).length?$("#node-diff-view-diff-merge").removeClass("disabled"):$("#node-diff-view-diff-merge").addClass("disabled")):$("#node-diff-view-diff-merge").hide(),x(a),setTimeout(function(){o.finish(),o.list.show()},300),$("#sidebar-shade").show()},close:function(){c=!1,$("#sidebar-shade").hide()},show:function(){}};"merge"===i.mode&&e.buttons.push({id:"node-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-diff-view-diff-merge").hasClass("disabled")||(x(a),o(a),RED.tray.close())}});RED.tray.show(e)}(e,{mode:"merge"})}function d(e){var t=[],n={},o={},a=[],i={};return e.forEach(function(e){"tab"===(i[e.id]=e).type?(t.push(e.id),n[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(o[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(n[e.z]?n[e.z].nodes.push(e):o[e.z]?o[e.z].nodes.push(e):a.push(e))}),{all:i,tabOrder:t,tabs:n,subflows:o,globals:a}}function T(e,t){var n=d(e),o=d(t),a={},i={},s={},r={};return Object.keys(n.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);o.all.hasOwnProperty(e)?JSON.stringify(n.all[e])!==JSON.stringify(o.all[e])&&(s[e]=!0,n.all[e].z!==o.all[e].z&&(r[e]=!0)):i[e]=!0}),Object.keys(o.all).forEach(function(e){n.all.hasOwnProperty(e)||(a[e]=!0)}),{currentConfig:n,newConfig:o,added:a,deleted:i,changed:s,moved:r}}function k(e,t){var n,o,a={},i={},s={localDiff:e,remoteDiff:t,conflicts:a,resolutions:i},r={};for(n in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(n)){r[n]=!0;var d=e.newConfig.all[n];if(e.changed[n]&&t.deleted[n])a[n]=!0;else if(e.deleted[n]&&t.changed[n])a[n]=!0;else if(e.changed[n]&&t.changed[n]){var l=t.newConfig.all[n];JSON.stringify(d)!==JSON.stringify(l)&&(a[n]=!0)}a[n]||(t.added[n]||t.changed[n]||t.deleted[n]?i[n]="remote":i[n]="local")}for(n in e.added)e.added.hasOwnProperty(n)&&(o=e.newConfig.all[n],t.deleted[o.z]?a[n]=!0:i[n]="local");for(n in t.added)t.added.hasOwnProperty(n)&&(o=t.newConfig.all[n],e.deleted[o.z]?a[n]=!0:i[n]="remote");return s}function s(e){e.localDiff.currentConfig;var t,n=e.localDiff,o=e.remoteDiff,a=e.conflicts,i=e.resolutions;for(t in a)if(a.hasOwnProperty(t)&&!i.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var s,r=[],d={},l={};for(t in n.newConfig.all)n.newConfig.all.hasOwnProperty(t)&&(s=RED.nodes.node(t),"local"===i[t]?(s&&(d[t]=s.changed),r.push(n.newConfig.all[t])):"remote"===i[t]?!o.deleted[t]&&o.newConfig.all.hasOwnProperty(t)&&(s&&(d[t]=s.changed),l[t]=!0,r.push(o.newConfig.all[t])):console.log("Unresolved",t));for(t in o.added)o.added.hasOwnProperty(t)&&((s=RED.nodes.node(t))&&(d[t]=s.changed),n.added.hasOwnProperty(t)||(l[t]=!0,r.push(o.newConfig.all[t])));return{config:r,nodeChangedStates:d,localChangedStates:l}}function o(e){var t=s(e),n=t.config,o=t.nodeChangedStates,a=t.localChangedStates,i={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:o,dirty:RED.nodes.dirty(),rev:RED.nodes.version()};RED.history.push(i),RED.nodes.clear(),RED.nodes.import(n)[0].forEach(function(e){(o[e.id]||a[e.id])&&(e.changed=!0)}),RED.nodes.version(e.remoteDiff.rev),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}function _(y,w){var e={title:"Compare Changes",width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),n=$('<div class="node-text-diff"></div>').appendTo(t),o=$("<table>",{class:"node-text-diff-content"}).appendTo(n);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(o);for(var a,i=$("<tbody>").appendTo(o),s=function(e,t,n){var o,a,i=e.split(/\r?\n/),s=t.split(/\r?\n/),r=i.length,d=s.length,l={a:[],b:[]},c=[];for(o=0;o<r+1;o++)for(c[o]=[],a=0;a<d+1;a++)c[o][a]=0;for(o=r-1;0<=o;o--)for(a=d-1;0<=a;a--)0,1!==j(i[o],s[a],n)?c[o][a]=c[o+1][a+1]+1:c[o][a]=Math.max(c[o+1][a],c[o][a+1]);a=o=0;for(;o<r&&a<d;){var p=j(i[o],s[a],n);if(1!==p){var u=0;0===p?u=0:2==p&&(u=3),l.a.push({i:o+1,j:a+1,line:i[o],type:u}),l.b.push({i:a+1,j:o+1,line:s[a],type:u}),o++,a++}else c[o+1][a]>=c[o][a+1]?(l.a.push({i:o+1,line:i[o],type:1}),o++):(l.b.push({i:a+1,line:s[a],type:4}),a++)}for(;o<r||a<d;)o==r?(l.b.push({i:a+1,line:s[a],type:4}),a++):a==d&&(l.a.push({i:o+1,line:i[o],type:1}),o++);return l}(y||"",w||""),r=0,d=0,l=Math.max(s.a.length,s.b.length),c=[],p=[],u=0,f=0,h=0;h<l;h++){s[h];var g=r<s.a.length?s.a[r]:{type:2,line:""},v=d<s.b.length?s.b[d]:{type:2,line:""};0===g.type&&0!==v.type?(g={type:2,line:""},d++):0===v.type&&0!==g.type?(v={type:2,line:""},r++):(r++,d++),c.push({a:g,b:v}),void 0===a?(a={start:h,end:h},f=(u=0)===g.type&&0===v.type?0:1):0===g.type&&0===v.type?0===f?(a.end=h,u++):1===f?(a.end=h,f=2,u=0):2===f&&(a.end=h,8===++u&&(a.end-=5,p.push(a),a={start:h-5,end:h-5},u=f=0)):(a.end=h,u++,0===f?(3<a.end&&(a.end-=3,a.empty=!0,p.push(a),a={start:h-3,end:h-3}),f=1):2===f&&(f=1))}0===f&&(a.empty=!0),a.end=l,p.push(a);for(var m=0;m<p.length;m++)if((a=p[m]).empty)D(a.start,a.end,c).appendTo(i);else for(h=a.start;h<a.end;h++){var b=C(c[h]).appendTo(i);h===a.start?b.addClass("start-block"):h===a.end-1&&b.addClass("end-block")}},close:function(){c=!1},show:function(){}};RED.tray.show(e)}function D(a,i,s){diffRow=$('<tr class="node-text-diff-header node-text-diff-expand">');var e=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),r=$("<span></span>").appendTo(e);return i<s.length-1&&r.text("@@ -"+(s[i-1].a.i+1)+" +"+(s[i-1].b.i+1)),diffRow.click(function(e){if(20<i-a){var t=$(this).offset();if(0<a){for(var n=a;n<a+10;n++)C(s[n]).addClass("unchanged").insertBefore($(this));a+=10}if(i<s.length-1){for(n=i-1;i-11<n;n--)C(s[n]).addClass("unchanged").insertAfter($(this));i-=10}i<s.length-1&&r.text("@@ -"+(s[i-1].a.i+1)+" +"+(s[i-1].b.i+1));var o=$(this).offset().top-t.top;$(".node-text-diff").scrollTop($(".node-text-diff").scrollTop()+o)}else{for(n=a;n<i;n++)C(s[n]).addClass("unchanged").insertBefore($(this));$(this).remove()}}),diffRow}function C(e){var t=$("<tr>"),n=e.a,o=e.b,a=$('<td class="lineno">').text(2===n.type?"":n.i).appendTo(t),i=$('<td class="linetext">').text(n.line).appendTo(t);return 2===n.type?(a.addClass("blank"),i.addClass("blank")):4===n.type?(a.addClass("added"),i.addClass("added")):1===n.type&&(a.addClass("removed"),i.addClass("removed")),a=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),i=$('<td class="linetext">').text(o.line).appendTo(t),2===o.type?(a.addClass("blank"),i.addClass("blank")):4===o.type?(a.addClass("added"),i.addClass("added")):1===o.type&&(a.addClass("removed"),i.addClass("removed")),t}function j(e,t,n){return n?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function p(e,E){var g=$("<div></div>");return e.forEach(function(v){var e=v.hunks,t=v.binary,n=$("<table>",{class:"node-text-diff-content"}).appendTo(g);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(n);var m=$("<tbody>").appendTo(n),o=$('<tr class="node-text-diff-file-header">').appendTo(m),a=$('<td colspan="3"></td>').appendTo(o);$('<i class="node-diff-chevron fa fa-angle-down"></i>').appendTo(a);o.click(function(e){o.toggleClass("collapsed");var t=o.hasClass("collapsed");o.nextUntil(".node-text-diff-file-header").toggle(!t)});$('<span class="filename"></span>').text(v.file).appendTo(a);var b,y=0,w=0,D={};if(E.project.files&&E.project.files.flow===v.file){E.unmerged&&$('<span style="float: right;"><span id="node-diff-toolbar-resolved-conflicts"></span></span>').appendTo(a);var i=$('<tr class="node-text-diff-header">').appendTo(m),l=$('<td class="flow-diff" colspan="3"></td>').appendTo(i),s=E.project.name,c=E.project.files.flow,p="projects/"+s+"/files/"+E.commonRev+"/"+c,u="projects/"+s+"/files/"+E.oldRev+"/"+c,r="projects/"+s+"/files/"+E.newRev+"/"+c,d=[$.Deferred(),$.Deferred(),$.Deferred()];if(E.commonRev){p="projects/"+s+"/files/"+E.commonRev+"/"+c;$.ajax({dataType:"json",url:p}).then(function(e){d[0].resolve(e)}).fail(function(){d[0].resolve(null)})}else d[0].resolve(null);$.ajax({dataType:"json",url:u}).then(function(e){d[1].resolve(e)}).fail(function(){d[1].resolve({content:"[]"})}),$.ajax({dataType:"json",url:r}).then(function(e){d[2].resolve(e)}).fail(function(){d[2].resolve({content:"[]"})}),$.when.apply($,d).always(function(e,t,n){var o,a,i;if(e)try{o=JSON.parse(e.content||"[]")}catch(e){return console.log("Common Version doesn't contain valid JSON:",p),void console.log(e)}try{a=JSON.parse(t.content||"[]")}catch(e){return console.log("Old Version doesn't contain valid JSON:",u),void console.log(e)}o||(o=a);try{i=JSON.parse(n.content||"[]")}catch(e){return console.log("New Version doesn't contain valid JSON:",i),void console.log(e)}var s=T(o,a),r=T(o,i);E.currentDiff=k(s,r);var d=R(l,E.currentDiff,{title:c,mode:E.commonRev?"merge":"view",oldRevTitle:E.oldRevTitle,newRevTitle:E.newRevTitle});d.list.hide(),x(E.currentDiff),setTimeout(function(){d.finish(),d.list.show()},300)})}else if(t){var f=$('<tr class="node-text-diff-header">').appendTo(m),h=$('<td colspan="3"></td>').appendTo(f);$("<span></span>").text("Cannot show binary file contents").appendTo(h)}else E.unmerged&&(b=$('<span style="float: right;"><span>'+w+"</span> of <span>"+y+"</span> conflicts resolved</span>").appendTo(a)),e.forEach(function(u){var e=$('<tr class="node-text-diff-header">').appendTo(m),t=$('<td colspan="3"></td>').appendTo(e),f=($("<span></span>").text(u.header).appendTo(t),u.conflict),h=u.localStartLine,g=u.remoteStartLine;f&&y++,u.lines.forEach(function(e,t){var n,o=u.diffStart+t,a=f&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(e),i=$("<tr>").appendTo(m),s=$('<td class="lineno">').appendTo(i);a?s.attr("colspan",2):n=$('<td class="lineno">').appendTo(i);var r=$('<td class="linetext">').appendTo(i),d=1;if(f&&(d=2),a){if(i.addClass("mergeHeader"),/^\+\+=======$/.test(e))u.changeSeparator=o,i.addClass("mergeHeader-separator");else{var l=/^..<<<<<<</.test(e);l?($("<span>").text("<<<<<<< Local Changes").appendTo(r),u.localChangeStart=o):(u.remoteChangeEnd=o,$("<span>").text(">>>>>>> Remote Changes").appendTo(r)),i.addClass("mergeHeader-"+(l?"ours":"theirs")),$('<button class="editor-button editor-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(l?"down":"up")+'"></i> use '+(l?"local":"remote")+" changes</button>").appendTo(r).click(function(e){var t,n;e.preventDefault(),w++,l?((n=(t=i.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),n.next().remove()):((n=(t=i.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),n.prev().remove()),n.remove(),i.remove(),t.find(".linetext").addClass("added"),b.empty(),$("<span><span>"+w+"</span> of <span>"+y+"</span> conflicts resolved</span>").appendTo(b),D[v.file]=D[v.file]||{},D[v.file][u.localChangeStart]={changeStart:u.localChangeStart,separator:u.changeSeparator,changeEnd:u.remoteChangeEnd,selection:l?"A":"B"},E.resolveConflict&&E.resolveConflict({conflicts:y,resolved:w,resolutions:D})})}}else{var c=e[0];f&&!E.unmerged&&" "===c&&(c=e[1]),$('<span class="prefix">').text(c).appendTo(r);var p=!1;f&&E.unmerged?($('<span class="prefix">').text(e[1]).appendTo(r),"+"===e[0]&&(s.text(h++),p=!0),"+"===e[1]&&(n.text(g++),p=!0)):"+"===e[0]||f&&"+"===e[1]?(s.addClass("added"),n.addClass("added"),r.addClass("added"),n.text(g++),p=!0):("-"===e[0]||f&&"-"===e[1])&&(s.addClass("removed"),n.addClass("removed"),r.addClass("removed"),s.text(h++),p=!0),p||(r.addClass("unchanged"),0<h&&"\\"!==e[0]&&""!==e&&s.text(h++),0<g&&"\\"!==e[0]&&""!==e&&n.text(g++)),$("<span>").text(e.substring(d)).appendTo(r)}})})}),g}function r(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var n,o,a=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,i=/^\+\+\+ b\/(.*)\t?/,s=/^Binary files /,r=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,d=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,l=[],c=0;c<t.length;c++){var p=t[c],u=a.exec(p);if(u)o&&(n.hunks.push(o),l.push(n)),o=null,n={file:u[1]||u[3],hunks:[]};else if(s.test(p))n&&(n.binary=!0);else{var f=i.exec(p);if(f)n.file=f[1];else{var h=r.exec(p);if(h){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=d.exec(p)){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}o&&o.lines.push(p)}}}return o&&n.hunks.push(o),l.push(n),l}return{init:function(){RED.actions.add("core:show-remote-diff",n)},getRemoteDiff:t,showRemoteDiff:n,showUnifiedDiff:function(o){var t,e=o.diff,n=o.title,a=r(e);o.unmerged&&(o.resolveConflict=function(e){(t=e).conflicts===e.resolved&&$("#node-diff-view-resolve-diff").removeClass("disabled")});var i={title:n||"Compare Changes",width:1/0,overlay:!0,buttons:[{text:RED._(o.unmerged?"common.label.cancel":"common.label.close"),click:function(){o.oncancel&&o.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),n=$('<div class="node-text-diff"></div>').appendTo(t);p(a,o).appendTo(n)},close:function(){c=!1},show:function(){}};o.unmerged&&i.buttons.push({id:"node-diff-view-resolve-diff",text:"Save conflict resolution",class:"primary disabled",click:function(){if(!$("#node-diff-view-resolve-diff").hasClass("disabled")){if(o.currentDiff){var e=s(o.currentDiff);(t={resolutions:{}}).resolutions[o.project.files.flow]=JSON.stringify(e.config,"",4)}o.onresolve&&o.onresolve(t),RED.tray.close()}}}),RED.tray.show(i)},showCommitDiff:function(d){var l=function(e){for(var t={},n=e.split("\n"),o=[],a=0;a<n.length;a++)if(/^commit /.test(n[a]))t.sha=n[a].substring(7);else if(/^Author: /.test(n[a])){t.author=n[a].substring(8);var i=/^(.*) <(.*)>$/.exec(t.author);i&&(t.authorName=i[1],t.authorEmail=i[2])}else if(/^Date: /.test(n[a]))t.date=n[a].substring(8);else if(/^    /.test(n[a]))t.title?(4!==n[a].length||0<o.length)&&o.push(n[a].substring(4)):t.title=n[a].substring(4);else if(/^diff /.test(n[a])){t.files=r(n.slice(a));break}return t.comment=o.join("\n"),t}(d.commit),e={title:"View Commit Changes",width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),n=$('<div class="node-text-diff"></div>').appendTo(t),o=$("<table>",{class:"node-text-diff-content"}).appendTo(n);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(o);var a=$("<tbody>").appendTo(o),i=$('<tr class="node-text-diff-commit-header">').appendTo(a),s=$('<td colspan="3"></td>').appendTo(i);$("<h3>").text(l.title).appendTo(s),$('<div class="commit-body"></div>').text(l.comment).appendTo(s);var r=$('<div class="commit-summary"></div>').appendTo(s);$('<div style="float: right">').text("Commit "+l.sha).appendTo(r),$("<div>").text((l.authorName||l.author)+" - "+d.date).appendTo(r),l.files&&p(l.files,d).appendTo(n)},close:function(){c=!1},show:function(){}};RED.tray.show(e)},mergeDiff:o}}(),RED.keyboard=function(){var s,n=/Mac/i.test(window.navigator.platform),p={},r={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},t={16:!0,17:!0,18:!0,91:!0,93:!0},u={},d={},l={59:186,61:187,173:189};function f(e){for(var t,n=e.toLowerCase().split("-"),o={},a=0;a<n.length;a++)switch(n[a]){case"ctrl":case"cmd":o.ctrl=!0,o.meta=!0;break;case"alt":o.alt=!0;break;case"shift":o.shift=!0;break;case"":0,t=r["-"];break;default:if(r.hasOwnProperty(n[a]))t=r[n[a]];else{if(1<n[a].length)return null;t=n[a].toUpperCase().charCodeAt(0)}}return[t,o]}function c(e,t,n,o){var a=n,i=o;"function"!=typeof n&&"string"!=typeof n||(a={},i=n);var s=[],r=0;if("string"==typeof t){"string"==typeof i&&(u[i]={scope:e,key:t},"boolean"==typeof o&&(u[i].user=o));var d=t.split(" ");for(r=0;r<d.length;r++){var l=f(d[r]);if(!l)return;s.push(l)}}else s.push([t,a]);var c=p;for(r=0;r<s.length;r++)t=s[r][0],(a=s[r][1]).ctrl&&(c.ctrl=c.ctrl||{},c=c.ctrl),a.shift&&(c.shift=c.shift||{},c=c.shift),a.alt&&(c.alt=c.alt||{},c=c.alt),c[t]=c[t]||{},c=c[t];c.scope=e,c.ondown=i}function o(e,t){var n=t||{},o=[],a=0;if("string"==typeof e){var i=e.split(" ");for(a=0;a<i.length;a++){var s=f(i[a]);if(!s)return void console.log("Unrecognised key specifier:",e);o.push(s)}}else o.push([e,n]);var r=p;for(a=0;a<o.length;a++){if(e=o[a][0],(n=o[a][1]).ctrl&&(r=r.ctrl),r&&n.shift&&(r=r.shift),r&&n.alt&&(r=r.alt),!r[e])return;r=r[e]}"string"==typeof r.ondown&&("boolean"==typeof t&&t?u[r.ondown]={user:t}:delete u[r.ondown]),delete r.scope,delete r.ondown}d3.select(window).on("keydown",function(){if(!t[d3.event.keyCode]){var e=function e(t){var n=s||p;(t.ctrlKey||t.metaKey)&&(n=n.ctrl),n&&t.shiftKey&&(n=n.shift),n&&t.altKey&&(n=n.alt);var o=l[t.keyCode]||t.keyCode;if(n&&n[o]){var a=n[o];if(!a.scope)return s?(s=null,e(t)):(0<Object.keys(a).length&&(s=a,t.preventDefault()),null);if(a.scope&&"*"!==a.scope){for(var i=t.target;"BODY"!==i.nodeName&&i.id!==a.scope;)i=i.parentElement;"BODY"===i.nodeName&&(a=null)}return s=null,a}if(s)return s=null,e(t)}(d3.event);e&&e.ondown&&("string"==typeof e.ondown?RED.actions.invoke(e.ondown):e.ondown(),d3.event.preventDefault())}});function h(e){e.preventDefault();var i=$(this),s=i.data("data");if(!i.hasClass("keyboard-shortcut-entry-expanded")){g();var t=i.find(".keyboard-shortcut-entry-key"),n=i.find(".keyboard-shortcut-entry-scope");i.addClass("keyboard-shortcut-entry-expanded");var o=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(s.key||"").appendTo(t);o.on("keyup",function(e){if(13===e.keyCode)return g();var t=$(this).val(),n=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!n)});var a=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(n);a.i18n(),a.val(s.scope||"*");var r=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(n),d=$('<button class="editor-button editor-button-small"><i class="fa fa-check"></i></button>').appendTo(r),l=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(r);d.click(function(e){e.stopPropagation(),g()}),l.click(function(e){e.stopPropagation(),RED.keyboard.revertToDefault(s.id),i.empty(),i.removeClass("keyboard-shortcut-entry-expanded");var t=RED.keyboard.getShortcut(s.id),n=RED.settings.get("keymap")||{},o=RED.settings.get("editor")||{};(n=o.keymap||{})[s.id]=null,o.keymap=n,RED.settings.set("editor",o);var a={id:s.id,scope:t?t.scope:void 0,key:t?t.key:void 0,user:t?t.user:void 0};v(i,a)}),o.focus()}}function g(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var n=t.data("data"),o=t.find(".keyboard-shortcut-entry-key input"),a=t.find(".keyboard-shortcut-entry-scope select");if(!e){var i=o.val().trim(),s=a.val();if(""===i||RED.keyboard.validateKey(i)){var r=RED.keyboard.getShortcut(n.id);if(!r&&i||r&&(r.scope!==s||r.key!==i)){var d=t.find(".keyboard-shortcut-entry-key"),l=t.find(".keyboard-shortcut-entry-scope");d.empty(),l.empty(),n.key&&RED.keyboard.remove(n.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===i?(d.parent().addClass("keyboard-shortcut-entry-unassigned"),d.append($("<span>").text(RED._("keyboard.unassigned"))),delete n.key,delete n.scope):(d.parent().removeClass("keyboard-shortcut-entry-unassigned"),d.append(RED.keyboard.formatKey(i)),$("<span>").text(s).appendTo(l),n.key=i,n.scope=s,RED.keyboard.add(n.scope,n.key,n.id,!0));var c=RED.settings.get("editor")||{},p=c.keymap||{};p[n.id]=RED.keyboard.getShortcut(n.id),c.keymap=p,RED.settings.set("editor",c)}}}o.remove(),a.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function v(e,t){var n=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var o=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),a=$("<div>").addClass("keyboard-shortcut-entry-text").text(o).appendTo(n),i=$('<i class="fa fa-user"></i>').prependTo(a);t.user||i.css("opacity",0);var s=$('<div class="keyboard-shortcut-entry-key">').appendTo(n);t.key?s.append(RED.keyboard.formatKey(t.key)):(n.addClass("keyboard-shortcut-entry-unassigned"),s.append($("<span>").text(RED._("keyboard.unassigned"))));var r=$('<div class="keyboard-shortcut-entry-scope">').appendTo(n);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(r),e.click(h)}function e(){var e=$('<div id="user-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="user-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("input").searchBox({delay:100,change:function(){var t=$(this).val().trim();""===t?n.editableList("filter",null):(t=t.replace(/\s/g,""),n.editableList("filter",function(e){return-1<e.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(t)}))}});var n=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){v(e,n)}}),t=RED.actions.list();return t.sort(function(e,t){var n=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),o=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return n.localeCompare(o)}),t.forEach(function(e){n.editableList("addItem",e)}),e}return{init:function(){!function(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");if(null!==e){localStorage.removeItem("keymap");var t=RED.settings.get("editor")||{};t.keymap=JSON.parse(e),RED.settings.set("editor",t)}}}();var s=(RED.settings.get("editor")||{}).keymap||{};$.getJSON("red/keymap.json",function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];for(var o in n)n.hasOwnProperty(o)&&(s.hasOwnProperty(n[o])||c(t,o,n[o],!1),d[n[o]]={scope:t,key:o,user:!1})}for(var a in s)if(s.hasOwnProperty(a)){var i=s[a];i.hasOwnProperty("key")&&c(i.scope,i.key,a,!0)}}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:e,focus:function(){setTimeout(function(){$("#user-settings-tab-keyboard-filter").focus()},200)}})},add:c,remove:o,getShortcut:function(e){return u[e]},revertToDefault:function(e){var t=u[e];if(t&&o(t.key),d.hasOwnProperty(e)){var n=d[e];c(n.scope,n.key,e,!1)}},formatKey:function(e){var t=n?e.replace(/ctrl-?/,"&#8984;"):e;return'<span class="help-key-block"><span class="help-key">'+(t=(t=(t=(t=(t=(t=n?t.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;")).split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++)if(!f(t[i]))return!1;return!0}}}(),RED.workspaces=function(){var l,n=0,o=0;function a(e,t){if(e)l.addTab(e),l.resize();else{for(var n=RED.nodes.id();o+=1,0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:o})+"']").size(););e={type:"tab",id:n,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:o})},RED.nodes.addWorkspace(e),l.addTab(e),l.activateTab(n),t||(RED.history.push({t:"add",workspaces:[e],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),e}function i(e){if(1!==s){c(e);var t=RED.nodes.removeWorkspace(e.id);t.t="delete",t.dirty=RED.nodes.dirty(),t.workspaces=[e],RED.history.push(t),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function t(e){var r,d=RED.nodes.workspace(e);RED.view.state(RED.state.EDITING);var t={title:RED._("workspace.editFlow",{name:d.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===s?" disabled":""),text:RED._("common.label.delete"),click:function(){i(d),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e=$("#node-input-name").val(),t=!1,n={};d.label!=e&&(n.label=d.label,t=!0,d.label=e,l.renameTab(d.id,e));var o=$("#node-input-disabled").prop("checked");d.disabled!==o&&(n.disabled=d.disabled,t=!0,d.disabled=o);var a=r.getValue();if(d.info!==a&&(n.info=d.info,t=!0,d.info=a),$("#red-ui-tab-"+d.id.replace(".","-")).toggleClass("workspace-disabled",d.disabled),t){var i={t:"edit",changes:n,node:d,dirty:RED.nodes.dirty()};d.changed=!0,RED.history.push(i),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var s=RED.view.selection();s.nodes||s.links||RED.sidebar.info.refresh(d)}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)n-=$(t[o]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),n-=28,$(".node-text-editor").css("height",n+"px"),r.resize()},open:function(e){var t=e.find(".editor-tray-body"),n=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(n),$('<div class="form-row"><label for="node-input-disabled-btn" data-i18n="editor:workspace.status"></label><button id="node-input-disabled-btn" class="editor-button"><i class="fa fa-toggle-on"></i> <span id="node-input-disabled-label"></span></button> <input type="checkbox" id="node-input-disabled" style="display: none;"/></div>').appendTo(n),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(n),r=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<div class="form-tips" data-i18n="editor:workspace.tip"></div>').appendTo(n),n.find("#node-input-disabled-btn").on("click",function(e){var t=$(this).find("i");t.hasClass("fa-toggle-off")?(t.addClass("fa-toggle-on"),t.removeClass("fa-toggle-off"),$("#node-input-disabled").prop("checked",!1),$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(t.addClass("fa-toggle-off"),t.removeClass("fa-toggle-on"),$("#node-input-disabled").prop("checked",!0),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled")))}),d.hasOwnProperty("disabled")?($("#node-input-disabled").prop("checked",d.disabled),d.disabled?(n.find("#node-input-disabled-btn i").removeClass("fa-toggle-on").addClass("fa-toggle-off"),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled"))):$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(d.disabled=!1,$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))),$('<input type="text" style="display: none;" />').prependTo(n),n.submit(function(e){e.preventDefault()}),$("#node-input-name").val(d.label),RED.text.bidi.prepareInput($("#node-input-name")),r.getSession().setValue(d.info||"",-1),n.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(d),r.destroy()}};RED.tray.show(t)}var s=0;function e(){l=RED.tabs.create({id:"workspace-tabs",onchange:function(e){var t={old:n};n=e.id,t.workspace=n,RED.events.emit("workspace:change",t),window.location.hash="flow/"+e.id,RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?t(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&s++,$('<span class="workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",s<=1),1===s&&($("#workspace .red-ui-tabs").show(),$("#chart").show(),$("#workspace-footer").children().show())},onremove:function(e){"tab"===e.type&&s--,RED.menu.setDisabled("menu-item-workspace-delete",s<=1),0===s&&r()},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),p(t)},minimumActiveTabWidth:150,scrollable:!0,addButton:function(){a()}}),s=0}function r(){$("#workspace .red-ui-tabs").hide(),$("#chart").hide(),$("#workspace-footer").children().hide()}function d(e){t(e||n)}function c(e){e?l.contains(e.id)&&l.removeTab(e.id):i(RED.nodes.workspace(n)),e.id===n&&(n=0)}function p(e){RED.nodes.setWorkspaceOrder(e.filter(function(e){return void 0!==RED.nodes.workspace(e)})),l.order(e)}return{init:function(){e(),RED.events.on("sidebar:resize",l.resize),RED.actions.add("core:show-next-tab",l.nextTab),RED.actions.add("core:show-previous-tab",l.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){i(RED.nodes.workspace(n))}),$(window).resize(function(){l.resize()}),RED.actions.add("core:add-flow",a),RED.actions.add("core:edit-flow",d),RED.actions.add("core:remove-flow",c),r()},add:a,remove:c,order:p,edit:d,contains:function(e){return l.contains(e)},count:function(){return s},active:function(){return n},show:function(e){if(!l.contains(e)){var t=RED.nodes.subflow(e);if(!t)return;a({type:"subflow",id:e,icon:"red/images/subflow_tab.png",label:t.name,closeable:!0})}l.activateTab(e)},refresh:function(){RED.nodes.eachWorkspace(function(e){l.renameTab(e.id,e.label)}),RED.nodes.eachSubflow(function(e){l.contains(e.id)&&l.renameTab(e.id,e.name)}),RED.sidebar.config.refresh()},resize:function(){l.resize()}}}(),RED.view=function(){var k,_,C=5e3,j=5e3,S=.75,c=1,O=100,L=30,g=1e3,v=0,m=[],b=0,s={},P=20,N=!1,I=!1,D=null,r=[],d=[],l=[],A=null,f=null,z=null,M=null,B=0,h=null,J=[0,0],U=null,G=0,F=[],q=null,E=!1,p=null,u=null,y=0,V=0,i="",R={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},W=1,H=0,K=d3.select("#chart").append("svg:svg").attr("width",C).attr("height",j).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){Ce()}).on("contextmenu",function(){d3.event.preventDefault()}),x=K.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","innerCanvas").on("mousemove",Q).on("mousedown",function(){var l;z||f||(A=null,se());0===G&&q&&(q.remove(),q=null);if((0===G||G===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){l=d3.mouse(this),d3.event.stopPropagation();var e=$("#main-container").position();G!==RED.state.QUICK_JOINING&&(G=RED.state.QUICK_JOINING,$(window).on("keyup",ve)),RED.typeSearch.show({x:d3.event.clientX-e.left-O/2,y:d3.event.clientY-e.top-L/2,cancel:function(){ge()},add:function(e){var t=T(e);if(t){var n=t.node,o=t.historyEvent;if(n.x=l[0],n.y=l[1],G===RED.state.QUICK_JOINING)if(0<Y.length){var a,i,s=Y[0],r=null;if(s.portType===H&&0<n.inputs?(r=s.node,i=s.port,a=n):s.portType===W&&0<n.outputs&&(r=n,a=s.node,i=0),null!==r){var d={source:r,sourcePort:i,target:a};RED.nodes.addLink(d),o.links=[d],w(),s.portType===H&&0<n.outputs?Z([{node:n,port:0,portType:H}]):s.portType===W&&0<n.inputs?Z([{node:n,port:0,portType:W}]):ge()}else w(),ge()}else 0<n.outputs?Z([{node:n,port:0,portType:H}]):0<n.inputs?Z([{node:n,port:0,portType:W}]):ge();RED.history.push(o),RED.nodes.add(n),RED.editor.validateNode(n),RED.nodes.dirty(!0),ae(),n.selected=!0,F.push({n:n}),X(),se(),_e()}}}),X(),se(),_e()}0!==G||d3.event.metaKey||d3.event.ctrlKey||b||(l=d3.mouse(this),q=x.append("rect").attr("ox",l[0]).attr("oy",l[1]).attr("rx",1).attr("ry",1).attr("x",l[0]).attr("y",l[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault())}).on("mouseup",a).on("touchend",function(){clearTimeout(b),b=null,RED.touch.radialMenu.active()||(q&&e.attr("fill","#fff"),a.call(this))}).on("touchcancel",a).on("touchstart",function(){var e;if(1<d3.event.touches.length){clearTimeout(b),b=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),n=e.pageY-t.pageY,o=e.pageX-t.pageX,a=$("#chart").offset(),i=[$("#chart").scrollLeft(),$("#chart").scrollTop()];m=[(t.pageX+o/2-a.left+i[0])/c,(t.pageY+n/2-a.top+i[1])/c],[t.pageX+o/2,t.pageY+n/2],v=Math.sqrt(n*n+o*o)}else{var s=d3.select(document.body),r=[(e=d3.event.touches.item(0)).pageX,e.pageY];m=[e.pageX,e.pageY],v=0;d3.touches(this)[0];b=setTimeout(function(){b=null,ke(s,r)},g)}}).on("touchmove",function(){var e;if(RED.touch.radialMenu.active())d3.event.preventDefault();else if(d3.event.touches.length<2){if(b){var t=(e=d3.event.touches.item(0)).pageX-m[0],n=e.pageY-m[1];64<Math.abs(t*t+n*n)&&(clearTimeout(b),b=null)}else q&&d3.event.preventDefault();Q.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),a=e.pageY-o.pageY,i=e.pageX-o.pageX,s=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),r=Math.sqrt(a*a+i*i),d=[o.pageX+i/2,o.pageY+a/2];if(!isNaN(r)){oldScaleFactor=c,c=Math.min(2,Math.max(.3,c+Math.floor(100*r-100*v)/1e4));var l=[m[0]*(c-oldScaleFactor),m[1]*(c-oldScaleFactor)];v=r,d,$("#chart").scrollLeft(s[0]+l[0]),$("#chart").scrollTop(s[1]+l[1]),_e()}}}),e=x.append("svg:rect").attr("width",C).attr("height",j).attr("fill","#fff"),n=x.append("g");function t(){for(var e=[],t=0;t<C;t+=+P)e.push(t);n.selectAll("line.horizontal").remove(),n.selectAll("line.horizontal").data(e).enter().append("line").attr({class:"horizontal",x1:0,x2:C,y1:function(e){return e},y2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),n.selectAll("line.vertical").remove(),n.selectAll("line.vertical").data(e).enter().append("line").attr({class:"vertical",y1:0,y2:C,x1:function(e){return e},x2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"})}t();var o=x.append("g"),Y=[];function Z(e){for(var t=0;t<e.length;t++){var n=e[t];n.el=o.append("svg:path").attr("class","drag_line"),Y.push(n)}}function w(){for(;Y.length;){var e=Y.pop();e.el&&e.el.remove()}}function X(){var e=RED.workspaces.active();r=RED.nodes.filterNodes({z:e}),d=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function T(e,t,n){var o=/^subflow:(.+)$/.exec(e);if(D&&o){if(o[1]===D.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(o[1],D.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var a={id:RED.nodes.id(),z:RED.workspaces.active()};if(a.type=e,a._def=RED.nodes.getType(a.type),o){var i=RED.nodes.subflow(o[1]);a.name="",a.inputs=i.in.length,a.outputs=i.out.length}else{for(var s in a.inputs=a._def.inputs||0,a.outputs=a._def.outputs,a._def.defaults)a._def.defaults.hasOwnProperty(s)&&void 0!==a._def.defaults[s].value&&(a[s]=JSON.parse(JSON.stringify(a._def.defaults[s].value)));if(a._def.onadd)try{a._def.onadd.call(a)}catch(e){console.log("Definition error: "+a.type+".onadd:",e)}}a.changed=!0,a.moved=!0,a.w=O,a.h=Math.max(L,15*(a.outputs||0));var r={t:"add",nodes:[a.id],dirty:RED.nodes.dirty()};if(D){var d=RED.subflow.refresh(!0);d&&(r.subflow={id:D.id,changed:D.changed,instances:d.instances})}return{node:a,historyEvent:r}}function Q(){var e,p;if(U=d3.touches(this)[0]||d3.mouse(this),q){var t,n,o=parseInt(q.attr("ox")),a=parseInt(q.attr("oy")),i=parseInt(q.attr("x")),s=parseInt(q.attr("y"));return t=U[0]<o?o-(i=U[0]):U[0]-i,n=U[1]<a?a-(s=U[1]):U[1]-s,void q.attr("x",i).attr("y",s).attr("width",t).attr("height",n)}if(G==RED.state.QUICK_JOINING||G==RED.state.IMPORT_DRAGGING||z||null!=A){var r;if(G==RED.state.JOINING||G===RED.state.QUICK_JOINING){if(0===Y.length&&null!==M){if(d3.event.shiftKey){var d,l=[],c=[];if(A&&(M===H&&A.source===z&&A.sourcePort===B||M===W&&A.target===z))c=[A];else d=M===H?{source:z,sourcePort:B}:{target:z},c=RED.nodes.filterLinks(d);for(e=0;e<c.length;e++){var u=c[e];RED.nodes.removeLink(u),l.push({link:u,node:M===H?u.target:u.source,port:M===H?0:u.sourcePort,portType:M===H?W:H})}0===l.length?(ge(),_e()):(Z(l),G=0,X(),_e(),G=RED.state.JOINING)}else z&&Z([{node:z,port:B,portType:M}]);A=null}for(r=U,e=0;e<Y.length;e++){var f=Y[e],h=-((f.portType===H&&f.node.outputs||1)-1)/2*13+13*f.port,g=f.portType===H?1:-1,v=r[1]-(f.node.y+h),m=r[0]-(f.node.x+g*f.node.w/2),b=Math.sqrt(v*v+m*m),y=S,w=0;b<O&&(y=.75-(O-b)/O*.75),m*g<0&&(y+=Math.min(5*O,Math.abs(m))/(5*O)*2,Math.abs(v)<3*L&&(w=(0<v?.5:-.5)*((3*L-Math.abs(v))/(3*L))*(Math.min(O,Math.abs(m))/O))),f.el.attr("d","M "+(f.node.x+g*f.node.w/2)+" "+(f.node.y+h)+" C "+(f.node.x+g*(f.node.w/2+O*y))+" "+(f.node.y+h+w*L)+" "+(r[0]-g*y*O)+" "+(r[1]-w*L)+" "+r[0]+" "+r[1])}d3.event.preventDefault()}else if(G==RED.state.MOVING){r=d3.mouse(document.body),isNaN(r[0])&&(r=d3.touches(document.body)[0]),3<(J[0]-r[0])*(J[0]-r[0])+(J[1]-r[1])*(J[1]-r[1])&&(G=RED.state.MOVING_ACTIVE,V=0,I=!1,1===F.length&&(p=F[0],I=p.n.hasOwnProperty("_def")&&0<p.n._def.inputs&&0<p.n._def.outputs&&0===RED.nodes.filterLinks({source:p.n}).length&&0===RED.nodes.filterLinks({target:p.n}).length))}else if(G==RED.state.MOVING_ACTIVE||G==RED.state.IMPORT_DRAGGING){r=U;for(var D=0,E=0,$=C,R=j,x=0;x<F.length;x++)p=F[x],d3.event.shiftKey&&(p.n.ox=p.n.x,p.n.oy=p.n.y),p.n.x=r[0]+p.dx,p.n.y=r[1]+p.dy,p.n.dirty=!0,D=Math.min(p.n.x-p.n.w/2-5,D),E=Math.min(p.n.y-p.n.h/2-5,E),$=Math.max(p.n.x+p.n.w/2+5,$),R=Math.max(p.n.y+p.n.h/2+5,R);if(0!==D||0!==E)for(e=0;e<F.length;e++)(p=F[e]).n.x-=D,p.n.y-=E;if($!==C||R!==j)for(e=0;e<F.length;e++)(p=F[e]).n.x-=$-C,p.n.y-=R-j;if(N!=d3.event.shiftKey&&0<F.length){var T=[0,0];if(p=F[0],T[0]=p.n.x-(P*Math.floor((p.n.x-p.n.w/2)/P)+p.n.w/2),T[1]=p.n.y-P*Math.floor(p.n.y/P),0!==T[0]||0!==T[1])for(e=0;e<F.length;e++)(p=F[e]).n.x-=T[0],p.n.y-=T[1],p.n.x==p.n.ox&&p.n.y==p.n.oy&&(p.dirty=!1)}G!=RED.state.MOVING_ACTIVE&&G!=RED.state.IMPORT_DRAGGING||1!==F.length||(p=F[0],I&&(_||(_=setTimeout(function(){var e=[],t=1/0,n=null,o=p.n.x,a=p.n.y;if(K[0][0].getIntersectionList){var i=K[0][0].createSVGRect();i.x=o,i.y=a,i.width=1,i.height=1,e=K[0][0].getIntersectionList(i,K[0][0])}else e=RED.view.getLinksAtPoint(o,a);for(var s=0;s<e.length;s++)if(d3.select(e[s]).classed("link_background"))for(var r=e[s].getTotalLength(),d=0;d<r;d+=10){var l=e[s].getPointAtLength(d),c=(l.x-o)*(l.x-o)+(l.y-a)*(l.y-a);c<200&&c<t&&(t=c,n=e[s])}k&&k!==n&&d3.select(k.parentNode).classed("link_splice",!1),n?d3.select(n.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),k=n,_=null},100))))}0!==G&&_e()}}function a(){var e,t;if(G!==RED.state.QUICK_JOINING){if(z&&G==RED.state.JOINING){var n=[];for(e=0;e<Y.length;e++)Y[e].link&&n.push(Y[e].link);t={t:"delete",links:n,dirty:RED.nodes.dirty()},RED.history.push(t),w()}if(q){var o=parseInt(q.attr("x")),a=parseInt(q.attr("y")),i=o+parseInt(q.attr("width")),s=a+parseInt(q.attr("height"));d3.event.ctrlKey||ae(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>o&&e.x<i&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,F.push({n:e})))}),D&&(D.in.forEach(function(e){e.selected=e.x>o&&e.x<i&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,F.push({n:e}))}),D.out.forEach(function(e){e.selected=e.x>o&&e.x<i&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,F.push({n:e}))})),se(),q.remove(),q=null}else G!=RED.state.DEFAULT||null!=f||d3.event.ctrlKey||d3.event.metaKey||(ae(),se());if(G==RED.state.MOVING_ACTIVE&&0<F.length){for(var r=[],d=0;d<F.length;d++){var l=F[d];l.ox===l.n.x&&l.oy===l.n.y||(r.push({n:l.n,ox:l.ox,oy:l.oy,moved:l.n.moved}),l.n.dirty=!0,l.n.moved=!0)}if(0<r.length){if(t={t:"move",nodes:r,dirty:RED.nodes.dirty()},k){var c=d3.select(k).data()[0];RED.nodes.removeLink(c);var p={source:c.source,sourcePort:c.sourcePort,target:F[0].n},u={source:F[0].n,sourcePort:0,target:c.target};RED.nodes.addLink(p),RED.nodes.addLink(u),t.links=[p,u],t.removedLinks=[c],X()}RED.nodes.dirty(!0),RED.history.push(t)}}if(G==RED.state.MOVING||G==RED.state.MOVING_ACTIVE)for(e=0;e<F.length;e++)delete F[e].ox,delete F[e].oy;G==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),X(),RED.nodes.dirty(!0)),ge(),_e()}}function ee(){c<2&&(c+=.1,_e())}function te(){.3<c&&(c-=.1,_e())}function ne(){c=1,_e()}function oe(){RED.nodes.eachNode(function(e){e.z==RED.workspaces.active()&&(e.selected||(e.selected=!0,e.dirty=!0,F.push({n:e})))}),D&&(D.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,F.push({n:e}))}),D.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,F.push({n:e}))})),A=null,se(),_e()}function ae(){for(var e=0;e<F.length;e++){var t=F[e];t.n.dirty=!0,t.n.selected=!1}F=[],A=null}var ie=null;function se(){var e={};0<F.length&&(e.nodes=F.map(function(e){return e.n})),null!=A&&(e.link=A);var t=RED.workspaces.active();d=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var n={};l=[];for(var o=0;o<F.length;o++)if("link out"===F[o].n.type||"link in"===F[o].n.type){var a=F[o].n,i={};a.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link out"===a.type?t.z===a.z?n[a.id+":"+t.id]||(d.push({source:a,sourcePort:0,target:t,link:!0}),n[a.id+":"+t.id]=!0):(i[t.z]=i[t.z]||[],i[t.z].push(t)):t.z===a.z?n[t.id+":"+a.id]||(d.push({source:t,sourcePort:0,target:a,link:!0}),n[t.id+":"+a.id]=!0):(i[t.z]=i[t.z]||[],i[t.z].push(t)))}),0<Object.keys(i).length&&l.push({refresh:Math.floor(1e4*Math.random()),node:a,links:i})}var s=t+":"+JSON.stringify(e,function(e,t){return"nodes"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t});s!==ie&&(ie=s,RED.events.emit("view:selection-changed",e))}function re(){if(de=!1,0<F.length){for(var e=[],t=0;t<F.length;t++)e.push({n:F[t].n,ox:F[t].ox,oy:F[t].oy,moved:F[t].n.moved}),F[t].n.moved=!0,F[t].n.dirty=!0,delete F[t].ox,delete F[t].oy;_e(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}var de=!1;function le(e,t){if(0<F.length){de||($(document).one("keyup",re),de=!0);for(var n,o=0,a=0,i=0;i<F.length;i++)(n=F[i]).n.moved=!0,n.n.dirty=!0,null==n.ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y),n.n.x+=e,n.n.y+=t,n.n.dirty=!0,o=Math.min(n.n.x-n.n.w/2-5,o),a=Math.min(n.n.y-n.n.h/2-5,a);if(0!==o||0!==a)for(var s=0;s<F.length;s++)(n=F[s]).n.x-=o,n.n.y-=a;_e()}}function ce(){if(0<F.length){var e=F[0].n;"subflow"===e.type?RED.editor.editSubflow(D):RED.editor.edit(e)}}function pe(){if(0<F.length||null!=A){var e,t=[],n=[],o=[],a=[],i=[],s=RED.nodes.dirty();if(0<F.length){for(var r=0;r<F.length;r++){var d=F[r].n;if(d.selected=!1,"subflow"!=d.type){d.x<0&&(d.x=25);var l=RED.nodes.remove(d.id);t.push(d),t=t.concat(l.nodes),n=n.concat(l.links)}else"out"===d.direction?o.push(d):"in"===d.direction&&a.push(d),d.dirty=!0}0<o.length&&(e=RED.subflow.removeOutput(o))&&(n=n.concat(e.links)),1==a.length&&(e=RED.subflow.removeInput())&&(n=n.concat(e.links));var c=RED.subflow.refresh(!0);c&&(i=c.instances),F=[],(0<t.length||0<o.length||0<a.length)&&RED.nodes.dirty(!0)}A&&(RED.nodes.removeLink(A),n.push(A),RED.nodes.dirty(!0));var p={t:"delete",nodes:t,links:n,subflowOutputs:o,subflowInputs:a,subflow:{instances:i},dirty:s};RED.history.push(p),A=null,X(),se(),_e()}}function ue(){if(0<F.length){for(var e=[],t=0;t<F.length;t++){var n=F[t].n;if("subflow"!=n.type){for(var o in n._def.defaults)if(n._def.defaults.hasOwnProperty(o)&&n._def.defaults[o].type){var a=RED.nodes.node(n[o]);a&&a._def.exclusive&&e.push(RED.nodes.convertNode(a))}e.push(RED.nodes.convertNode(n))}}i=JSON.stringify(e),RED.notify(RED._("clipboard.nodeCopied",{count:e.length}))}}function fe(e,t,n){return he(e,t,n,0)[0]}function he(e,t,n,o){var a=document.createElement("span");a.className=t,a.style.position="absolute",a.style.top="-1000px",a.textContent=e||"",document.body.appendChild(a);var i=a.offsetWidth,s=a.offsetHeight;return document.body.removeChild(a),[n+i,o+s]}function ge(){G=0,k=M=f=h=z=null,I=!1,d3.select(".link_splice").classed("link_splice",!1),_&&(clearTimeout(_),_=null)}function ve(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(ge(),w(),_e(),$(window).off("keyup",ve))}function me(e,t,n){z=e,M=t,B=n||0,G!==RED.state.QUICK_JOINING&&(G=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(G=RED.state.QUICK_JOINING,Z([{node:z,port:B,portType:M}]),$(window).on("keyup",ve))),d3.event.stopPropagation(),d3.event.preventDefault()}function be(e,o,a){var t;if(!(G===RED.state.QUICK_JOINING&&0<Y.length&&Y[0].node===e)&&(document.body.style.cursor="",G==RED.state.JOINING||G==RED.state.QUICK_JOINING)){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var t=e.w/2,n=e.h/2;e.x-t<U[0]&&e.x+t>U[0]&&e.y-n<U[1]&&e.y+n>U[1]&&(o=0<(h=e).inputs?W:H,a=0)}}):h=e;var n=[],i=[];for(t=0;t<Y.length;t++)Y[t].link&&i.push(Y[t].link);for(t=0;t<Y.length;t++)if(o!=Y[t].portType&&h!==Y[t].node){var s,r,d,l=Y[t];if(l.portType===H?(s=l.node,d=l.port,r=h):l.portType===W&&(s=h,r=l.node,d=a),!(0!==RED.nodes.filterLinks({source:s,target:r,sourcePort:d}).length)){var c={source:s,sourcePort:d,target:r};RED.nodes.addLink(c),n.push(c)}}if(0<n.length||0<i.length){var p={t:"add",links:n,removedLinks:i,dirty:RED.nodes.dirty()};if(D){var u=RED.subflow.refresh(!0);u&&(p.subflow={id:D.id,changed:D.changed,instances:u.instances})}RED.history.push(p),X(),RED.nodes.dirty(!0)}if(G===RED.state.QUICK_JOINING)return 0<n.length&&(w(),o===W&&0<e.outputs?Z([{node:e,port:0,portType:H}]):o===H&&0<e.inputs?Z([{node:e,port:0,portType:W}]):ge()),void _e();ge(),w(),A=null,_e()}}var ye=null,we=null;function De(l,c,p,u){clearTimeout(ye);var e=G!=RED.state.JOINING||0<Y.length&&Y[0].portType!==p;e&&(p===W&&(c._def&&c._def.inputLabels||c.inputLabels)||p===H&&(c._def&&c._def.outputLabels||c.outputLabels))&&(ye=setTimeout(function(){var e=function(t,n,e){var o,a=n===W?t.inputLabels:t.outputLabels;if(a&&a[e])return a[e];var i=n===W?t._def.inputLabels:t._def.outputLabels;if("string"==typeof i)o=i;else if("function"==typeof i)try{o=i.call(t,e)}catch(e){console.log("Definition error: "+t.type+"."+(n===W?"inputLabels":"outputLabels"),e),o=null}else $.isArray(i)&&(o=i[e]);return o}(c,p,u);if(e){var t=function e(t){var n=d3.select(t);if("innerCanvas"===n.attr("class"))return[0,0];var o=[0,0];if("g"===t.nodeName.toLowerCase()){var a=n.attr("transform");a&&(o=d3.transform(a).translate)}else o=[n.attr("x")||0,n.attr("y")||0];var i=e(t.parentNode);return[o[0]+i[0],o[1]+i[1]]}(l.node());ye=null,we=x.append("g").attr("transform","translate("+(t[0]+(p===W?-2:12))+","+(t[1]+5)+")").attr("class","port_tooltip");var n=e.split("\n"),o=0,a=4,i=[];n.forEach(function(e){var t=he(e,"port_tooltip_label",8,0);o=Math.max(o,t[0]),i.push(.8*t[1]),a+=.8*t[1]});var s=a/2-5-2,r=a-4;we.append("path").attr("d",p===W?"M0 0 l -5 -5 v -"+s+" q 0 -2 -2 -2 h -"+o+" q -2 0 -2 2 v "+r+" q 0 2 2 2 h "+o+" q 2 0 2 -2 v -"+s+" l 5 -5":"M0 0 l 5 -5 v -"+s+" q 0 -2 2 -2 h "+o+" q 2 0 2 2 v "+r+" q 0 2 -2 2 h -"+o+" q -2 0 -2 -2 v -"+s+" l -5 -5");var d=-a/2-2;n.forEach(function(e,t){d+=i[t],we.append("svg:text").attr("class","port_tooltip_label").attr("x",p===W?-10:10).attr("y",d).attr("text-anchor",p===W?"end":"start").text(e)})}},500)),l.classed("port_hovered",e)}function Ee(e,t,n,o){clearTimeout(ye),we&&(we.remove(),we=null),e.classed("port_hovered",!1)}function $e(e){if(u&&z==e&&0<V&&V<750)return G=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(D),V=0,void d3.event.stopPropagation();be(e,e._def?0<e.inputs?1:0:"in"==e.direction?0:1,0)}function Re(e){if(Ce(),G==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),k){var t=d3.select(k).data()[0];RED.nodes.removeLink(t);var n={source:t.source,sourcePort:t.sourcePort,target:F[0].n},o={source:F[0].n,sourcePort:0,target:t.target};RED.nodes.addLink(n),RED.nodes.addLink(o);var a=RED.history.peek();a.links=[n,o],a.removedLinks=[t],X()}return se(),RED.nodes.dirty(!0),_e(),ge(),void d3.event.stopPropagation()}if(G!=RED.state.QUICK_JOINING){z=e;var i,s=Date.now();if(V=s-y,y=s,u=p==z,p=z,e.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(z.selected=!1,i=0;i<F.length;i+=1)if(F[i].n===z){F.splice(i,1);break}}else{if(d3.event.shiftKey){ae();for(var r=RED.nodes.getAllFlowNodes(z),d=0;d<r.length;d++)r[d].selected=!0,r[d].dirty=!0,F.push({n:r[d]})}else e.selected||(d3.event.ctrlKey||d3.event.metaKey||ae(),z.selected=!0,F.push({n:z}));if(A=null,2!=d3.event.button){G=RED.state.MOVING;var l=d3.touches(this)[0]||d3.mouse(this);for(l[0]+=e.x-e.w/2,l[1]+=e.y-e.h/2,i=0;i<F.length;i++)F[i].ox=F[i].n.x,F[i].oy=F[i].n.y,F[i].dx=F[i].n.x-l[0],F[i].dy=F[i].n.y-l[1];J=d3.mouse(document.body),isNaN(J[0])&&(J=d3.touches(document.body)[0])}}e.dirty=!0,se(),_e(),d3.event.stopPropagation()}else d3.event.stopPropagation()}function xe(e){var t=!0;return e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function Te(t){if(D)RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(t._def.button.toggle&&(t[t._def.button.toggle]=!t[t._def.button.toggle],t.dirty=!0),t._def.button.onclick)try{t._def.button.onclick.call(t)}catch(e){console.log("Definition error: "+t.type+".onclick",e)}t.dirty&&_e()}d3.event.preventDefault()}function ke(e,t){var n=z,o=[];o.push({name:"delete",disabled:0===F.length&&null===A,onselect:function(){pe()}}),o.push({name:"cut",disabled:0===F.length,onselect:function(){ue(),pe()}}),o.push({name:"copy",disabled:0===F.length,onselect:function(){ue()}}),o.push({name:"paste",disabled:0===i.length,onselect:function(){je(i,!1,!0)}}),o.push({name:"edit",disabled:1!=F.length,onselect:function(){RED.editor.edit(n)}}),o.push({name:"select",onselect:function(){oe()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,o),ge()}function _e(){if(x.attr("transform","scale("+c+")"),K.attr("width",C*c).attr("height",j*c),G!=RED.state.JOINING){var w={};if(D){var e=x.selectAll(".subflowoutput").data(D.out,function(e,t){return e.id});e.exit().remove();var t=e.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});t.each(function(e,t){e.w=40,e.h=40}),t.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",$e).on("mousedown",Re).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];m=[n.pageX,n.pageY],v=0,b=setTimeout(function(){ke(t,o)},g),Re.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():$e.call(this,e)}),t.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){me(e,W,0)}).on("touchstart",function(e,t){me(e,W,0)}).on("mouseup",function(e,t){be(e,W,0)}).on("touchend",function(e,t){be(e,W,0)}).on("mouseover",function(e){De(d3.select(this),e,W,0)}).on("mouseout",function(e){Ee(d3.select(this))}),t.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),t.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1});var n=x.selectAll(".subflowinput").data(D.in,function(e,t){return e.id});n.exit().remove();var o=n.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});o.each(function(e,t){e.w=40,e.h=40}),o.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",$e).on("mousedown",Re).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];m=[n.pageX,n.pageY],v=0,b=setTimeout(function(){ke(t,o)},g),Re.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():$e.call(this,e)}),o.append("g").attr("transform","translate(35,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){me(e,H,t)}).on("touchstart",function(e,t){me(e,H,t)}).on("mouseup",function(e,t){be(e,H,t)}).on("touchend",function(e,t){be(e,H,t)}).on("mouseover",function(e){De(d3.select(this),e,H,0)}).on("mouseout",function(e){Ee(d3.select(this))}),o.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),e.each(function(e,t){if(e.dirty){var n=d3.select(this);n.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),n.selectAll(".port_index").text(function(e){return e.i+1}),n.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),(w[e.id]=e).dirty=!1}}),n.each(function(e,t){if(e.dirty){var n=d3.select(this);n.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),n.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),(w[e.id]=e).dirty=!1}})}else x.selectAll(".subflowoutput").remove(),x.selectAll(".subflowinput").remove();var a=x.selectAll(".nodegroup").data(r,function(e){return e.id});a.exit().remove(),a.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(e){return null!=D}).classed("node_link",function(e){return"link in"===e.type||"link out"===e.type}).each(function(e,t){var n=d3.select(this),o="link in"===e.type||"link out"===e.type;n.attr("id",e.id);var a=RED.utils.getNodeLabel(e);if(e.w=o?L:Math.max(O,20*Math.ceil((fe(a,"node_label",50)+(0<e._def.inputs?7:0))/20)),e.h=Math.max(L,15*(e.outputs||0)),e._def.badge){var i=n.append("svg:g").attr("class","node_badge_group"),s=i.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);i.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(e._def.badge()),e._def.onbadgeclick&&s.attr("cursor","pointer").on("click",function(e){e._def.onbadgeclick.call(e),d3.event.preventDefault()})}if(e._def.button){var r=n.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class",function(e){return"node_button "+("right"==e._def.align?"node_right_button":"node_left_button")});r.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",L-4).attr("fill","#eee"),r.append("rect").attr("class","node_button_button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",L-12).attr("fill",function(e){return e._def.color}).attr("cursor","pointer").on("mousedown",function(e){!q&&xe(e)&&(Ce(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!q&&xe(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!q&&xe(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!q&&xe(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",Te).on("touchstart",Te)}n.append("rect").attr("class","node").classed("node_unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return e._def.color}).on("mouseup",$e).on("mousedown",Re).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];m=[n.pageX,n.pageY],v=0,b=setTimeout(function(){ke(t,o)},g),Re.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():$e.call(this,e)}).on("mouseover",function(e){0===G&&d3.select(this).classed("node_hovered",!0)}).on("mouseout",function(e){d3.select(this).classed("node_hovered",!1)});if(e._def.icon){var d=RED.utils.getNodeIcon(e._def,e),l=n.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),c=(l.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(e){return Math.min(50,e.h-4)}),l.append("image").attr("xlink:href",d).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),p=l.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==e._def.align&&(l.attr("class","node_icon_group node_icon_group_"+e._def.align),p.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)}));var u=new Image;u.src=d,u.onload=function(){c.attr("width",Math.min(u.width,30)),c.attr("height",Math.min(u.height,30)),c.attr("x",15-Math.min(u.width,30)/2)},l.style("pointer-events","none")}if(!o){var f=n.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".35em").attr("text-anchor","start");e._def.align&&(f.attr("class","node_label node_label_"+e._def.align),"right"===e._def.align&&f.attr("text-anchor","end"));var h=n.append("svg:g").attr("class","node_status_group").style("display","none");h.append("rect").attr("class","node_status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),h.append("svg:text").attr("class","node_status_label").attr("x",20).attr("y",9)}n.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-red/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),n.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-red/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),a.each(function(e,t){if(e.dirty){var n="link in"===e.type||"link out"===e.type;if(w[e.id]=e,!n&&e.resize){var o=RED.utils.getNodeLabel(e),a=e.w;e.w=Math.max(O,20*Math.ceil((fe(o,"node_label",50)+(0<e._def.inputs?7:0))/20)),e.h=Math.max(L,15*(e.outputs||0)),e.x+=(e.w-a)/2,e.resize=!1}var i=d3.select(this);if(i.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),G!=RED.state.MOVING_ACTIVE){i.selectAll(".node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("node_selected",function(e){return e.selected}).classed("node_highlighted",function(e){return e.highlighted}),i.selectAll(".node_icon_group_right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),i.selectAll(".node_label_right").attr("x",function(e){return e.w-38});var s=i.selectAll(".port_input");if(0!==e.inputs||s.empty()){if(1===e.inputs&&s.empty()){i.append("g").attr("class","port_input").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e){me(e,W,0)}).on("touchstart",function(e){me(e,W,0)}).on("mouseup",function(e){be(e,W,0)}).on("touchend",function(e){be(e,W,0)}).on("mouseover",function(e){De(d3.select(this),e,W,0)}).on("mouseout",function(e){Ee(d3.select(this))})}}else s.remove();var r=e.outputs,d=e.h/2-(r-1)/2*13;if(e.ports=e.ports||d3.range(r),e._ports=i.selectAll(".port_output").data(e.ports),e._ports.enter().append("g").attr("class","port_output").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(y=e,function(e,t){me(y,H,t)})).on("touchstart",(b=e,function(e,t){me(b,H,t)})).on("mouseup",(m=e,function(e,t){be(m,H,t)})).on("touchend",(v=e,function(e,t){be(v,H,t)})).on("mouseover",(g=e,function(e,t){De(d3.select(this),g,H,t)})).on("mouseout",function(e,t){Ee(d3.select(this))}),e._ports.exit().remove(),e._ports){r=e.outputs||1,d=e.h/2-(r-1)/2*13;var l=e.w-5;e._ports.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+l+","+(d+13*t-5)+")"})})}if(i.selectAll("text.node_label").text(function(t,e){var n="";if(t._def.label){n=t._def.label;try{n=("function"==typeof n?n.call(t):n)||"",n=RED.text.bidi.enforceTextDirectionWithUCC(n)}catch(e){console.log("Definition error: "+t.type+".label",e),n=t.type}}return n}).attr("y",function(e){return e.h/2-1}).attr("class",function(t){var n="";if(t._def.labelStyle){n=t._def.labelStyle;try{n=("function"==typeof n?n.call(t):n)||""}catch(e){console.log("Definition error: "+t.type+".labelStyle",e),n=""}n=" "+n}return"node_label"+(t._def.align?" node_label_"+t._def.align:"")+n}),e._def.icon){icon=i.select(".node_icon");var c=icon.attr("xlink:href"),p=RED.utils.getNodeIcon(e._def,e);if(p!==c){icon.attr("xlink:href",p);var u=new Image;u.src=p,u.onload=function(){icon.attr("width",Math.min(u.width,30)),icon.attr("height",Math.min(u.height,30)),icon.attr("x",15-Math.min(u.width,30)/2)}}}i.selectAll(".node_tools").attr("x",function(e){return e.w-35}).attr("y",function(e){return e.h-20}),i.selectAll(".node_changed").attr("x",function(e){return e.w-10}).classed("hidden",function(e){return!(e.changed||e.moved)}),i.selectAll(".node_error").attr("x",function(e){return e.w-10-(e.changed||e.moved?13:0)}).classed("hidden",function(e){return e.valid}),i.selectAll(".port_input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),i.selectAll(".node_icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),i.selectAll(".node_icon_shade").attr("height",function(e){return e.h}),i.selectAll(".node_icon_shade_border").attr("d",function(e){return"M "+("right"==e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),i.selectAll(".node_button").attr("opacity",function(e){return D||!xe(e)?.4:1}),i.selectAll(".node_button_button").attr("cursor",function(e){return D||!xe(e)?"":"pointer"}),i.selectAll(".node_right_button").attr("transform",function(e){var t=e.w-6;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-=8),"translate("+t+",2)"}),i.selectAll(".node_right_button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),i.selectAll(".node_badge_group").attr("transform",function(e){return"translate("+(e.w-40)+","+(e.h+3)+")"}),i.selectAll("text.node_badge_label").text(function(t,e){if(t._def.badge){if("function"!=typeof t._def.badge)return t._def.badge;try{return t._def.badge.call(t)}catch(e){return console.log("Definition error: "+t.type+".badge",e),""}}return""})}if(E&&e.status){i.selectAll(".node_status_group").style("display","inline").attr("transform","translate(3,"+(e.h+3)+")");var f,h=R[e.status.fill];if(null==e.status.shape&&null==h)i.selectAll(".node_status").style("display","none");else null==e.status.shape||"dot"==e.status.shape?f={display:"inline",fill:h,stroke:h}:"ring"==e.status.shape&&(f={display:"inline",fill:"#fff",stroke:h}),i.selectAll(".node_status").style(f);e.status.text?i.selectAll(".node_status_label").text(e.status.text):i.selectAll(".node_status_label").text("")}else i.selectAll(".node_status_group").style("display","none");e.dirty=!1}var g,v,m,b,y});var i=x.selectAll(".link").data(d,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i});i.enter().insert("g",".node").attr("class","link").each(function(e,t){var n=d3.select(this);e.added=!0,n.append("svg:path").attr("class","link_background link_path").on("mousedown",function(e){f=e,ae(),A=f,se(),_e(),Ce(),d3.event.stopPropagation()}).on("touchstart",function(e){f=e,ae(),A=f,se(),_e(),Ce(),d3.event.stopPropagation();var t=d3.select(document.body),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];b=setTimeout(function(){b=null,ke(t,o)},g)}),n.append("svg:path").attr("class","link_outline link_path"),n.append("svg:path").attr("class","link_line link_path").classed("link_link",function(e){return e.link}).classed("link_subflow",function(e){return!e.link&&D})}),i.exit().remove(),x.selectAll(".link_path").each(function(e){var t=d3.select(this);(e.added||e===A||e.selected||w[e.source.id]||w[e.target.id])&&t.attr("d",function(e){var t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0),n=e.target.y-(e.source.y+t),o=e.target.x-e.target.w/2-(e.source.x+e.source.w/2),a=Math.sqrt(n*n+o*o),i=S,s=0;return a<O&&(i=.75-(O-a)/O*.75),o<0&&(i+=Math.min(5*O,Math.abs(o))/(5*O)*2,Math.abs(n)<3*L&&(s=(0<n?.5:-.5)*((3*L-Math.abs(n))/(3*L))*(Math.min(O,Math.abs(o))/O))),e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y,"M "+e.x1+" "+e.y1+" C "+(e.x1+i*O)+" "+(e.y1+s*L)+" "+(e.x2-i*O)+" "+(e.y2-s*L)+" "+e.x2+" "+e.y2})}),i.classed("link_selected",function(e){return e===A||e.selected}),i.classed("link_unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var s=x.selectAll(".link_flow_link_g").data(l,function(e){return e.node.id+":"+e.refresh});s.enter().insert("g",".node").attr("class","link_flow_link_g").each(function(n,e){var t=d3.select(this),a=1,i="start";"link in"===n.node.type&&(a=-1,i="end");var s=30*a,r=20*a,o=(t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+s),n.links),d=Object.keys(o),l=RED.nodes.getWorkspaceOrder();d.sort(function(e,t){return l.indexOf(e)-l.indexOf(t)});var c=L,p=-(d.length-1)*c/2,u=t.selectAll(".link_group").data(d);u.enter().append("g").attr("class","link_group").on("mouseover",function(){d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(e){d3.event.stopPropagation();var t=n.links[e];RED.workspaces.show(e),t.forEach(function(e){e.selected=!0,e.dirty=!0,F.push({n:e})}),se(),_e()}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+s+" 0 C "+(s+1.7*r)+" 0 "+(s+.1*r)+" "+p+" "+(s+1.5*r)+" "+p+" "),t.append("svg:path").attr("class","link_port").attr("d","M "+(s+1.5*r+17*a)+" "+(p-12)+" h "+10*-a+" a 3 3 45 0 "+(1===a?"0":"1")+" "+-3*a+" 3 v 18 a 3 3 45 0 "+(1===a?"0":"1")+" "+3*a+" 3 h "+10*a),t.append("svg:path").attr("class","link_port").attr("d","M "+(s+1.5*r+20*a)+" "+(p-12)+" h "+30*a+" M "+(s+1.5*r+20*a)+" "+(p+12)+" h "+30*a).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","port link_port").attr("x",s+1.5*r-4+4*a).attr("y",p-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",s+1.5*r-(-1===a?O:0)).attr("y",p-12).attr("width",O).attr("height",24).style("stroke","none").style("fill","transparent");var n,o=RED.nodes.workspace(e);o&&(n=o.label||o.id),t.append("svg:text").attr("class","port_label").attr("x",s+1.5*r+15*a).attr("y",p+1).style("font-size","10px").style("text-anchor",i).text(n),p+=c}),u.exit().remove()}),s.exit().remove(),(s=x.selectAll(".link_flow_link_g")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else x.selectAll(".link_selected").data(d,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("link_selected",!1);d3.event&&d3.event.preventDefault()}function Ce(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(e,t)}catch(e){$("#chart").focus()}}function je(e,t,n){try{var o;D&&(o=D.changed);var a=RED.nodes.import(e,!0,t);if(a){var i=a[0],s=a[1],r=a[2],d=a[3],l=a[4];t&&l&&RED.workspaces.show(l.id);var c=i.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),p=i.map(function(e){return e.id});if(0<c.length){var u=c[0].n,f=u.x,h=u.y;null==U&&(U=[0,0]);var g,v,m=0,b=0;for(g=0;g<c.length;g++)(v=c[g]).n.selected=!0,v.n.changed=!0,v.n.moved=!0,v.n.x-=f-U[0],v.n.y-=h-U[1],v.dx=v.n.x-U[0],v.dy=v.n.y-U[1],m=Math.min(v.n.x-O/2-5,m),b=Math.min(v.n.y-L/2-5,b);for(g=0;g<c.length;g++)if((v=c[g]).n.x-=m,v.n.y-=b,v.dx-=m,v.dy-=b,v.n._def.onadd)try{v.n._def.onadd.call(v.n)}catch(e){console.log("Definition error: "+v.n.type+".onadd:",e)}n||(G=RED.state.IMPORT_DRAGGING,I=!1,1===c.length&&(v=c[0],I=v.n.hasOwnProperty("_def")&&0<v.n._def.inputs&&0<v.n._def.outputs)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),ae(),RED.history.pop(),G=0}),ae(),F=c}var y={t:"add",nodes:p,links:s,workspaces:r,subflows:d,dirty:RED.nodes.dirty()};if(0===c.length&&RED.nodes.dirty(!0),D){var w=RED.subflow.refresh(!0);w&&(y.subflow={id:D.id,changed:o,instances:w.instances})}RED.history.push(y),X(),_e()}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}return{init:function(){RED.events.on("workspace:change",function(e){var t=$("#chart");0!==e.old&&(s[e.old]={left:t.scrollLeft(),top:t.scrollTop()});var n=t.scrollLeft(),o=t.scrollTop();D=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",D),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||D),s[e.workspace]?(t.scrollLeft(s[e.workspace].left),t.scrollTop(s[e.workspace].top)):(t.scrollLeft(0),t.scrollTop(0));var a=t.scrollLeft()-n,i=t.scrollTop()-o;null!=U&&(U[0]+=a,U[1]+=i),ae(),RED.nodes.eachNode(function(e){e.dirty=!0}),se(),X(),_e()}),$("#btn-zoom-out").click(function(){te()}),$("#btn-zoom-zero").click(function(){ne()}),$("#btn-zoom-in").click(function(){ee()}),$("#chart").on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?te():ee())}),$("#chart").droppable({accept:".palette_node",drop:function(e,t){d3.event=e;var n=T(t.draggable[0].type);if(n){var o=n.historyEvent,a=n.node,i=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),s=d3.touches(this)[0]||d3.mouse(this);s[1]+=this.scrollTop+(a.h/2-i[1]),s[0]+=this.scrollLeft+(a.w/2-i[0]),s[1]/=c,s[0]/=c,N&&(s[0]=P*Math.ceil(s[0]/P),s[1]=P*Math.ceil(s[1]/P)),a.x=s[0],a.y=s[1];var r=$(t.helper).data("splice");if(r){RED.nodes.removeLink(r);var d={source:r.source,sourcePort:r.sourcePort,target:a},l={source:a,sourcePort:0,target:r.target};RED.nodes.addLink(d),RED.nodes.addLink(l),o.links=[d,l],o.removedLinks=[r]}RED.history.push(o),RED.nodes.add(a),RED.editor.validateNode(a),RED.nodes.dirty(!0),ae(),a.selected=!0,F.push({n:a}),X(),se(),_e(),a._def.autoedit&&RED.editor.edit(a)}}}),$("#chart").focus(function(){$("#workspace-tabs").addClass("workspace-focussed")}),$("#chart").blur(function(){$("#workspace-tabs").removeClass("workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",ue),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){ue(),pe()}),RED.actions.add("core:paste-from-internal-clipboard",function(){je(i)}),RED.actions.add("core:delete-selection",pe),RED.actions.add("core:edit-selected-node",ce),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:select-all-nodes",oe),RED.actions.add("core:zoom-in",ee),RED.actions.add("core:zoom-out",te),RED.actions.add("core:zoom-reset",ne),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):e?n.style("visibility","visible"):n.style("visibility","hidden")}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):(N=e,_e())}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(E=e,RED.nodes.eachNode(function(e){e.dirty=!0}),_e())}),RED.actions.add("core:move-selection-up",function(){le(0,-1)}),RED.actions.add("core:step-selection-up",function(){le(0,-20)}),RED.actions.add("core:move-selection-right",function(){le(1,0)}),RED.actions.add("core:step-selection-right",function(){le(20,0)}),RED.actions.add("core:move-selection-down",function(){le(0,1)}),RED.actions.add("core:step-selection-down",function(){le(0,20)}),RED.actions.add("core:move-selection-left",function(){le(-1,0)}),RED.actions.add("core:step-selection-left",function(){le(-20,0)})},state:function(e){if(null==e)return G;G=e},redraw:function(e){e&&(X(),se()),_e()},focus:Ce,importNodes:je,calculateTextWidth:fe,select:function(e){if(void 0!==e&&(ae(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,F=[{n:t}])}se(),_e()},selection:function(){var e={};return 0<F.length&&(e.nodes=F.map(function(e){return e.n})),null!=A&&(e.link=A),e},scale:function(){return c},getLinksAtPoint:function(e,t){for(var n=[],o=K.selectAll(".link_background")[0],a=0;a<o.length;a++){var i=o[a].getBBox();e>=i.x&&t>=i.y&&e<=i.x+i.width&&t<=i.y+i.height&&n.push(o[a])}return n},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z);var n=[$("#chart").width(),$("#chart").height()],o=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(t.x<o[0]||t.y<o[1]||t.x>n[0]+o[0]||t.y>n[1]+o[1]){var a="-="+(o[0]-t.x+n[0]/2),i="-="+(o[1]-t.y+n[1]/2);$("#chart").animate({scrollLeft:a,scrollTop:i},200)}if(!t._flashing){t._flashing=!0;var s=22,r=function(){s--,t.dirty=!0,0<=s?(t.highlighted=!t.highlighted,setTimeout(r,100)):(t.highlighted=!1,delete t._flashing),RED.view.redraw()};r()}}else"config"===t._def.category&&RED.sidebar.config.show(e)}},gridSize:function(e){if(void 0===e)return P;P=Math.max(5,e),t()}}}(),RED.sidebar=function(){var i=RED.tabs.create({id:"sidebar-tabs",onchange:function(e){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},minimumActiveTabWidth:70}),s={};var r={};function t(e){e?($("#main-container").removeClass("sidebar-closed"),i.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function d(e){e&&(n(e)||i.addTab(s[e]),i.activateTab(e),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function n(e){return i.contains(e)}return $("#sidebar-separator").draggable({axis:"x",start:function(e,t){r.closing=!1,r.opening=!1;var n=$(window).width();if(r.start=t.position.left,r.chartWidth=$("#workspace").width(),r.chartRight=n-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){r.opening=!0;$("#sidebar").addClass("closing"),$("#workspace").css("right",7),$("#editor-stack").css("right",8),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}r.width=$("#sidebar").width()},drag:function(e,t){var n=t.position.left-r.start,o=r.width-n;r.opening&&(o-=3),150<o&&r.chartWidth+n<200&&(t.position.left=200+r.start-r.chartWidth,n=t.position.left-r.start,o=r.width-n),o<150?(r.closing||($("#sidebar").addClass("closing"),r.closing=!0),r.opening||(o=150,t.position.left=r.width-(150-r.start),n=t.position.left-r.start)):150<o&&(r.closing||r.opening)&&(r.closing=!1,$("#sidebar").removeClass("closing"));var a=r.chartRight-n;$("#workspace").css("right",a),$("#editor-stack").css("right",a+1),$("#sidebar").width(o),i.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){r.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:function(){RED.actions.add("core:toggle-sidebar",function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):t(e)}),d(),RED.sidebar.info.init(),RED.sidebar.config.init(),$(window).width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(e,t,n,o){var a;"string"==typeof e?a={id:t.id,label:e,name:e,content:t,closeable:n,visible:o}:"object"==typeof e&&(a=e),a.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),a.wrapper.append(a.content),a.wrapper.hide(),a.enableOnEdit||(a.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(a.wrapper)),a.toolbar&&($("#sidebar-footer").append(a.toolbar),$(a.toolbar).hide()),a.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+a.id,label:a.name,onselect:function(){d(a.id)},group:"sidebar-tabs"}),!1!==(s[a.id]=a).visible&&i.addTab(s[a.id])},removeTab:function(e){i.removeTab(e),$(s[e].wrapper).remove(),s[e].footer&&s[e].footer.remove(),delete s[e],RED.menu.removeItem("menu-item-view-menu-"+e)},show:d,containsTab:n,toggleSidebar:t}}(),RED.palette=function(){var R=["config","unknown","deprecated"],x=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],T={};function k(t,e){e=(e||t).replace(/_/g," ");var n=$('<div id="palette-container-'+t+'" class="palette-category palette-close hide"><div id="palette-header-'+t+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+e+'</span></div><div class="palette-content" id="palette-base-category-'+t+'"><div id="palette-'+t+'-input"></div><div id="palette-'+t+'-output"></div><div id="palette-'+t+'-function"></div></div></div>').appendTo("#palette-container");T[t]={container:n,close:function(){n.removeClass("palette-open"),n.addClass("palette-closed"),$("#palette-base-category-"+t).slideUp(),$("#palette-header-"+t+" i").removeClass("expanded")},open:function(){n.addClass("palette-open"),n.removeClass("palette-closed"),$("#palette-base-category-"+t).slideDown(),$("#palette-header-"+t+" i").addClass("expanded")},toggle:function(){n.hasClass("palette-open")?T[t].close():T[t].open()}},$("#palette-header-"+t).on("click",function(e){T[t].toggle()})}function _(t,e,n,o){for(var a=n.split(/[ -]/),i=[],s=a[0],r=(RED.view.calculateTextWidth(s,"palette_label",0),1);r<a.length;r++){var d=RED.view.calculateTextWidth(s+" "+a[r],"palette_label",0);d<82?(s+=" "+a[r],d):(i.push(s),s=a[r],RED.view.calculateTextWidth(s,"palette_label",0))}i.push(s);var l,c=i.join("<br/>"),p=8+20*i.length;e.css({height:p+"px"}),e.find(".palette_label").html(c).attr("dir",RED.text.bidi.resolveBaseTextDir(c)),e.find(".palette_port").css({top:p/2-5+"px"});try{var u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b></p>";n!=t&&(u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b><br/><i>"+t+"</i></p>"),l=$(u+(o||($("script[data-help-name='"+t+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&0<this.textContent.trim().length}).slice(0,2)}catch(e){console.log("Error generating pop-over label for ",t),console.log(e.toString()),l="<p><b>"+n+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}e.data("popover").setContent(l)}function C(e){return e.replace(" ","_").replace(".","_").replace(":","_")}function n(t,n){var e=C(t);if(!$("#palette_node_"+e).length&&-1===R.indexOf(n.category)){var o=n.category.replace(/ /g,"_"),a=o.split("-")[0],i=document.createElement("div");i.id="palette_node_"+e,i.type=t;var s=/^(.*?)([ -]in|[ -]out)?$/.exec(t)[1];if(void 0!==n.paletteLabel)try{s=("function"==typeof n.paletteLabel?n.paletteLabel.call(n):n.paletteLabel)||""}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}if($("<div/>",{class:"palette_label"+("right"==n.align?" palette_label_right":"")}).appendTo(i),i.className="palette_node",n.icon){var r=RED.utils.getNodeIcon(n),d=$("<div/>",{class:"palette_icon_container"+("right"==n.align?" palette_icon_container_right":"")}).appendTo(i);$("<div/>",{class:"palette_icon",style:"background-image: url("+r+")"}).appendTo(d)}if(i.style.backgroundColor=n.color,0<n.outputs){var l=document.createElement("div");l.className="palette_port palette_port_output",i.appendChild(l)}if(0<n.inputs){var c=document.createElement("div");c.className="palette_port palette_port_input",i.appendChild(c)}if(0===$("#palette-base-category-"+a).length)if(-1!==x.indexOf(a))k(a,RED._("node-red:palette.label."+a,{defaultValue:a}));else{var p=n.set.id;k(a,RED._(p+":palette.label."+a,{defaultValue:a}))}$("#palette-container-"+a).show(),0===$("#palette-"+o).length&&$("#palette-base-category-"+a).append('<div id="palette-'+o+'"></div>'),$("#palette-"+o).append(i),i.onmousedown=function(e){e.preventDefault()};var u=RED.popover.create({target:$(i),trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});$(i).data("popover",u),$(i).click(function(){var e;RED.view.focus(),e=0===t.indexOf("subflow:")?marked(RED.nodes.subflow(t.substring(8)).info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>":$("script[data-help-name='"+i.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",RED.sidebar.info.set(e,RED._("sidebar.info.nodeHelp"))});var f,h,g,v,m,b,y=$("#chart"),w=y.offset(),D=$("#chart>svg").get(0);$(i).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){m=$("#palette").width(),b=$("#palette").parent().position().top+$("#palette-container").position().top,RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),v&&(clearTimeout(v),v=null)},drag:function(e,l){l.position.left+=17.5,0<n.inputs&&0<n.outputs&&(h=l.position.left-m+l.helper.width()/2-w.left+y.scrollLeft(),g=l.position.top-b+l.helper.height()/2-w.top+y.scrollTop(),v||(v=setTimeout(function(){var e=[],t=1/0,n=null;if(D.getIntersectionList){var o=D.createSVGRect();o.x=h,o.y=g,o.width=1,o.height=1,e=D.getIntersectionList(o,D),h/=RED.view.scale(),g/=RED.view.scale()}else h/=RED.view.scale(),g/=RED.view.scale(),e=RED.view.getLinksAtPoint(h,g);for(var a=0;a<e.length;a++)if(d3.select(e[a]).classed("link_background"))for(var i=e[a].getTotalLength(),s=0;s<i;s+=10){var r=e[a].getPointAtLength(s),d=(r.x-h)*(r.x-h)+(r.y-g)*(r.y-g);d<200&&d<t&&(t=d,n=e[a])}f&&f!==n&&d3.select(f.parentNode).classed("link_splice",!1),n?d3.select(n.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),f!==n&&(n?$(l.helper).data("splice",d3.select(n).data()[0]):$(l.helper).removeData("splice")),f=n,v=null},200)))}});var E=null;"subflows"==n.category&&($(i).dblclick(function(e){RED.workspaces.show(t.substring(8)),e.preventDefault()}),E=marked(n.info||"")),_(t,$(i),s,E),1===$("#palette-container-"+o).find(".palette_node").length&&T[o].open()}}function o(e){var t=C(e),n=$("#palette_node_"+t),o=n.closest(".palette-category");n.remove(),0===o.find(".palette_node").length&&o.find("i").hasClass("expanded")&&(o.find(".palette-content").slideToggle(),o.find("i").toggleClass("expanded"))}function a(e){var t=C(e),n=$("#palette_node_"+t);n.hide();for(var o=n.closest(".palette-category"),a=o.find(".palette_node"),i=0,s=0;s<a.length;s++)"none"===$(a[s]).css("display")&&(i+=1);i===a.length&&o.hide()}function i(e){var t=C(e),n=$("#palette_node_"+t);n.closest(".palette-category").show(),n.show()}return{init:function(){RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);n(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){o(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){i(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteadd&&"function"==typeof n.onpaletteadd&&n.onpaletteadd.call(n)}}),RED.events.on("registry:node-set-disabled",function(e){console.log(e);for(var t=0;t<e.types.length;t++){a(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){o(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){!function(o){var a=new RegExp(o.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(var e in $("#palette-container .palette_node").each(function(e,t){var n=$(t).find(".palette_label").text();""===o||a.test(t.id)||a.test(n)?$(this).show():$(this).hide()}),T)T.hasOwnProperty(e)&&(0===T[e].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?T[e].close():T[e].open())}($(this).val())}});var e=x;RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=x),e.forEach(function(e){k(e,RED._("palette.label."+e,{defaultValue:e}))}),$("#palette-collapse-all").on("click",function(e){for(var t in e.preventDefault(),T)T.hasOwnProperty(t)&&T[t].close()}),$("#palette-expand-all").on("click",function(e){for(var t in e.preventDefault(),T)T.hasOwnProperty(t)&&T[t].open()})},add:n,remove:o,hide:a,show:i,refresh:function(){RED.nodes.eachSubflow(function(e){var t,n,o,a=$("#palette_node_subflow_"+e.id.replace(".","_")),i=a.find(".palette_port_input"),s=a.find(".palette_port_output");if(0===i.length&&0<e.in.length){var r=document.createElement("div");r.className="palette_port palette_port_input",a.append(r)}else 0!==i.length&&0===e.in.length&&i.remove();if(0===s.length&&0<e.out.length){var d=document.createElement("div");d.className="palette_port palette_port_output",a.append(d)}else 0!==s.length&&0===e.out.length&&s.remove();_(e.type+":"+e.id,a,e.name,marked(e.info||"")),t=e,n=a.find(".palette_icon"),o=RED.utils.getNodeIcon(t._def,t),n.attr("style","background-image: url("+o+")")})}}}(),RED.sidebar.info=function(){var o,x,T,k,l;marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var _={property:!1};function a(){RED.sidebar.show("info")}function i(e){if(void 0!==e){var t;x.show(),$(T.content).empty(),$(k.content).empty();var n,o,a=$('<table class="node-info"></table>').appendTo(T.content),i=$("<tbody>").appendTo(a),s=RED.projects.getActiveProject();if(s&&(t=$('<tr class="node-info-node-row"><td>Project</td><td></td></tr>').appendTo(i),$(t.children()[1]).text(s.name||""),$('<tr class="node-info-property-expand blank"><td colspan="2"></td></tr>').appendTo(i),$('<button class="editor-button editor-button-small" style="position:absolute;right:2px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(t.children()[1]).click(function(e){e.preventDefault(),RED.projects.editProject()})),k.container.show(),null!==e)if(Array.isArray(e))k.container.hide(),t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(i),$(t.children()[1]).text(RED._("sidebar.info.nodes",{count:e.length}));else{var r=/^subflow(:(.+))?$/.exec(e.type);if(r){n=r[2]?RED.nodes.subflow(r[2]):e,o=0;var d="subflow:"+n.id;RED.nodes.eachNode(function(e){e.type===d&&o++})}if("tab"===e.type||"subflow"===e.type)t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info."+("tab"===e.type?"flow":"subflow"))+"</td><td></td></tr>").appendTo(i),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.tabName")+"</td><td></td></tr>").appendTo(i),$(t.children()[1]).text(e.label||e.name||""),"tab"===e.type&&(t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.status")+"</td><td></td></tr>").appendTo(i),$(t.children()[1]).html(e.disabled?RED._("sidebar.info.disabled"):RED._("sidebar.info.enabled")));else{if(t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.node")+"</td><td></td></tr>").appendTo(i),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),"subflow"!==e.type&&e.name&&$('<tr class="node-info-node-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'">'+e.name+"</span></td></tr>").appendTo(i),r||$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.type")+"</td><td>"+e.type+"</td></tr>").appendTo(i),!r&&"subflow"!=e.type&&"comment"!=e.type&&e._def){var l=0,c=e._def.defaults;for(var p in c)if("name"!=p&&c.hasOwnProperty(p)){var u=e[p];if(l++,t=$('<tr class="node-info-property-row'+(_.property?"":" hide")+'"><td>'+p+"</td><td></td></tr>").appendTo(i),c[p].type){var f=RED.nodes.node(u);if(f){var h=RED.utils.getNodeLabel(f,u),g=t.children()[1],v=$("<span>",{class:""}).appendTo(g),m=$("<div>",{class:"palette_node palette_node_small"}).appendTo(v),b=f._def.color,y=RED.utils.getNodeIcon(f._def);m.css({backgroundColor:b,cursor:"pointer"});var w=$("<div/>",{class:"palette_icon_container"}).appendTo(m);$("<div/>",{class:"palette_icon",style:"background-image: url("+y+")"}).appendTo(w);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).html(h).appendTo(g);m.on("dblclick",function(){RED.editor.editConfig("",f.type,f.id)})}else RED.utils.createObjectElement(void 0).appendTo(t.children()[1])}else RED.utils.createObjectElement(u).appendTo(t.children()[1])}0<l&&$('<tr class="node-info-property-expand blank"><td colspan="2"><a href="#" class=" node-info-property-header'+(_.property?" expanded":"")+'"><span class="node-info-property-show-more">'+RED._("sidebar.info.showMore")+'</span><span class="node-info-property-show-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(i)}"tab"!==e.type&&r&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(i),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(n.name)+'">'+n.name+"</span></td></tr>").appendTo(i))}r&&$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+o+"</td></tr>").appendTo(i);var D="";if(n||"comment"===e.type||"tab"===e.type)"tab"===e.type&&(k.title.html(RED._("sidebar.info.flowDesc")),D=marked(e.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>");else k.title.html(RED._("sidebar.info.nodeHelp")),D=$("script[data-help-name='"+e.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>";if(n)D+=marked(n.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",k.title.html(RED._("sidebar.info.subflowDesc"));else if(e._def&&e._def.info){k.title.html(RED._("sidebar.info.nodeHelp"));var E=e._def.info,R="function"==typeof E?E.call(e):E;D+=marked(R)}D&&C(D),$(".node-info-property-header").click(function(e){e.preventDefault(),_.property=!_.property,$(this).toggleClass("expanded",_.property),$(".node-info-property-row").toggle(_.property)})}}else j()}function C(e){var t,n=(t=$('<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>"),$(t).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),t).appendTo(k.content);n.find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");n.find("H3").wrapInner('<a class="node-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').click(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),n=$(this).parent().next();1===n.length&&"H3"!==n[0].nodeName;)n.toggle(!t),n=n.next();$(this).toggleClass("expanded",!t)})}var s=function(){var a,i,t=!0,s=15e3,r=-1;function e(){for(var e,t=Math.floor(Math.random()*r),n=RED._("infotips:info.tip"+t);e=/({{(.*?)}})/.exec(n);){var o=RED.keyboard.getShortcut(e[2]);if(!o)return;n=n.replace(e[1],RED.keyboard.formatKey(o.key))}for(;e=/(\[(.*?)\])/.exec(n);)n=n.replace(e[1],RED.keyboard.formatKey(e[2]));l.html(n).fadeIn(200),a&&(a=null,i=setInterval(d,s))}function d(){l.fadeOut(300,function(){e()})}function n(){if($(".sidebar-node-info").addClass("show-tips"),t&&!a&&!i){if(-1===r)for(;r++,RED._("infotips:info.tip"+r)!=="infotips:info.tip"+r;);a=setTimeout(e,1e3)}}function o(){$(".sidebar-node-info").removeClass("show-tips"),clearInterval(i),clearTimeout(a),a=i=null}return RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(t=e)?n():o()}),{start:n,stop:o,next:function(){clearInterval(i),a=!0,e()},enabled:function(){return t}}}();function j(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?i(RED.nodes.subflow(t.z)):i(t)}else i(e.nodes);else{var n=RED.workspaces.active(),o=RED.nodes.workspace(n)||RED.nodes.subflow(n);if(o)i(o);else{var a=RED.nodes.workspace(RED.workspaces.active());a&&a.info?i(a):i(null)}}}return RED.events.on("view:selection-changed",j),{init:function(){(o=document.createElement("div")).className="sidebar-node-info",RED.actions.add("core:show-info-tab",a);var e=$("<div>",{class:"sidebar-node-info-stack"}).appendTo(o);x=RED.stack.create({container:e}).hide(),(T=x.add({title:RED._("sidebar.info.info"),collapsible:!0})).expand(),(k=x.add({title:RED._("sidebar.info.nodeHelp"),collapsible:!0})).expand(),k.content.css("padding","6px"),k.container.css("border-bottom","none");var t=$('<div class="node-info-tips"></div>').appendTo(o);l=$('<div class="node-info-tip"></div>').appendTo(t);var n=$('<div class="node-info-tips-buttons"></div>').appendTo(t);$('<a href="#" class="workspace-footer-button"><i class="fa fa-refresh"></a>').appendTo(n).click(function(e){e.preventDefault(),s.next()}),$('<a href="#" class="workspace-footer-button"><i class="fa fa-times"></a>').appendTo(n).click(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),content:o,enableOnEdit:!0}),s.enabled()?s.start():s.stop()},show:a,refresh:i,clear:function(){i(null)},set:function(e,t){k.title.text(t||""),i(null),$(k.content).empty(),C(e),$(".sidebar-node-info-stack").scrollTop(0)}}}(),RED.sidebar.config=function(){var e=document.createElement("div");e.className="sidebar-node-config",$('<div class="button-group sidebar-header"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </div>').appendTo(e);var t=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),a=$("<div>").appendTo(e),i=$("<div>").appendTo(e),s=$("<div>").appendTo(e),r=!1,d={};function l(e,t,n){if(e=e.replace(/\./i,"-"),d[e])d[e].label!==n&&(d[e].list.parent().find(".config-node-label").text(n),d[e].label=n);else{var o=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+e+'"></div>').appendTo(t),a=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(o);n?$('<span class="config-node-label"/>').text(n).appendTo(a):$('<span class="config-node-label" data-i18n="sidebar.config.'+e+'">').appendTo(a),$('<span class="config-node-filter-info"></span>').appendTo(a),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(o),o.i18n();var i=a.find("i"),s={label:n,list:category,size:function(){return s.list.find("li:not(.config_node_none)").length},open:function(e){i.hasClass("expanded")||(i.addClass("expanded"),e?s.list.show():s.list.slideDown())},close:function(e){i.hasClass("expanded")&&(i.removeClass("expanded"),e?s.list.hide():s.list.slideUp())},isOpen:function(){return i.hasClass("expanded")}};a.on("click",function(e){s.isOpen()?s.close():s.open()}),d[e]=s}return d[e]}function c(e,t){var n=l(e.replace(/\./i,"-")),a=n.list;if(t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),r){var o=t.length;0<(o-=(t=t.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)?a.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:o})).show():a.parent().find(".config-node-filter-info").hide()}else a.parent().find(".config-node-filter-info").hide();if(a.empty(),0===t.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(a),n.close(!0);else{var i="";t.forEach(function(t){var e=RED.utils.getNodeLabel(t,t.id);t.type!=i&&($('<li class="config_node_type">'+t.type+"</li>").appendTo(a),i=t.type);var n=$('<li class="palette_node config_node palette_node_id_'+t.id.replace(/\./g,"-")+'"></li>').appendTo(a);if($('<div class="palette_label"></div>').text(e).appendTo(n),!1!==t._def.hasUsers){$("<div/>",{class:"palette_icon_container  palette_icon_container_right"}).text(t.users.length).appendTo(n);0===t.users.length&&n.addClass("config_node_unused")}n.on("click",function(e){RED.sidebar.info.refresh(t)}),n.on("dblclick",function(e){RED.editor.editConfig("",t.type,t.id)});var o=t.users.map(function(e){return e.id});n.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=o.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),n.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),n.open(!0)}}function n(){var t={global:!0};l("global",a),RED.nodes.eachWorkspace(function(e){t[e.id.replace(/\./g,"-")]=!0,l(e.id,i,e.label)}),RED.nodes.eachSubflow(function(e){t[e.id.replace(/\./g,"-")]=!0,l(e.id,s,e.name)}),$(".workspace-config-node-category").each(function(){var e=$(this).attr("id").substring("workspace-config-node-category-".length);t[e]||($(this).remove(),delete d[e])});var n=[],o={};for(var e in RED.nodes.eachConfig(function(e){e.z?(o[e.z.replace(/\./g,"-")]=o[e.z.replace(/\./g,"-")]||[],o[e.z.replace(/\./g,"-")].push(e)):e.z||n.push(e)}),t)t.hasOwnProperty(e)&&c(e,o[e]||[]);c("global",n)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:e,toolbar:t,closeable:!0,visible:!1,onchange:function(){n()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),$("#workspace-config-node-collapse-all").on("click",function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&d[t].close()}),$("#workspace-config-node-expand-all").on("click",function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&0<d[t].size()&&d[t].open()}),$("#workspace-config-node-filter-all").on("click",function(e){e.preventDefault(),r&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),r=!r,n())}),$("#workspace-config-node-filter-unused").on("click",function(e){e.preventDefault(),r||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),r=!r,n())})},show:function(r){"boolean"==typeof r&&(r?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),n(),"string"==typeof r&&($("#workspace-config-node-filter-all").click(),r=r.replace(/\./g,"-"),setTimeout(function(){var e=$(".palette_node_id_"+r),t=e.position().top,n=e.height(),o=$(".sidebar-node-config"),a=o.height();a<t+n?o.animate({scrollTop:"-="+(a-(t+n)-30)},150):t<0&&o.animate({scrollTop:"+="+(t-10)},150);var i=21,s=function(){i%2==0?e.removeClass("node_highlighted"):e.addClass("node_highlighted"),0<=--i&&setTimeout(s,100)};s()},100)),RED.sidebar.show("config")},refresh:n}}(),RED.palette.editor=function(){var c,p,u,m,f,i,h=[],g=[],w={},b={},y={},t={},v="";function s(e,t){var n=Date.now()-e;n=n<300?300:0,setTimeout(function(){t()},n)}function D(e,t,o,a){o.show();var i=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,n){s(i,function(){o.hide(),a()})}).fail(function(e,t,n){s(i,function(){o.hide(),a(e)})})}function E(e,t,o){var n={module:e};t&&(n.version=t),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"}).done(function(e,t,n){o()}).fail(function(e,t,n){o(e)})}function R(e){t.hasOwnProperty(e)||(t[e]=setTimeout(function(){delete t[e],n(e)},100))}function x(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var n=parseInt(t[1]),o=parseInt(t[2]),a=parseInt(t[3]);if(160<(299*n+587*o+114*a)/1e3)return"rgb("+(n=Math.floor(.8*n))+","+(o=Math.floor(.8*o))+","+(a=Math.floor(.8*a))+")"}return e}function n(e){if(y.hasOwnProperty(e)){var t=y[e].info,n=y[e].elements;if(n){var o=0,a=0,i=0;for(var s in n.errorList.empty(),y[e].totalUseCount=0,y[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(s)){var r=0,d=t.sets[s],l=n.sets[s];d.err&&(i++,$("<li>").text(d.err).appendTo(n.errorList)),d.enabled&&(o+=d.types.length),a+=d.types.length;for(var c=0;c<t.sets[s].types.length;c++){var p=t.sets[s].types[c];r+=b[p]||0;var u=l.swatches[p];if(d.enabled){var f=RED.nodes.getType(p);f&&f.color?(u.css({background:f.color}),u.css({border:"1px solid "+x(u.css("backgroundColor"))})):u.css({background:"#eee",border:"1px dashed #999"})}else u.css({background:"#eee",border:"1px dashed #999"})}y[e].setUseCount[s]=r,y[e].totalUseCount+=r,0<r?(l.enableButton.html(RED._("palette.editor.inuse")),l.enableButton.addClass("disabled")):(l.enableButton.removeClass("disabled"),d.enabled?l.enableButton.html(RED._("palette.editor.disable")):l.enableButton.html(RED._("palette.editor.enable"))),l.setRow.toggleClass("palette-module-set-disabled",!d.enabled)}0===i?n.errorRow.hide():n.errorRow.show();var h=o===a?a:o+" / "+a;n.setCount.html(RED._("palette.editor.nodeCount",{count:a,label:h})),0<y[e].totalUseCount?(n.enableButton.html(RED._("palette.editor.inuse")),n.enableButton.addClass("disabled"),n.removeButton.hide()):(n.enableButton.removeClass("disabled"),t.local&&n.removeButton.css("display","inline-block"),0===o?n.enableButton.html(RED._("palette.editor.enableall")):n.enableButton.html(RED._("palette.editor.disableall")),n.container.toggleClass("disabled",0===o))}t.pending_version?(n.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(n.metaRow),n.updateButton.html(RED._("palette.editor.updated")).addClass("disabled").show()):w.hasOwnProperty(e)&&1===function(e,t){for(var n=e.split(".").map(function(e){return parseInt(e)}),o=t.split(".").map(function(e){return parseInt(e)}),a=0;a<3;a++){var i=n[a]-o[a];if(i<0)return-1;if(0<i)return 1}return 0}(w[e].version,t.version)?(n.updateButton.show(),n.updateButton.html(RED._("palette.editor.update",{version:w[e].version}))):n.updateButton.hide()}else{y[e]={info:RED.nodes.registry.getModule(e)};var g=[e];for(var v in y[e].info.sets)y[e].info.sets.hasOwnProperty(v)&&(g.push(v),g=g.concat(y[e].info.sets[v].types));y[e].index=g.join(",").toLowerCase(),m.editableList("addItem",y[e])}}var r,T,d=[],l=!1,k=j;function a(e,t,n,o){if(d.push(e||o),e?l=!0:(o.modules&&(o.modules.forEach(function(e){(w[e.id]=e).index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),h=h.concat(o.modules)),u.searchBox("count",h.length)),1<i&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+d.length+"/"+i),d.length===i){l&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var a=250-(Date.now()-r);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(a,0))}}function _(){if(0===h.length){h=[],w={},f.editableList("empty"),$(".palette-module-shade-status").html(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];l=!(d=[]),i=e.length,1<e.length&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#palette-module-install-shade").show(),r=Date.now();var t=0;e.forEach(function(o,e){$.getJSON(o,{_:(new Date).getTime()},function(e){a(null,o,0,e),function(){for(var e in y)y.hasOwnProperty(e)&&n(e)}()}).fail(function(e,t,n){a(e,o)}).always(function(){++t===i&&u.searchBox("change")})})}}function C(){if(f.editableList("empty"),""!==u.searchBox("value").trim()){g.sort(k);for(var e=0;e<Math.min(10,g.length);e++)f.editableList("addItem",g[e]);0===g.length&&f.editableList("addItem",{}),10<g.length&&f.editableList("addItem",{start:10,more:g.length-10})}else f.editableList("addItem",{count:h.length})}function j(e,t){return e.info.id.localeCompare(t.info.id)}function S(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function e(){return _(),c.activateTab("nodes"),T}function O(n,e,o){if(!1!==RED.settings.theme("palette.editable")){var t=[{text:RED._("common.label.cancel"),click:function(){a.close()}}];n.url&&t.push({text:RED._("palette.editor.confirm.button.review"),class:"primary palette-module-install-confirm-button-install",click:function(){var e=n.url||"";window.open(e)}}),t.push({text:RED._("palette.editor.confirm.button.install"),class:"primary palette-module-install-confirm-button-install",click:function(){var t=RED.utils.addSpinnerOverlay(e,!0);E(n.id,n.version,function(e){t.remove(),e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:n.id,message:e.responseJSON.message})),o(e)}),a.close()}});var a=RED.notify(RED._("palette.editor.confirm.install.body",{module:n.id}),{modal:!0,fixed:!0,buttons:t})}else o(new Error("Palette not editable"))}return{init:function(){!1!==RED.settings.theme("palette.editable")&&(function(){T=$('<div id="user-settings-tab-palette"></div>');var t=$('<div id="palette-editor"><ul id="palette-editor-tabs"></ul></div>').appendTo(T);c=RED.tabs.create({element:T.find("#palette-editor-tabs"),onchange:function(e){t.find(".palette-editor-tab").hide(),e.content.show(),p&&p.searchBox("value",""),u&&u.searchBox("value",""),"install"===e.id?u&&u.focus():p&&p.focus()},minimumActiveTabWidth:110});var e=$("<div>",{class:"palette-editor-tab"}).appendTo(t);c.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:e});var n=$("<div>",{class:"palette-search"}).appendTo(e);p=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(n).searchBox({delay:200,change:function(){!function(e){v=e.toLowerCase();var t=m.editableList("filter"),n=m.editableList("length");""===e?p.searchBox("count"):p.searchBox("count",t+" / "+n)}($(this).val())}}),m=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===v||""===v||-1<e.index.indexOf(v)},addItem:function(t,e,s){var r=s.info;if(r){var n=$("<div>",{class:"palette-module-header"}).appendTo(t),o=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(n);$("<span>").html(r.name).appendTo(o);var a=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(n),i=$("<span>").html(r.version).appendTo(a),d=$('<div class="palette-module-meta palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(n),l=$('<ul class="palette-module-error-list"></ul>').appendTo(d),c=$("<div>",{class:"palette-module-meta"}).appendTo(n),p=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(c),u=$("<span>").appendTo(p),f=$("<div>",{class:"palette-module-button-group"}).appendTo(c),h=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.update")).appendTo(f);h.attr("id","up_"+Math.floor(1e9*Math.random())),h.click(function(e){e.preventDefault(),$(this).hasClass("disabled")||function(n,e,o,a){if(!1===RED.settings.theme("palette.editable"))return a(new Error("Palette not editable"));var i=RED.notify(RED._("palette.editor.confirm.update.body",{module:n.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary palette-module-install-confirm-button-update",click:function(){var t=RED.utils.addSpinnerOverlay(o,!0);E(n.name,e,function(e){t.remove(),e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.updateFailed",{module:n.name,message:e.responseJSON.message})),a(e)}),i.close()}}]})}(r,w[r.name].version,t,function(e){})});var g=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.remove")).appendTo(f);g.attr("id","up_"+Math.floor(1e9*Math.random())),g.click(function(e){e.preventDefault(),function(n,a,e){if(!1===RED.settings.theme("palette.editable"))return e(new Error("Palette not editable"));var i=RED.notify(RED._("palette.editor.confirm.remove.body",{module:n.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary palette-module-install-confirm-button-remove",click:function(){var e,o,t=RED.utils.addSpinnerOverlay(a,!0);e=n.name,o=function(e){t.remove(),e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.removeFailed",{module:n.name,message:e.responseJSON.message}))},$.ajax({url:"nodes/"+e,type:"DELETE"}).done(function(e,t,n){o()}).fail(function(e,t,n){o(e)}),i.close()}}]})}(r,t,function(e){})}),r.local||g.hide();var v=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.disableall")).appendTo(f),m=$("<div>",{class:"palette-module-content"}).appendTo(t),b=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(t);s.elements={updateButton:h,removeButton:g,enableButton:v,errorRow:d,errorList:l,setCount:u,container:t,shade:b,versionSpan:i,sets:{}},p.click(function(e){e.preventDefault(),t.hasClass("expanded")?(t.removeClass("expanded"),m.slideUp()):(t.addClass("expanded"),m.slideDown())});var y=Object.keys(r.sets);y.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),y.forEach(function(o){var a=r.sets[o],n=$("<div>",{class:"palette-module-set"}).appendTo(m),e=$("<div>",{class:"palette-module-set-button-group"}).appendTo(n),i={};a.types.forEach(function(e){var t=$("<div>",{class:"palette-module-type"}).appendTo(n);i[e]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"palette-module-type-node"}).html(e).appendTo(t)});var t=$('<a href="#" class="editor-button editor-button-small"></a>').appendTo(e);t.click(function(e){if(e.preventDefault(),0===s.setUseCount[o]){var t=RED.nodes.registry.getNodeSet(a.id);b.show();var n=!t.enabled;D(a.id,n,b,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(n?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))})}}),s.elements.sets[a.name]={setRow:n,enableButton:t,swatches:i}}),v.click(function(e){e.preventDefault(),0===s.totalUseCount&&D(r.name,t.hasClass("disabled"),b,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))})}),R(r.name)}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(t)}});var o=$("<div>",{class:"palette-editor-tab hide"}).appendTo(t);c.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:o});var a=$("<div>",{class:"palette-editor-toolbar"}).appendTo(o),i=$("<div>",{class:"palette-search"}).appendTo(o);u=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(i).searchBox({delay:300,change:function(){var t=$(this).val().trim().toLowerCase();0<t.length?(g=h.filter(function(e){return-1<e.index.indexOf(t)}).map(function(e){return{info:e}}),C(),u.searchBox("count",g.length+" / "+h.length)):(u.searchBox("count",h.length),f.editableList("empty"),f.editableList("addItem",{count:h.length}))}}),$("<span>").html(RED._("palette.editor.sort")+" ").appendTo(a);var s=$('<span class="button-group"></span>').appendTo(a),r=$('<a href="#" class="sidebar-header-button-toggle selected" data-i18n="palette.editor.sortAZ"></a>').appendTo(s),d=$('<a href="#" class="sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(s);r.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),d.removeClass("selected"),k=j,C())}),d.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),r.removeClass("selected"),k=S,C())});var l=$("<span>").appendTo(a);$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(l).click(function(e){e.preventDefault(),h=[],w={},_()}),f=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(o).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,n){if(n.count)$("<div>",{class:"red-ui-search-empty"}).html(RED._("palette.editor.moduleCount",{count:n.count})).appendTo(t);else if(n.more){t.addClass("palette-module-more");var o=$("<div>",{class:"palette-module-header palette-module"}).appendTo(t),a=$('<a href="#"></a>').html(RED._("palette.editor.more",{count:n.more})).appendTo(o);a.click(function(e){e.preventDefault(),f.editableList("removeItem",n);for(var t=n.start;t<Math.min(n.start+10,n.start+n.more);t++)f.editableList("addItem",g[t]);10<n.more&&f.editableList("addItem",{start:n.start+10,more:n.more-10})})}else if(n.info){var i=n.info,s=$("<div>",{class:"palette-module-header"}).appendTo(t),r=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(s);$("<span>",{class:"palette-module-name"}).html(i.name||i.id).appendTo(r),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",i.url).appendTo(r);var d=$('<div class="palette-module-meta"></div>').appendTo(s);$("<div>",{class:"palette-module-description"}).html(i.description).appendTo(d);var l=$('<div class="palette-module-meta"></div>').appendTo(s);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+i.version+"</span>").appendTo(l),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var n=Math.floor(t/7);if(n<4)return RED._("palette.editor.times.weeksV",{count:n});var o=Math.floor(n/4);if(n%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var a=Math.floor(o/12);return 0==(o%=12)?RED._("palette.editor.times.yearsV",{count:a}):RED._("palette.editor.times.year"+(1<a?"s":"")+"MonthsV",{y:a,count:o})}(i.updated_at)+"</span>").appendTo(l);var c=$("<div>",{class:"palette-module-meta"}).appendTo(s),p=$("<div>",{class:"palette-module-button-group"}).appendTo(c),u=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.install")).appendTo(p);u.click(function(e){e.preventDefault(),$(this).hasClass("disabled")||O(i,t,function(e){})}),y.hasOwnProperty(i.id)&&(u.addClass("disabled"),u.html(RED._("palette.editor.installed"))),n.elements={installButton:u}}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(t)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(o)}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:e,close:function(){T.detach()},focus:function(){c.resize(),setTimeout(function(){p.focus()},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){R(e.module)}),RED.events.on("registry:node-set-enabled",function(e){R(e.module)}),RED.events.on("registry:node-set-disabled",function(e){R(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||R(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||R(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){R(e.module);for(var t=0;t<g.length;t++)if(g[t].info.id===e.module){var n=g[t].elements.installButton;n.addClass("disabled"),n.html(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=y[e.module];if(t){m.editableList("removeItem",t),delete y[e.module];for(var n=0;n<g.length;n++)if(g[n].info.id===e.module){var o=g[n].elements.installButton;o.removeClass("disabled"),o.html(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(b[e.type]=(b[e.type]||0)+1,1===b[e.type]&&R(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){b.hasOwnProperty(e.type)&&(b[e.type]--,0===b[e.type]&&(delete b[e.type],R(RED.nodes.registry.getNodeSetForType(e.type).module)))}))},install:O}}(),RED.editor=function(){var c=[],p={};function _(e){var t,n,o,a=e.valid,i=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))n=(t=RED.nodes.subflow(e.type.substring(8))).valid,o=t.changed,void 0===n&&(n=_(t),o=t.changed),e.valid=n&&u(e,e._def.defaults,e),e.changed=e.changed||o;else if(e._def)e.valid=u(e,e._def.defaults,e),e._def._creds&&(e.valid=e.valid&&u(e,e._def.credentials,e._def._creds));else if("subflow"==e.type){for(var s=RED.nodes.filterNodes({z:e.id}),r=0;r<s.length;r++)n=s[r].valid,o=s[r].changed,void 0===n&&(n=_(s[r]),o=s[r].changed),e.valid=e.valid&&n,e.changed=e.changed||o;var d=RED.nodes.filterNodes({type:"subflow:"+e.id}),l={};for(r=0;r<d.length;r++)d[r].valid=e.valid,d[r].changed=d[r].changed||e.changed,d[r].dirty=!0,l[d[r].z]=!0;Object.keys(l).forEach(function(e){var t=RED.nodes.subflow(e);t&&_(t)})}return a===e.valid&&i===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&_(t)),e.valid}function u(e,t,n){var o=!0;for(var a in t)t.hasOwnProperty(a)&&(r(e,t,a,n[a])||(o=!1));if(e.icon){var i=RED.utils.separateIconPath(e.icon);if(!i.module)return o;var s=RED.nodes.getIconSets()[i.module];s&&-1!==s.indexOf(i.file)||(o=!1)}return o}function r(t,e,n,o){var a=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if("required"in e[n]&&e[n].required&&(a=""!==o),a&&"validate"in e[n])try{a=e[n].validate.call(t,o)}catch(e){console.log("Validation error:",t.type,t.id,"property: "+n,"value:",o,e)}if(a&&e[n].type&&RED.nodes.getType(e[n].type)&&!("validate"in e[n]))if(o&&"_ADD_"!=o){var i=RED.nodes.node(o);a=null!==i&&(null==i.valid||i.valid)}else a=e[n].hasOwnProperty("required")&&!e[n].required;return a}function l(e,t){for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&o(e,e._def.defaults,n,t);if(e._def.credentials)for(n in e._def.credentials)e._def.credentials.hasOwnProperty(n)&&o(e,e._def.credentials,n,t);d(e)}function d(e){if(e._def.hasOwnProperty("defaults")&&!e._def.defaults.hasOwnProperty("icon")&&e.icon){var t=RED.utils.separateIconPath(e.icon),n=RED.nodes.getIconSets()[t.module],o=$("#node-settings-icon-module"),a=$("#node-settings-icon-file");n?-1===n.indexOf(t.file)?(o.removeClass("input-error"),a.addClass("input-error")):(o.removeClass("input-error"),a.removeClass("input-error")):(o.addClass("input-error"),a.removeClass("input-error"))}}function o(e,t,n,o){var a=$("#"+o+"-"+n);if(0<a.length){var i=a.val();t[n].hasOwnProperty("format")&&""!==t[n].format&&"DIV"===a[0].nodeName&&(i=a.text()),r(e,t,n,i)?a.removeClass("input-error"):a.addClass("input-error")}}function C(t,n){t.resize=!0,t.dirty=!0;var o=[];if(t.ports)if(n&&RED.nodes.eachLink(function(e){e.source===t&&n.hasOwnProperty(e.sourcePort)&&("-1"===n[e.sourcePort]?o.push(e):e.sourcePort=n[e.sourcePort])}),t.outputs<t.ports.length){for(;t.outputs<t.ports.length;)t.ports.pop();RED.nodes.eachLink(function(e){e.source===t&&e.sourcePort>=t.outputs&&-1===o.indexOf(e)&&o.push(e)})}else if(t.outputs>t.ports.length)for(;t.outputs>t.ports.length;)t.ports.push(t.ports.length);0===t.inputs&&o.concat(RED.nodes.filterLinks({target:t}));for(var e=0;e<o.length;e++)RED.nodes.removeLink(o[e]);return o}function f(e,t,n,o){var a=$("#"+o+"-"+t);if(0!==a.length){var i,s=a.width(),r=a.attr("style");s=null!==(i=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(r))?i[1]:"70%";var d=$("<div></div>").css({display:"inline-block",position:"relative"}),l=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(d),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(l);d.width(s).height(a.height()),0===d.width()&&d.width("70%"),a.replaceWith(d),c.attr("style","width:100%"),k(t,n,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(d),$("#"+o+"-lookup-"+t).click(function(e){x(t,n,c.find(":selected").val(),o),e.preventDefault()});var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(n);u&&(p=RED.utils.getNodeLabel(u,u.id)),a.val(p)}}function h(e,t,n,o){var a=$("#"+o+"-"+t);a.val(e[t]),a.attr("type","hidden");var i=$("<a>",{id:o+"-edit-"+t,class:"editor-button"});a.after(i),e[t]?i.text(RED._("editor.configEdit")):i.text(RED._("editor.configAdd")),i.click(function(e){x(t,n,a.val()||"_ADD_",o),e.preventDefault()})}function g(e,t,n,o){var a=$("#"+n+"-"+t);if(0!==a.length)if("checkbox"===a.attr("type"))a.prop("checked",e[t]);else{var i=e[t];null==i&&(i=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===a[0].nodeName?(a.html(RED.text.format.getHtml(i,o[t].format,{},!1,"en")),RED.text.format.attach(a[0],o[t].format,{},!1,"en")):(a.val(i),"INPUT"!==a[0].nodeName&&"TEXTAREA"!==a[0].nodeName||RED.text.bidi.prepareInput(a))}}function v(n,e,t,o){var a=$("#"+o+"-"+t);void 0!==e&&"format"in e[t]&&""!==e[t].format&&"DIV"===a[0].nodeName?$("#"+o+"-"+t).on("change keyup",function(e,t){t||l(n,o)}):$("#"+o+"-"+t).change(function(e,t){t||l(n,o)})}function m(e,t,n,o){var a;for(a in t)t.hasOwnProperty(a)&&("password"==t[a].type?n[a]?$("#"+o+"-"+a).val(n[a]):n["has_"+a]?$("#"+o+"-"+a).val("__PWRD__"):$("#"+o+"-"+a).val(""):g(n,a,o,t),v(e,t,a,o))}function j(e,t,n){var o=!1;for(var a in e.credentials||(e.credentials={_:{}}),t)if(t.hasOwnProperty(a)){var i=$("#"+n+"-"+a).val();if("password"==t[a].type){if(e.credentials["has_"+a]=""!==i,"__PWRD__"==i)continue;o=!0}(e.credentials[a]=i)!=e.credentials._[a]&&(o=!0)}return o}function b(t,n,o,a){for(var e in n.defaults)if(n.defaults.hasOwnProperty(e)){if(n.defaults[e].type){var i=RED.nodes.getType(n.defaults[e].type);i?i.exclusive?h(t,e,n.defaults[e].type,o):f(t,e,n.defaults[e].type,o):(console.log("Unknown type:",n.defaults[e].type),g(t,e,o,n.defaults))}else g(t,e,o,n.defaults);v(t,n.defaults,e,o)}var s,r,d=function(){if(n.oneditprepare)try{n.oneditprepare.call(t)}catch(e){console.log("oneditprepare",t.id,t.type,e.toString())}for(var e in n.defaults)n.defaults.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);if(n.credentials)for(e in n.credentials)n.credentials.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);l(t,o),a&&a()};n.credentials?t.credentials?(m(t,n.credentials,t.credentials,o),d()):$.getJSON((s=t.type,r=t.id,"credentials/"+s.replace(/\s+/g,"-")+"/"+r),function(e){t.credentials=e,t.credentials._=$.extend(!0,{},e),m(t,n.credentials,t.credentials,o),d()}):d()}function y(){for(var e,t=c.length-1;t<c.length;t++){var n=c[t];if(e=n.type,"_expression"===n.type)e=RED._("expressionEditor.title");else if("_json"===n.type)e=RED._("jsonEditor.title");else if("_markdown"===n.type)e=RED._("markdownEditor.title");else if("_buffer"===n.type)e=RED._("bufferEditor.title");else if("subflow"===n.type)e=RED._("subflow.editSubflow",{name:n.name});else if(0===n.type.indexOf("subflow:")){var o=RED.nodes.subflow(n.type.substring(8));e=RED._("subflow.editSubflow",{name:o.name})}else{if(void 0!==n._def.paletteLabel)try{e=("function"==typeof n._def.paletteLabel?n._def.paletteLabel.call(n._def):n._def.paletteLabel)||""}catch(e){console.log("Definition error: "+n.type+".paletteLabel",e)}t===c.length-1&&(e=RED.nodes.node(n.id)?RED._("editor.editNode",{type:e}):RED._("editor.addNewConfig",{type:e}))}"<li>"+e+"</li>"}return"</ul>",e}function w(e,t,n,i){var o=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return o.html($("script[data-template-name='"+n+"']").html()),i=i||"node-red",o.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var n=e[t];if(-1===n.indexOf(":")){var o="";if(0===n.indexOf("[")){var a=n.split("]");o=a[0]+"]",n=a[1]}e[t]=o+i+":"+n}}$(this).attr("data-i18n",e.join(";"))}),$('<input type="password" style="display: none;" />').prependTo(o),$('<input type="text" style="display: none;" />').prependTo(o),o.submit(function(e){e.preventDefault()}),o}function D(e,t,n,o){var a=$("<div>",{class:"node-label-form-row"});if(void 0===e)$("<span>").html(RED._("editor.noDefaultLabel")).appendTo(a),a.addClass("node-label-form-none");else{a.addClass("");var i="node-label-form-"+e+"-"+t;$("<label>",{for:i}).html(t+1+".").appendTo(a);var s=$("<input>",{type:"text",id:i,placeholder:o}).val(n).appendTo(a);$('<button class="editor-button editor-button-small"><i class="fa fa-times"></i></button>').appendTo(a).click(function(e){e.preventDefault(),s.val("")})}return a}function E(e,n){var t=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),o=n.inputs||n._def.inputs||0,a=n.outputs||n._def.outputs||0;"subflow"===n.type&&(o=n.in.length,a=n.out.length);var i,s=n.inputLabels||[],r=n.outputLabels||[],d=n._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),l=n._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span data-i18n="editor.labelInputs"></span><div id="node-label-form-inputs"></div></div>').appendTo(t);var c=$("#node-label-form-inputs");if(0<o)for(i=0;i<o;i++)D("input",i,s[i],d).appendTo(c);else D().appendTo(c);$('<div class="form-row"><span data-i18n="editor.labelOutputs"></span><div id="node-label-form-outputs"></div></div>').appendTo(t);var p=$("#node-label-form-outputs");if(0<a)for(i=0;i<a;i++)D("output",i,r[i],l).appendTo(p);else D().appendTo(p);if(!n._def.defaults||!n._def.defaults.hasOwnProperty("icon")){$('<div class="form-row"><div id="node-settings-icon"></div></div>').appendTo(t);var u=$("#node-settings-icon");$('<label data-i18n="editor.settingIcon">').appendTo(u);var f=$("<div>",{class:"node-label-form-row"});f.appendTo(u),$("<label>").appendTo(f);var h,g=$('<select id="node-settings-icon-module"><option value=""></option></select>').appendTo(f);h=n.icon?RED.utils.separateIconPath(n.icon):RED.utils.getDefaultNodeIcon(n._def,n);var v=RED.nodes.getIconSets();Object.keys(v).forEach(function(e){g.append($("<option></option>").val(e).text(e))}),h.module&&!v[h.module]&&g.append($("<option disabled></option>").val(h.module).text(h.module)),g.val(h.module);var m=$('<input type="hidden" id="node-settings-icon-module-hidden"></input>').appendTo(f);m.val(h.module);var b=$('<select id="node-settings-icon-file"><option value=""></option></select>').appendTo(f);g.change(function(){R(g,b,m,y,v,!0)});var y=$('<input type="hidden" id="node-settings-icon-file-hidden"></input>').appendTo(f);y.val(h.file),b.change(function(){b.removeClass("input-error");var e=b.val();y.val(e)}),$('<button class="editor-button editor-button-small"><i class="fa fa-times"></i></button>').appendTo(f).click(function(e){e.preventDefault();var t=RED.utils.getDefaultNodeIcon(n._def,n);g.val(t.module),R(g,b,m,y,v,!0),b.removeClass("input-error"),b.val(t.file),y.val(t.file)}),R(g,b,m,y,v,!1);var w=v[g.val()];w&&-1!==w.indexOf(h.file)||b.append($("<option disabled></option>").val(h.file).text(h.file)),b.val(h.file)}}function R(e,t,n,o,a,i){t.children().remove();var s=e.val();null!==s&&n.val(s);var r=a[s];r&&r.forEach(function(e){i&&(i=!1,o.val(e)),t.append($("<option></option>").val(e).text(e))}),t.prop("disabled",!r),t.removeClass("input-error"),e.removeClass("input-error")}function S(e,t,n){var o=$("#node-label-form-inputs").children().find("input"),a=$("#node-label-form-outputs").children().find("input"),i=!1,s=!1,r=o.map(function(){var e=$(this).val();return i=i||""!==e,e}).toArray().slice(0,e.inputs);return(void 0===e.inputLabels&&i||void 0!==e.inputLabels&&JSON.stringify(r)!==JSON.stringify(e.inputLabels))&&(t.inputLabels=e.inputLabels,e.inputLabels=r,s=!0),i=!1,r=new Array(e.outputs),a.each(function(){var e=$(this).attr("id").substring(23);if(!n||!n.hasOwnProperty(e)||-1!==(e=parseInt(n[e]))){var t=$(this).val();i=i||""!==t,r[e]=t}}),(void 0===e.outputLabels&&i||void 0!==e.outputLabels&&JSON.stringify(r)!==JSON.stringify(e.outputLabels))&&(t.outputLabels=e.outputLabels,e.outputLabels=r,s=!0),s}function x(f,h,e,g){var n,v="_ADD_"==e,s=RED.nodes.getType(h),m=RED.nodes.node(e);n="node-red"===s.set.module?"node-red":s.set.id;var t="",o=RED.nodes.subflow(RED.workspaces.active());if(o&&(t=o.id),null==m){for(var a in m={id:RED.nodes.id(),_def:s,type:h,z:t,users:[]},s.defaults)s.defaults[a].value&&(m[a]=JSON.parse(JSON.stringify(s.defaults[a].value)));m._=s._}c.push(m),RED.view.state(RED.state.EDITING);var i={title:y(),resize:function(){if(m&&m._def.oneditresize){var e=$("#node-config-dialog-edit-form");try{m._def.oneditresize.call(m,{width:e.width(),height:e.height()})}catch(e){console.log("oneditresize",m.id,m.type,e.toString())}}},open:function(e,a){e.find(".editor-tray-header");var t=e.find(".editor-tray-footer");!1!==s.hasUsers&&t.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),t.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var i=w(e.find(".editor-tray-body"),"node-config-dialog-edit-form",h,n);b(m,s,"node-config-input",function(){m._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var n={};m.users.forEach(function(e){n[e.z]=!0});var t=Object.keys(n).length,o=$("#node-config-dialog-scope").empty();o.off("change"),o.append('<option value=""'+(m.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),o.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(e){var t=e.label;n[e.id]&&(t="* "+t),o.append('<option value="'+e.id+'"'+(e.id==m.z?" selected":"")+">"+t+"</option>")}),o.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(e){var t=e.name;n[e.id]&&(t="* "+t),o.append('<option value="'+e.id+'"'+(e.id==m.z?" selected":"")+">"+t+"</option>")}),0<t&&o.on("change",function(){var e=$(this).val();""===e?$("#node-config-dialog-scope-warning").hide():!n[e]||1<t?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),o.i18n(),i.i18n(),!1!==s.hasUsers&&$("#node-config-dialog-user-count").find("span").html(RED._("editor.nodesUse",{count:m.users.length})).parent().show(),a()})},close:function(){RED.workspaces.refresh(),c.pop()},show:function(){m&&RED.sidebar.info.refresh(m)}};i.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var t=h,n=m.id,e=RED.nodes.getType(t);if(e.oneditcancel&&e.oneditcancel){var o=RED.nodes.node(n);if(o)try{e.oneditcancel.call(o,!1)}catch(e){console.log("oneditcancel",o.id,o.type,e.toString())}else try{e.oneditcancel.call({id:n},!0)}catch(e){console.log("oneditcancel",n,t,e.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:v?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,t,n=f,o=(m.id,h),a=v,i=RED.nodes.getType(o),s=$("#node-config-dialog-scope").val();if(i.oneditsave)try{i.oneditsave.call(m)}catch(e){console.log("oneditsave",m.id,m.type,e.toString())}for(e in i.defaults){var r;if(i.defaults.hasOwnProperty(e))if(null!=(r="checkbox"===(t=$("#node-config-input-"+e)).attr("type")?t.prop("checked"):"format"in i.defaults[e]&&""!==i.defaults[e].format&&"DIV"===t[0].nodeName?t.text():t.val())&&r!==m[e]){if(m._def.defaults[e].type){"_ADD_"==r&&(r="");var d=RED.nodes.node(m[e]);if(d){var l=d.users;l.splice(l.indexOf(m),1)}(d=RED.nodes.node(r))&&d.users.push(m)}m[e]=r}}m.label=i.label,(m.z=s)&&(m.users=m.users.filter(function(e){var t=!0;for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&e._def.defaults[n].type===m.type&&e[n]===m.id&&e.z!==s&&(t=!1,e[n]=null,e.dirty=!0,e.changed=!0,_(e));return t})),a&&RED.nodes.add(m),i.credentials&&j(m,i.credentials,"node-config-input"),_(m);var c={};c[m.id]=!0;for(var p=m.users.slice();0<p.length;){var u=p.pop();c[u.id]||(c[u.id]=!0,u.users&&(p=p.concat(u.users)),_(u))}RED.nodes.dirty(!0),RED.view.redraw(!0),a||RED.events.emit("editor:save",m),RED.tray.close(function(){k(n,o,m.id,g)})}}],v||i.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=f,t=m.id,n=h,o=RED.nodes.getType(n);try{o.ondelete&&(console.log("Deprecated API warning: config node type ",n," has an ondelete function - should be oneditdelete"),o.ondelete.call(m)),o.oneditdelete&&o.oneditdelete.call(m)}catch(e){console.log("oneditdelete",m.id,m.type,e.toString())}for(var a={t:"delete",nodes:[m],changes:{},dirty:RED.nodes.dirty()},i=0;i<m.users.length;i++){var s=m.users[i];for(var r in a.changes[s.id]={changed:s.changed,valid:s.valid},s._def.defaults)s._def.defaults.hasOwnProperty(r)&&s[r]==t&&(a.changes[s.id][r]=t,s[r]="",s.changed=!0,s.dirty=!0);_(s)}RED.nodes.remove(t),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a),RED.tray.close(function(){k(e,n,"",g)})}}),RED.tray.show(i)}function T(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function k(e,n,t,o){if(o){var a=$("#"+o+"-edit-"+e);if(a.length)t?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(t);else{var i=$("#"+o+"-"+e),s=RED.nodes.getType(n);i.children().remove();var r=RED.nodes.workspace(RED.workspaces.active());r||(r=RED.nodes.subflow(RED.workspaces.active()));var d=[];RED.nodes.eachConfig(function(e){if(e.type==n&&(!e.z||e.z===r.id)){var t=RED.utils.getNodeLabel(e,e.id);e.__label__=t,d.push(e)}});var l=T;"function"==typeof s.sort&&(l=s.sort);try{d.sort(l)}catch(e){console.log("Definition error: "+s.type+".sort",e)}d.forEach(function(e){i.append('<option value="'+e.id+'"'+(t==e.id?" selected":"")+">"+RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)+"</option>"),delete e.__label__}),i.append('<option value="_ADD_"'+(""===t?" selected":"")+">"+RED._("editor.addNewType",{type:n})+"</option>"),window.setTimeout(function(){i.change()},50)}}}var O={};return{init:function(){RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$("#node-dialog-ok").click(),$("#node-config-dialog-ok").click()}),RED.actions.add("core:cancel-edit-tray",function(){$("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()})},edit:function(d){var x,T,k=d;c.push(d),RED.view.state(RED.state.EDITING);var l=d.type;"subflow:"==d.type.substring(0,8)&&(l="subflow");var e={title:y(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],n=[],o=RED.nodes.remove(k.id);t.push(k);var a={t:"delete",nodes:t=t.concat(o.nodes),links:n=n.concat(o.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(k._def){if(k._def.oneditcancel)try{k._def.oneditcancel.call(k)}catch(e){console.log("oneditcancel",k.id,k.type,e.toString())}for(var e in k._def.defaults)if(k._def.defaults.hasOwnProperty(e)){var t=k._def.defaults[e];if(t.type){var n=RED.nodes.getType(t.type);if(n&&n.exclusive){var o=$("#node-input-"+e).val()||"";""===o||k[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t,n,o={},a=!1,i=RED.nodes.dirty();if(k._def.oneditsave){var s={};for(e in k._def.defaults)k._def.defaults.hasOwnProperty(e)&&("string"==typeof k[e]||"number"==typeof k[e]?s[e]=k[e]:s[e]=$.extend(!0,{},{v:k[e]}).v);try{!0===k._def.oneditsave.call(k)&&(a=!0)}catch(e){console.log("oneditsave",k.id,k.type,e.toString())}for(e in k._def.defaults)k._def.defaults.hasOwnProperty(e)&&(null===s[e]||"string"==typeof s[e]||"number"==typeof s[e]?s[e]!==k[e]&&(o[e]=s[e],a=!0):JSON.stringify(s[e])!==JSON.stringify(k[e])&&(o[e]=s[e],a=!0))}if(k._def.defaults)for(e in k._def.defaults)if(k._def.defaults.hasOwnProperty(e)){var r=$("#node-input-"+e);if(null!=(n="checkbox"===r.attr("type")?r.prop("checked"):"format"in k._def.defaults[e]&&""!==k._def.defaults[e].format&&"DIV"===r[0].nodeName?r.text():r.val())){if("outputs"===e){if(""===n.trim())continue;if(isNaN(n)){t=JSON.parse(n);var d=0,l=!1;Object.keys(t).forEach(function(e){isNaN(e)?(d++,delete t[e]):(t[e]=t[e]+"","-1"!==t[e]?(d++,t[e]!==e?l=!0:delete t[e]):l=!0)}),n=d,l&&(a=!0)}else n=parseInt(n)}if(k[e]!=n){if(k._def.defaults[e].type){"_ADD_"==n&&(n="");var c=RED.nodes.node(k[e]);if(c){var p=c.users;p.splice(p.indexOf(k),1)}(c=RED.nodes.node(n))&&c.users.push(k)}o[e]=k[e],k[e]=n,a=!0}}}if(k._def.credentials){var u=k._def.credentials,f=j(k,u,"node-input");a=a||f}var h=C(k,t);if(S(k,o,t)&&(a=!0),!k._def.defaults||!k._def.defaults.hasOwnProperty("icon")){var g=$("#node-settings-icon-module-hidden").val(),v=$("#node-settings-icon-file-hidden").val(),m=g&&v?g+"/"+v:"";if(x)if(m!==T)o.icon=k.icon,k.icon=m,a=!0;else{var b=RED.utils.getDefaultNodeIcon(k._def,k),y=b.module+"/"+b.file;T!==y&&(o.icon=k.icon,k.icon=y,a=!0)}else m!==k.icon&&(o.icon=k.icon,k.icon=m,a=!0)}if(a){var w=k.changed;k.changed=!0,RED.nodes.dirty(!0);var D=RED.nodes.subflow(RED.workspaces.active()),E=null;D&&(E=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(E.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,C(e))}));var R={t:"edit",node:k,changes:o,links:h,dirty:i,changed:w};t&&(R.outputMap=t),E&&(R.subflow={instances:E}),RED.history.push(R)}k.dirty=!0,_(k),RED.events.emit("editor:save",k),RED.tray.close()}}],resize:function(e){p[l]=e.width,$(".editor-tray-content").height(e.height-78);var t=$(".editor-tray-content form").height(e.height-78-40);if(k&&k._def.oneditresize)try{k._def.oneditresize.call(k,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",k.id,k.type,e.toString())}},open:function(e,t){e.find(".editor-tray-footer");var n=e.find(".editor-tray-body");n.parent().css("overflow","hidden");var o=RED.stack.create({container:n,singleExpanded:!0}),a=o.add({title:RED._("editor.nodeProperties"),expanded:!0});a.content.addClass("editor-tray-content");var i,s=o.add({title:RED._("editor.portLabels"),onexpand:function(){!function(e,t){var n,o,a=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),i=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),s=$("#node-label-form-inputs"),r=$("#node-label-form-outputs"),d=t.inputs||t._def.inputs||0,l=s.children(),c=l.length;if(1===c&&$(l[0]).hasClass("node-label-form-none")&&c--,c<d)for(0===c&&$(l[0]).remove(),o=c;o<d;o++)D("input",o,"",a).appendTo(s);else if(d<c){for(o=d;o<c;o++)$(l[o]).remove();0===n&&D().appendTo(s)}var p=$("#node-input-outputs").val();if(void 0===p)n=t.outputs||t._def.outputs||0;else if(isNaN(p)){var u=JSON.parse(p),f=Object.keys(u);l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,n=0;var h=[];f.forEach(function(e){var t=$("#node-label-form-output-"+e).parent();0===t.length&&-1!==u[e]?(0===c&&($(l[0]).remove(),c=-1),t=D("output",e,"",i)):t.detach(),-1!==u[e]&&(n++,h.push({i:parseInt(u[e]),r:t}))}),h.sort(function(e,t){return e.i-t.i}),h.forEach(function(e,t){e.r.find("label").html(t+1+"."),e.r.appendTo(r)}),0===h.length&&D("output",o,"").appendTo(r)}else n=Math.max(0,parseInt(p));if(l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,c<n)for(0===c&&$(l[0]).remove(),o=c;o<n;o++)D("output",o,"").appendTo(r);else if(n<c){for(o=n;o<c;o++)$(l[o]).remove();0===n&&D().appendTo(r)}}(this.content,d)}});s.content.addClass("editor-tray-content"),k&&RED.sidebar.info.refresh(k),i="node-red"===d._def.set.module?"node-red":d._def.set.id;var r=RED.utils.getDefaultNodeIcon(d._def,d);T=r.module+"/"+r.file,x=!d.icon||d.icon===T,w(a.content,"dialog-form",l,i),E(s.content,d),b(d,d._def,"node-input",function(){n.i18n(),t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),k&&RED.sidebar.info.refresh(k),RED.workspaces.refresh(),RED.view.redraw(!0),c.pop()},show:function(){k&&RED.sidebar.info.refresh(k)}};if(p.hasOwnProperty(l)&&(e.width=p[l]),"subflow"===l){var t=k.type.substring(8);e.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(t),$("#node-dialog-ok").click()}})}RED.tray.show(e)},editConfig:x,editSubflow:function(r){var p,u=r;c.push(r),RED.view.state(RED.state.EDITING);var e={title:y(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,n=RED.nodes.dirty(),o=$("#subflow-input-name").val();o!=u.name&&(e.name=u.name,u.name=o,t=!0);var a=p.getValue();a!=u.info&&(e.info=u.info,u.info=a,t=!0),S(u,e,null)&&(t=!0);var i=$("#node-settings-icon-module-hidden").val(),s=$("#node-settings-icon-file-hidden").val(),r=i&&s?i+"/"+s:"";if((void 0===u.icon&&"node-red/subflow.png"!==r||void 0!==u.icon&&u.icon!==r)&&(e.icon=u.icon,u.icon=r,t=!0),RED.palette.refresh(),t){var d=u.changed;u.changed=!0,_(u);var l=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+u.id&&(l.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,C(e),_(e))}),RED.nodes.dirty(!0);var c={t:"edit",node:u,changes:e,dirty:n,changed:d,subflow:{instances:l}};RED.history.push(c)}u.dirty=!0,RED.tray.close()}}],resize:function(e){$(".editor-tray-content").height(e.height-78),$(".editor-tray-content form").height(e.height-78-40);for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)n-=$(t[o]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",n+"px"),p.resize()},open:function(e){e.find(".editor-tray-footer");var t=e.find(".editor-tray-body");t.parent().css("overflow","hidden");var n=RED.stack.create({container:t,singleExpanded:!0}),o=n.add({title:RED._("editor.nodeProperties"),expanded:!0});o.content.addClass("editor-tray-content");var a=n.add({title:RED._("editor.portLabels")});a.content.addClass("editor-tray-content"),u&&RED.sidebar.info.refresh(u),w(o.content,"dialog-form","subflow-template"),p=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""}),$("#subflow-input-name").val(r.name),RED.text.bidi.prepareInput($("#subflow-input-name")),p.getSession().setValue(r.info||"",-1);var i=0,s="subflow:"+u.id;RED.nodes.eachNode(function(e){e.type===s&&i++}),$("#subflow-dialog-user-count").html(RED._("subflow.subflowInstances",{count:i})).show(),E(a.content,r),d(r),t.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(u),RED.workspaces.refresh(),p.destroy(),c.pop(),u=null},show:function(){}};RED.tray.show(e)},editExpression:function(e){var i="_";0<c.length&&(i=c[c.length-1].id);var u,d,f,s,r=e.value,t=e.complete,n="_expression";c.push({type:n}),RED.view.state(RED.state.EDITING);var h={title:y(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#node-input-expression-help").html(""),t(u.getValue()),RED.tray.close()}}],resize:function(e){e&&(p[n]=e.width);var t=$("#dialog-form").height();s&&s.resize(t)},open:function(e){e.find(".editor-tray-body").addClass("node-input-expression-editor");var t=w(e.find(".editor-tray-body"),"dialog-form","_expression","editor"),l=$("#node-input-expression-func");Object.keys(jsonata.functions).forEach(function(e){l.append($("<option></option>").val(e).text(e))}),l.change(function(e){var t=$(this).val(),n="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",o=marked(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#node-input-expression-help").html(n+"<p>"+o+"</p>")}),u=RED.editor.createEditor({id:"node-input-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}});var c=null,p=-1;u.getSession().setValue(r||"",-1),u.on("changeSelection",function(){var e=u.getCursorPosition(),t=u.getSession().getTokenAt(e.row,e.column);if(t!==c||t&&/paren/.test(t.type)&&e.column!==p){var n,o,a=null;if((c=t)&&"keyword"===t.type)n=e.row,a=t;else{var i=0,s=!1;for(t?("paren.rparen"===t.type&&(p=e.column,i=e.column-(t.start+t.value.length)),n=e.row,o=t.index):(n=e.row-1,o=-1);null===a&&-1<n;){var r=u.getSession().getTokens(n);for(-1===o&&(o=r.length-1);-1<o;){var d=r[o].type;if(s){if("keyword"===d){a=r[o];break}s=!1}"paren.lparen"===d?i-=r[o].value.length:"paren.rparen"===d&&(i+=r[o].value.length),i<0&&(s=!0,i=0),o--}a||n--}}u.session.removeMarker(null),a&&l.val(a.value).change()}}),t.i18n(),$("#node-input-expression-func-insert").click(function(e){e.preventDefault(),u.getCursorPosition();var t=l.val(),n=jsonata.getFunctionSnippet(t);u.insertSnippet(n),u.focus()}),$("#node-input-expression-reformat").click(function(e){e.preventDefault();var t=u.getValue()||"";try{t=jsonata.format(t)}catch(e){}u.getSession().setValue(t||"",-1)});var n,o=RED.tabs.create({element:$("#node-input-expression-tabs"),onchange:function(e){$(".node-input-expression-tab-content").hide(),e.content.show(),h.resize()}});o.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#node-input-expression-tab-help")}),o.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#node-input-expression-tab-test")}),d=RED.editor.createEditor({id:"node-input-expression-test-data",value:O[i]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".node-input-expression-legacy").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});var a=function(){var e,t,n=d.getValue(),o=u.getValue(),a=!1,i=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(o);$(".node-input-expression-legacy").toggle(i);try{(t=jsonata(o)).assign("flowContext",function(e){return a=!0,null}),t.assign("globalContext",function(e){return a=!0,null})}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(n)}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var s,r=t.evaluate(i?{msg:e}:e);if(a)return void f.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);s=void 0!==r?JSON.stringify(r,null,4):RED._("expressionEditor.noMatch"),f.setValue(s,-1)}catch(e){f.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};d.getSession().on("change",function(){clearTimeout(n),n=setTimeout(a,200),O[i]=d.getValue()}),u.getSession().on("change",function(){clearTimeout(n),n=setTimeout(a,200)}),f=RED.editor.createEditor({id:"node-input-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),s=RED.panels.create({id:"node-input-expression-panels",resize:function(e,t){var n=$("#node-input-expression-panel-expr");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-expression").css("height",e-5+"px"),u.resize(),t-=$("#node-input-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".node-input-expression-tab-content").height(t),$("#node-input-expression-test-data").css("height",t-5+"px"),d.resize(),$("#node-input-expression-test-result").css("height",t-5+"px"),f.resize()}}),$("#node-input-example-reformat").click(function(e){e.preventDefault();var t=d.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}d.getSession().setValue(t||"",-1)}),a()},close:function(){c.pop(),u.destroy(),d.destroy()},show:function(){}};RED.tray.show(h)},editJSON:function(n){var a,o,i=n.value,e=n.complete;c.push({type:"_json"}),RED.view.state(RED.state.EDITING);var s=function(){var e=a.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}},t={title:n.title||y(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){n.requireValid&&!s()||(e(a.getValue()),RED.tray.close())}}],resize:function(e){p._json=e.width;for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)n-=$(t[o]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",n+"px"),a.resize()},open:function(e){e.find(".editor-tray-body");var t=w(e.find(".editor-tray-body"),"dialog-form","_json","editor");(a=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(i||"",-1),n.requireValid&&(a.getSession().on("change",function(){clearTimeout(o),o=setTimeout(s,200)}),s()),$("#node-input-json-reformat").click(function(e){e.preventDefault();var t=a.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}a.getSession().setValue(t||"",-1)}),t.i18n()},close:function(){c.pop(),a.destroy()},show:function(){}};RED.tray.show(t)},editMarkdown:function(n){var a,o=n.value,e=n.complete,i="_markdown";c.push({type:i}),RED.view.state(RED.state.EDITING);var t={title:n.title||y(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(a.getValue()),RED.tray.close()}}],resize:function(e){p[i]=e.width;for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)n-=$(t[o]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",n+"px"),a.resize()},open:function(e){e.find(".editor-tray-body");var t=w(e.find(".editor-tray-body"),"dialog-form",i,"editor");a=RED.editor.createEditor({id:"node-input-markdown",value:o,mode:"ace/mode/markdown"}),n.header&&n.header.appendTo(e.find("#node-input-markdown-title")),t.i18n()},close:function(){c.pop(),a.destroy()},show:function(){}};RED.tray.show(t)},editBuffer:function(e){var i=e.value,t=e.complete,s="_buffer";c.push({type:s}),RED.view.state(RED.state.EDITING);var r,d,l=[],n={title:y(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){t(JSON.stringify(r)),RED.tray.close()}}],resize:function(e){e&&(p[s]=e.width);var t=$("#dialog-form").height();d&&d.resize(t)},open:function(e){e.find(".editor-tray-body");var t,n=w(e.find(".editor-tray-body"),"dialog-form",s,"editor");(l=RED.editor.createEditor({id:"node-input-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(i||"",-1),bufferBinEditor=RED.editor.createEditor({id:"node-input-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});var o=function(e){var t=!0,n="string"==typeof e,o=[],a=0,i=(r=n?function(e){var t=[],n=0,o=e.length;for(n=0;n<o;n++){var a=e.charCodeAt(n);a<128?t.push(a):(a<2048?t.push(192|a>>6):(a<55296||57344<=a?t.push(224|a>>12):(n++,a=65536+((1023&a)<<10|1023&e.charAt(n)),t.push(240|a>>18),t.push(128|a>>12&63)),t.push(128|a>>6&63)),t.push(128|63&a))}return t}(e):e).length;for(a=0;a<i;a++){var s=parseInt(r[a]);if(!n&&(isNaN(s)||s<0||255<s)){t=!1;break}0<a&&(a%8==0?a%16==0?o.push("\n"):o.push("  "):o.push(" ")),o.push((s<16?"0":"")+s.toString(16).toUpperCase())}return t&&($("#node-input-buffer-type-string").toggle(n),$("#node-input-buffer-type-array").toggle(!n),bufferBinEditor.setValue(o.join(""),1)),t},a=function(){var e=l.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var n=JSON.parse(e);t=o(n)}catch(e){t=!1}}t||o(e)};l.getSession().on("change",function(){clearTimeout(t),t=setTimeout(a,200)}),a(),n.i18n(),d=RED.panels.create({id:"node-input-buffer-panels",resize:function(e,t){var n=$("#node-input-buffer-panel-str");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-str").css("height",e-5+"px"),l.resize();var a=$("#node-input-buffer-panel-bin");o=$(a.children()[0]),t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".node-input-buffer-type").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("bufferEditor.modeDesc")),RED.sidebar.info.show()})},close:function(){c.pop(),l.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(n)},validateNode:_,updateNodeProperties:C,createEditor:function(e){var t=ace.edit(e.id||e.element);t.setTheme("ace/theme/tomorrow");var o=t.getSession();return o.on("changeAnnotation",function(){for(var e=o.getAnnotations()||[],t=e.length,n=e.length;t--;)/doctype first\. Expected/.test(e[t].text)?e.splice(t,1):/Unexpected End of file\. Expected/.test(e[t].text)&&e.splice(t,1);n>e.length&&o.setAnnotations(e)}),e.mode&&o.setMode(e.mode),e.foldStyle?o.setFoldStyle(e.foldStyle):o.setFoldStyle("markbeginend"),e.options?t.setOptions(e.options):t.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),e.readOnly&&(t.setOption("readOnly",e.readOnly),t.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&t.renderer.setOption("showGutter",e.lineNumbers),t.$blockScrolling=1/0,e.value&&o.setValue(e.value,-1),e.globals&&setTimeout(function(){o.$worker&&o.$worker.send("setOptions",[{globals:e.globals,esversion:6,sub:!0,asi:!0,maxerr:1e3}])},100),t}}}(),RED.tray=function(){var v=[],m=$("#editor-stack"),b=!1;function n(e){var n=$('<div class="editor-tray"></div>'),t=$('<div class="editor-tray-header"></div>').appendTo(n),o=$('<div class="editor-tray-body-wrapper"></div>').appendTo(n),a=$('<div class="editor-tray-body"></div>').appendTo(o),i=$('<div class="editor-tray-footer"></div>').appendTo(n),s=$('<div class="editor-tray-resize-handle"></div>').appendTo(n);if(e.title){var r=v.map(function(e){return e.options.title});r.push(e.title);var d='<ul class="editor-tray-breadcrumbs"><li>'+r.join("</li><li>")+"</li></ul>";$('<div class="editor-tray-titlebar">'+d+"</div>").appendTo(t)}e.width===1/0&&(e.maximized=!0,s.addClass("editor-tray-resize-maximised"));var l,c=$('<div class="editor-tray-toolbar"></div>').appendTo(t);if(e.buttons)for(var p=0;p<e.buttons.length;p++){var u=e.buttons[p],f=$("<button>").button().appendTo(c);u.id&&f.attr("id",u.id),u.text&&f.html(u.text),u.click&&f.click(function(t){return function(e){$(this).hasClass("disabled")||t(e)}}(u.click)),u.class&&(f.addClass(u.class),"primary"===u.class&&(l=u))}n.appendTo(m);var h={tray:n,header:t,body:a,footer:i,options:e,primaryButton:l};function g(){$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),h.preferredWidth=Math.max(n.width(),500),e.maximized||a.css({minWidth:h.preferredWidth-40}),e.width?(e.width>$("#editor-stack").position().left-8&&(e.width=$("#editor-stack").position().left-8),n.width(e.width)):n.width(h.preferredWidth),h.width=n.width(),h.width>$("#editor-stack").position().left-8&&(h.width=Math.max(0,$("#editor-stack").position().left-8),n.width(h.width)),n.css({right:-(n.width()+10)+"px",transition:"right 0.25s ease"}),$("#workspace").scrollLeft(0),y(),b=!0,setTimeout(function(){setTimeout(function(){e.width||n.width(Math.min(h.preferredWidth,$("#editor-stack").position().left-8)),e.resize&&e.resize({width:n.width()}),e.show&&e.show(),setTimeout(function(){b=!1},200),a.find(":focusable:first").focus()},150),n.css({right:0})},0)}v.push(h),e.maximized||n.draggable({handle:s,axis:"x",start:function(e,t){n.width("auto")},drag:function(e,t){var n=m.position().left+t.position.left;n<7?t.position.left+=7-n:t.position.left>-h.preferredWidth-1&&(t.position.left=-Math.min(m.position().left-7,h.preferredWidth-1)),h.options.resize&&setTimeout(function(){h.options.resize({width:-t.position.left})},0),h.width=-t.position.left},stop:function(e,t){n.width(-t.position.left),n.css({left:""}),h.options.resize&&h.options.resize({width:-t.position.left}),h.width=-t.position.left}}),e.open?1===e.open.length?(e.open(n),g()):e.open(n,g):g()}function y(){if(0<v.length){var e=v[v.length-1],t=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight();e.body.height(t),e.options.maximized||e.width>$("#editor-stack").position().left-8?(e.width=$("#editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width)),e.options.resize&&e.options.resize({width:e.width,height:t})}}return{init:function(){$(window).resize(y),RED.events.on("sidebar:resize",y),$("#editor-shade").click(function(){if(!b){var e=v[v.length-1];e&&e.primaryButton&&e.primaryButton.click()}})},show:function(e){if(0<v.length&&!e.overlay){var t=v[v.length-1];"inherit"===e.width&&(e.width=t.tray.width()),t.tray.css({right:-(t.tray.width()+10)+"px"}),setTimeout(function(){t.tray.detach(),n(e)},250)}else RED.events.emit("editor:open"),n(e)},close:function(t){if(0<v.length){var n=v.pop();n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){if(n.options.close&&n.options.close(),n.tray.remove(),0<v.length){var e=v[v.length-1];e.options.overlay?(y(),e.options.show&&e.options.show()):(e.tray.appendTo("#editor-stack"),setTimeout(function(){y(),e.tray.css({right:0}),e.options.show&&e.options.show()},0))}t&&t(),0===v.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){var e,t,n,o,a=!1;function i(){var t=$("#clipboard-import"),n=t.val();n=n.substring(n.indexOf("["),n.lastIndexOf("]")+1);try{JSON.parse(n),t.removeClass("input-error"),t.val(n),$("#clipboard-dialog-ok").button("enable")}catch(e){""!==n&&t.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function s(){a||(t.empty(),t.append($(o)),t.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(i),$("#clipboard-import").on("paste",function(){setTimeout(i,10)}),$("#import-tab > a").click(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"))}function r(){if(!a){t.empty(),t.append($(n)),t.i18n();var r=RED.settings.flowFilePretty?"export-format-full":"export-format-mini";$("#export-format-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#clipboard-export").val();if(0<t.length){var n=JSON.parse(t);t="export-format-full"===(r=$(this).attr("id"))?JSON.stringify(n,null,4):JSON.stringify(n),$("#clipboard-export").val(t),$("#clipboard-export").focus()}}}),$("#export-range-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),n="",o=null;if("export-range-selected"===t){var a=RED.view.selection();o=RED.nodes.createExportableNodeSet(a.nodes.filter(function(e){return"subflow"!==e.type}))}else if("export-range-flow"===t){var i=RED.workspaces.active();o=RED.nodes.filterNodes({z:i});var s=RED.nodes.workspace(i)||RED.nodes.subflow(i);o.unshift(s),o=RED.nodes.createExportableNodeSet(o)}else"export-range-full"===t&&(o=RED.nodes.createCompleteNodeSet(!1));null!==o&&(n="export-format-full"===r?JSON.stringify(o,null,4):JSON.stringify(o)),0<n.length?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(n),$("#clipboard-export").focus()}}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide(),RED.view.selection().nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),"export-format-full"===r?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var e=$(this);e.select(),e.mouseup(function(){return e.unbind("mouseup"),!1})}),e.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#clipboard-export").focus(),document.queryCommandSupported("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show())}}function d(){$("#dropTarget").hide(),RED.keyboard.remove("escape")}return{init:function(){e=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported")),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),t=e.children(".dialog-form"),n='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',o='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',$('<input type="text" id="clipboard-hidden">').appendTo("body"),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.actions.add("core:show-export-dialog",r),RED.actions.add("core:show-import-dialog",s),RED.events.on("editor:open",function(){a=!0}),RED.events.on("editor:close",function(){a=!1}),RED.events.on("search:open",function(){a=!0}),RED.events.on("search:close",function(){a=!1}),RED.events.on("type-search:open",function(){a=!0}),RED.events.on("type-search:close",function(){a=!1}),$("#chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#dropTarget").css({display:"table"}),RED.keyboard.add("*","escape",d))}),$("#dropTarget").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){d()}).on("drop",function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t)}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var n=e.originalEvent.dataTransfer.files;if(1===n.length){var o=n[0],a=new FileReader;a.onload=function(e){RED.view.importNodes(e.target.result)},a.readAsText(o)}}d(),e.preventDefault()})},import:s,export:r,copyText:function(e,t,n){var o=!1;"string"!=typeof e&&(e=JSON.stringify(e,function(e,t){return null!==t&&"object"==typeof t&&t.__encoded__&&t.hasOwnProperty("data")&&t.hasOwnProperty("length")?(o=t.data.length!==t.length,t.data):t})),o&&(n+="_truncated"),$("#clipboard-hidden").val(e).select();var a=document.execCommand("copy");if(a&&t){var i=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(n)});setTimeout(function(){i.close()},1e3),i.open()}return a}}}(),RED.library=function(){var t,p="node-input-";function e(){$.getJSON("library/flows",function(e){var t,r=function(e,t){var n,o,a,i=document.createElement("ul");if(""===t&&(i.id="menu-item-import-library-submenu"),i.className="dropdown-menu",e.d)for(n in e.d)if(e.d.hasOwnProperty(n)){(o=document.createElement("li")).className="dropdown-submenu pull-left",(a=document.createElement("a")).href="#";var s=n.replace(/^@.*\//,"").replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/," ").replace(/_/," ");a.innerHTML=s,o.appendChild(a),o.appendChild(r(e.d[n],t+(""!==t?"/":"")+n)),i.appendChild(o)}if(e.f)for(n in e.f)e.f.hasOwnProperty(n)&&(o=document.createElement("li"),(a=document.createElement("a")).href="#",a.innerHTML=e.f[n],a.flowName=t+(""!==t?"/":"")+e.f[n],a.onclick=function(){$.get("library/flows/"+this.flowName,function(e){RED.view.importNodes(e)})},o.appendChild(a),i.appendChild(o));return i};e.d&&e.d._examples_&&(t=e.d._examples_,delete e.d._examples_);var n=r(e,"");$("#menu-item-import-examples").remove(),t&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(r(t,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(n)})}function n(){var e=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(e)),t.dialog("open")}return{init:function(){RED.actions.add("core:library-export",n),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),!1!==RED.settings.theme("menu.menu-item-import-library")&&e(),(t=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var e=$("#node-input-library-filename").val();/^\s*$/.test(e)||$.ajax({url:"library/flows/"+e,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}})).children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:function(d){var s=null,r=null;function l(e){var t=document.createElement("li");return t.onmouseover=function(e){$(this).addClass("list-hover")},t.onmouseout=function(e){$(this).removeClass("list-hover")},t}function c(a,e){for(var t,n=document.createElement("ul"),o=0;o<e.length;o++){var i=e[o];"string"==typeof i?((t=l()).onclick=function(){var o=i;return function(e){var t=$('<li class="active"><span class="divider">/</span> <a href="#">'+o+"</a></li>");$("a",t).click(function(e){$(this).parent().nextAll().remove(),$.getJSON("library/"+d.url+a+o,function(e){$("#node-select-library").children().first().replaceWith(c(a+o+"/",e))}),e.stopPropagation()});var n=$("#node-dialog-library-breadcrumbs");$(".active",n).removeClass("active"),n.append(t),$.getJSON("library/"+d.url+a+o,function(e){$("#node-select-library").children().first().replaceWith(c(a+o+"/",e))})}}(),t.innerHTML='<i class="fa fa-folder"></i> '+i+"</i>"):((t=l()).innerHTML=i.name,t.onclick=function(){var t=i;return function(e){$(".list-selected",n).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+d.url+a+t.fn,function(e){s=t,r.setValue(e,-1)})}}()),n.appendChild(t)}return n}function e(e){var t=$("#"+p+"name").val().replace(/(^\s*)|(\s*$)/g,"");""===t&&(t=RED._("library.unnamedType",{type:d.type}));var n=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),o=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""!==n&&/.+\.js$/.test(n)){for(var a=o+(""===o?"":"/")+n,i={},s=0;s<d.fields.length;s++){var r=d.fields[s];"name"==r?i.name=t:i[r]=$("#"+p+r).val()}i.text=d.editor.getValue(),$.ajax({url:"library/"+d.url+"/"+a,type:"POST",data:JSON.stringify(i),contentType:"application/json; charset=utf-8"}).done(function(e,t,n){RED.notify(RED._("library.savedType",{type:d.type}),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}else RED.notify(RED._("library.invalidFilename"),"warning")}p=d.elementPrefix||"node-input-",d.editor.setText&&(d.editor.setValue=function(e,t){d.editor.setText.call(d.editor,e)}),d.editor.getText&&(d.editor.getValue=d.editor.getText),$("#"+p+"name").css("width","calc(100% - 52px)").after('<div class="btn-group" style="margin-left:5px;"><a id="node-input-'+d.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+d.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+d.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+d.type+"-menu-open-library").click(function(e){$("#node-select-library").children().remove(),$("#node-dialog-library-breadcrumbs").children().first().nextAll().remove(),r.setValue("",-1),$.getJSON("library/"+d.url,function(t){$("#node-select-library").append(c("/",t)),$("#node-dialog-library-breadcrumbs a").click(function(e){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(c("/",t)),e.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),e.preventDefault()}),$("#node-input-"+d.type+"-menu-save-library").click(function(e){var t=$("#"+p+"name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var n=t.replace(/[^\w-]/g,"-");""===n&&(n="unnamed-"+d.type),$("#node-dialog-library-save-filename").attr("value",n+".js"),$("#node-dialog-library-save").dialog("open"),e.preventDefault()}),(r=ace.edit("node-select-library-text")).setTheme("ace/theme/tomorrow"),d.mode&&r.getSession().setMode(d.mode),r.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),r.renderer.$cursorLayer.element.style.opacity=0,r.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:d.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(s){for(var e=0;e<d.fields.length;e++){var t=d.fields[e];$("#"+p+t).val(s[t])}d.editor.setValue(r.getValue(),-1)}$(this).dialog("close")}}],open:function(e){var t=$("form",this);t.height(t.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",t).children().height(t.height()-60)},resize:function(e){var t=$("form",this);t.height(t.parent().height()-30),$(".form-row:last-child",t).children().height(t.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){e(),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){e(),$(this).dialog("close")}}]})},loadFlowLibrary:e,export:n}}(),RED.notifications=function(){var m,b={},y=[],w=0;function e(e,t,n,o){var a={};if(null!==t&&"object"==typeof t&&(n=(a=t).fixed,o=a.timeout,t=a.type),a.modal&&$("#full-shade").show(),4<y.length)for(var i=y.length,s=0;4<i&&s<y.length;s+=1){var r=y[s];r.fixed||(window.clearTimeout(r.timeoutid),r.close(),i-=1)}var d,l,c,p,u,f=document.createElement("div");if(f.id="red-notification-"+w,f.className="notification",f.fixed=n,t&&(f.className="notification notification-"+t),a.width){var h=$("#notifications").width();if(a.width>h){var g=-(a.width-h)/2;$(f).css({width:a.width+"px",marginLeft:g+"px"})}}if(f.style.display="none","string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),f.innerHTML=e):$(f).append(e),a.buttons){var v=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(f);a.buttons.forEach(function(e){var t=$("<button>").html(e.text).click(e.click).appendTo(v);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}return $("#notifications").append(f),$(f).slideDown(300),f.close=(d=f,function(){d.closed||(d.closed=!0,y.splice(y.indexOf(d),1),a.id&&(delete b[a.id],0===Object.keys(b).length&&m.hide()),$(d).slideUp(300,function(){d.parentNode.removeChild(d)}),a.modal&&$("#full-shade").hide())}),f.hideNotification=(l=f,function(){l.closed||(l.hidden=!0,$(l).slideUp(300))}),f.showNotification=(c=f,function(){!c.closed&&c.hidden&&(c.hidden=!1,$(c).slideDown(300))}),f.update=(p=f,function(e,t){var n;if("string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),p.innerHTML=e):$(p).empty().append(e),"number"==typeof t)n=t;else if(void 0!==t&&(n=t.timeout,t.buttons)){var o=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(p);t.buttons.forEach(function(e){var t=$("<button>").html(e.text).click(e.click).appendTo(o);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}void 0!==n&&0<n?(window.clearTimeout(p.timeoutid),p.timeoutid=window.setTimeout(p.close,n)):window.clearTimeout(p.timeoutid),p.hidden&&p.showNotification()}),n||($(f).click((u=f,function(){u.close(),window.clearTimeout(u.timeoutid)})),f.timeoutid=window.setTimeout(f.close,o||5e3)),y.push(f),a.id&&(b[a.id]=f,m.show()),w+=1,f}return{init:function(){m=$('<li><a id="btn-notifications" class="button" href="#"><i class="fa fa-warning"></i></a></li>').prependTo(".header-toolbar").hide(),$("#btn-notifications").click(function(){!function(){for(var e in b)b.hasOwnProperty(e)&&b[e].showNotification()}()})},notify:RED.notify=e}}(),RED.search=function(){var n,d,e=!1,o=null,l=-1,t=!1,c={},p=[],u=[];function a(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),c[t]=c[t]||{},c[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var n=["id","type","name","label","info"];e._def&&e._def.defaults&&(n=n.concat(Object.keys(e._def.defaults)));for(var o=0;o<n.length;o++)if(e.hasOwnProperty(n[o])){var a=e[n[o]];"string"!=typeof a&&"number"!=typeof a||(a=(""+a).toLowerCase(),c[a]=c[a]||{},c[a][e.id]={node:e,label:t})}}function i(){var e=d.find("li.selected");if(1===e.length){var t=d.parent(),n=t.height(),o=(t.scrollTop(),e.position().top),a=e.height();n<o+a?t.animate({scrollTop:"-="+(n-(o+a)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function s(){o=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(o);(n=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(e).searchBox({delay:200,change:function(){!function(e){if(d.editableList("empty"),l=-1,u=[],0<e.length){var t,n;e=e.toLowerCase();var o=[],a={};for(t=0;t<p.length;t++){var i=p[t],s=p[t].indexOf(e);if(-1<s)for(n=0;n<c[i].length;n++){var r=c[i][n];a[r.node.id]=a[r.node.id]=r,a[r.node.id].index=Math.min(a[r.node.id].index||1/0,s)}}for((o=Object.keys(a)).sort(function(e,t){return a[e].index-a[t].index}),t=0;t<o.length;t++)u.push(a[o[t]]);if(0<u.length)for(t=0;t<Math.min(u.length,25);t++)d.editableList("addItem",u[t]);else d.editableList("addItem",{})}}($(this).val())}})).on("keydown",function(e){var t;0<u.length&&(40===e.keyCode?(t=d.children(),l<t.length-1&&(-1<l&&$(t[l]).removeClass("selected"),l++),$(t[l]).addClass("selected"),i(),e.preventDefault()):38===e.keyCode?(t=d.children(),0<l&&(l<t.length&&$(t[l]).removeClass("selected"),l--),$(t[l]).addClass("selected"),i(),e.preventDefault()):13===e.keyCode&&0<u.length&&f(u[Math.max(0,l)].node))}),n.i18n();var t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(o);d=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,n){var o=n.node;if(void 0===o)$("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e);else{var a=o._def,i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),s=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),r=a.color,d=RED.utils.getNodeIcon(a,o);"tab"===o.type&&(r="#C0DEED"),s.css("backgroundColor",r);var l=$("<div/>",{class:"palette_icon_container"}).appendTo(s);$("<div/>",{class:"palette_icon",style:"background-image: url("+d+")"}).appendTo(l);var c=$("<div>",{class:"red-ui-search-result-description"}).appendTo(i);if(o.z){var p=RED.nodes.workspace(o.z);p=p?"flow:"+p.label:"subflow:"+(p=RED.nodes.subflow(o.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).html(p).appendTo(c)}$("<div>",{class:"red-ui-search-result-node-label"}).html(n.label||o.id).appendTo(c),$("<div>",{class:"red-ui-search-result-node-type"}).html(o.type).appendTo(c),$("<div>",{class:"red-ui-search-result-node-id"}).html(o.id).appendTo(c),i.click(function(e){e.preventDefault(),f(o)})}},scrollOnAdd:!1})}function f(e){h(),RED.view.reveal(e.id)}function r(){e||(t||(RED.keyboard.add("*","escape",function(){h()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),c={},RED.nodes.eachWorkspace(a),RED.nodes.eachSubflow(a),RED.nodes.eachConfig(a),RED.nodes.eachNode(a),(p=Object.keys(c)).sort(),p.forEach(function(t){c[t]=Object.keys(c[t]).map(function(e){return c[t][e]})}),null===o&&s(),o.slideDown(300),RED.events.emit("search:open"),t=!0),n.focus())}function h(){t&&(RED.keyboard.remove("escape"),t=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==o&&o.slideUp(200,function(){n.searchBox("value","")}),RED.events.emit("search:close"))}return{init:function(){RED.actions.add("core:search",r),RED.events.on("editor:open",function(){e=!0}),RED.events.on("editor:close",function(){e=!1}),RED.events.on("type-search:open",function(){e=!0}),RED.events.on("type-search:close",function(){e=!1}),$("#header-shade").on("mousedown",h),$("#editor-shade").on("mousedown",h),$("#palette-shade").on("mousedown",h),$("#sidebar-shade").on("mousedown",h)},show:r,hide:h}}(),RED.typeSearch=function(){var r,d,t,n,o,a=null,l=-1,i=!1,s="",c={};function p(){var e=d.find("li.selected");if(1===e.length){var t=d.parent(),n=t.height(),o=(t.scrollTop(),e.position().top),a=e.height();n<o+a?t.animate({scrollTop:"-="+(n-(o+a)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function u(){a=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(a);(r=$('<input type="text">').attr("placeholder",RED._("search.addNode")).appendTo(e).searchBox({delay:50,change:function(){var e;e=$(this).val(),s=e.toLowerCase(),d.editableList("filter"),d.editableList("sort"),setTimeout(function(){l=0,d.children().removeClass("selected"),d.children(":visible:first").addClass("selected")},100)}})).on("keydown",function(e){var t=d.children(":visible");if(0<t.length)if(40===e.keyCode)l<t.length-1&&(-1<l&&$(t[l]).removeClass("selected"),l++),$(t[l]).addClass("selected"),p(),e.preventDefault();else if(38===e.keyCode)0<l&&(l<t.length&&$(t[l]).removeClass("selected"),l--),$(t[l]).addClass("selected"),p(),e.preventDefault();else if(13===e.keyCode){var n=Math.max(0,l);n<t.length&&f($(t[n]).find(".red-ui-editableList-item-content").data("data"))}}),t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(a),d=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(t).editableList({addButton:!1,filter:function(e){return""===s||!e.recent&&!e.common&&(""===s||-1<e.index.indexOf(s))},sort:function(e,t){if(""===s)return e.i-t.i;var n=e.index.indexOf(s),o=t.index.indexOf(s);return-1===n?1:-1===o?-1:n===o?m(e,t):n-o},addItem:function(e,t,n){var o=n.def;n.index=n.type.toLowerCase(),n.separator&&e.addClass("red-ui-search-result-separator");var a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),i=$("<div>",{class:"red-ui-search-result-node"}).appendTo(a),s=o.color,r=RED.utils.getNodeIcon(o);i.css("backgroundColor",s);var d=$("<div/>",{class:"palette_icon_container"}).appendTo(i);$("<div/>",{class:"palette_icon",style:"background-image: url("+r+")"}).appendTo(d),0<o.inputs&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(i),0<o.outputs&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(i);var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(a),c=n.label;n.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).html(c).appendTo(l),a.click(function(e){e.preventDefault(),f(n)})},scrollOnAdd:!1})}function f(e){g(),c[e.type]=Date.now(),n(e.type)}function h(e){if(i){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}g(!0),o&&o()}}function g(e){i&&(RED.keyboard.remove("escape"),i=!1,null!==a&&t.slideUp(e?50:200,function(){a.hide(),r.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"))}function v(t,e){var n=t;if(void 0!==e.paletteLabel)try{n=("function"==typeof e.paletteLabel?e.paletteLabel.call(e):e.paletteLabel)||"",n+=" ("+t+")"}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}return n}function m(e,t){var n=e.label.toLowerCase(),o=t.label.toLowerCase();return n<o?-1:n===o?0:1}return{show:function(e){i?(a.hide(),t.hide()):(RED.keyboard.add("*","escape",function(){g(),o&&o()}),null===a&&u(),i=!0,setTimeout(function(){$(document).on("mousedown.type-search",h),$(document).on("mouseup.type-search",h),$(document).on("click.type-search",h)},200)),function(){var e;d.editableList("empty"),r.searchBox("value",""),l=-1;var t=["inject","debug","function","change","switch"],n=Object.keys(c);n.sort(function(e,t){return c[t]-c[e]}),n=n.filter(function(e){return-1===t.indexOf(e)});var o=[];RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&o.push({type:e,def:t,label:v(e,t)})}),o.sort(m);var a,i=0;for(e=0;e<t.length;e++){var s=RED.nodes.getType(t[e]);s&&((a={type:t[e],common:!0,def:s,i:i++}).label=v(a.type,a.def),e===t.length-1&&(a.separator=!0),d.editableList("addItem",a))}for(e=0;e<Math.min(5,n.length);e++)(a={type:n[e],def:RED.nodes.getType(n[e]),recent:!0,i:i++}).label=v(a.type,a.def),e===n.length-1&&(a.separator=!0),d.editableList("addItem",a);for(e=0;e<o.length;e++)o[e].i=i++,d.editableList("addItem",o[e]);setTimeout(function(){l=0,d.children(":first").addClass("selected")},100)}(),n=e.add,closeCallback=e.close,RED.events.emit("type-search:open"),a.css({left:e.x+"px",top:e.y+"px"}).show(),t.slideDown(300),setTimeout(function(){t.find(".red-ui-editableList-container").scrollTop(0),r.focus()},100)},hide:g}}(),RED.subflow=function(){function d(e,t){var n={x:50,y:30};t||(n.x+=110);for(var o=0;o<e.out.length+e.in.length;o++){var a;(a=o<e.out.length?e.out[o]:e.in[o-e.out.length]).x==n.x&&a.y==n.y&&(n.x+=55,o=0)}return n}function s(){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.in.length){var n=t.in[0],o=[];return RED.nodes.eachLink(function(e){"subflow"==e.source.type&&e.source.z==t.id&&e.source.i==n.i?o.push(e):e.target.type=="subflow:"+t.id&&o.push(e)}),o.forEach(function(e){RED.nodes.removeLink(e)}),t.in=[],$("#workspace-subflow-input-add").removeClass("active"),$("#workspace-subflow-input-remove").addClass("active"),t.changed=!0,{subflowInputs:[n],links:o}}}function r(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var n=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var o=e[i];t.out.splice(o.i,1);var a=[],s=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==o.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==o.i?a.push(e):e.sourcePort>o.i&&s.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),s.forEach(function(e){e.sourcePort--}),n=n.concat(a);for(var r=o.i;r<t.out.length;r++)t.out[r].i--,t.out[r].dirty=!0}return t.changed=!0,{subflowOutputs:e,links:n}}}function l(t){var n=RED.nodes.subflow(RED.workspaces.active());a(n);var o=[];if(n)return RED.nodes.filterNodes({type:"subflow:"+n.id}).forEach(function(e){for(o.push({id:e.id,changed:e.changed}),t&&(e.changed=!0),e.inputs=n.in.length,e.outputs=n.out.length;e.outputs<e.ports.length;)e.ports.pop();e.resize=!0,e.dirty=!0,RED.editor.updateNodeProperties(e)}),RED.editor.validateNode(n),{instances:o}}function a(e){e&&($("#workspace-subflow-input-add").toggleClass("active",0!==e.in.length),$("#workspace-subflow-input-remove").toggleClass("active",0===e.in.length),$("#workspace-subflow-output .spinner-value").html(e.out.length))}function n(i){var e=$("#workspace-toolbar");e.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="workspace-subflow-input-remove" class="button active" href="#">0</a><a id="workspace-subflow-input-add" class="button" href="#">1</a></div>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(e),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(e),e.i18n(),$("#workspace-subflow-output-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=i.changed,o=r();if(o){var a=l(!0);RED.history.push({t:"delete",links:o.links,subflowOutputs:o.subflowOutputs,changed:n,dirty:t,subflow:{instances:a.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(e){e.preventDefault(),function(e){var t=RED.nodes.subflow(RED.workspaces.active()),n=d(t,!1),o={type:"subflow",direction:"out",z:t.id,i:t.out.length,x:n.x,y:n.y,id:RED.nodes.id()},a=t.out.length;t.out.push(o),t.dirty=!0;var i=RED.nodes.dirty(),s=t.changed;t.changed=!0;var r={t:"edit",node:t,dirty:i,changed:s,subflow:{outputCount:a,instances:l(!0).instances}};RED.history.push(r),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").html(t.out.length)}()}),$("#workspace-subflow-input-add").click(function(e){e.preventDefault(),function(){var e=RED.nodes.subflow(RED.workspaces.active());if(1!==e.in.length){var t=d(e,!0),n={type:"subflow",direction:"in",z:e.id,i:e.in.length,x:t.x,y:t.y,id:RED.nodes.id()},o=e.in.length;e.in.push(n),e.dirty=!0;var a=RED.nodes.dirty(),i=e.changed;e.changed=!0;var s={t:"edit",node:e,dirty:a,changed:i,subflow:{inputCount:o,instances:l(!0).instances}};RED.history.push(s),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input-add").addClass("active"),$("#workspace-subflow-input-remove").removeClass("active")}}()}),$("#workspace-subflow-input-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=i.changed;i.changed=!0;var o=s();if(o){var a=l(!0);RED.history.push({t:"delete",links:o.links,changed:n,subflowInputs:o.subflowInputs,dirty:t,subflow:{instances:a.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#workspace-subflow-delete").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=o(RED.workspaces.active());n.t="delete",n.dirty=t,RED.history.push(n)}),a(i),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function o(e){var t=[],n=[],o=RED.nodes.subflow(e);RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&t.push(e),e.z==o.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==o.id&&t.push(e)});for(var a=[],i=0;i<t.length;i++){var s=RED.nodes.remove(t[i].id);n=n.concat(s.links),a=a.concat(s.nodes)}return t=t.concat(a),RED.nodes.removeSubflow(o),RED.workspaces.remove(o),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:t,links:n,subflow:{subflow:o}}}function e(){var n=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(n=Math.max(n,t[1]))});var e="Subflow "+(n+1),t=RED.nodes.id(),o={type:"subflow",id:t,name:e,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(t),RED.nodes.dirty(!0)}function t(){var e=RED.view.selection();if(e.nodes){var t,a,i={},o=[],n=[],s=[],r=[],d={},l=[e.nodes[0].x,e.nodes[0].y,e.nodes[0].x,e.nodes[0].y];for(t=0;t<e.nodes.length;t++)a=e.nodes[t],i[a.id]={n:a,outputs:{}},l=[Math.min(l[0],a.x),Math.min(l[1],a.y),Math.max(l[2],a.x),Math.max(l[3],a.y)];var c=[(l[2]+l[0])/2,(l[3]+l[1])/2];RED.nodes.eachLink(function(e){i[e.source.id]&&i[e.target.id],i[e.source.id]&&!i[e.target.id]&&(r.push(e),n.push(e)),!i[e.source.id]&&i[e.target.id]&&(s.push(e),d[e.target.id]=e.target,n.push(e))});var p={};if((r=r.filter(function(e){return p[e.source.id+":"+e.sourcePort]?(p[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),p[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),1<Object.keys(d).length)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var u=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(u=Math.max(u,t[1]))});var f="Subflow "+(u+1),h=RED.nodes.id(),g={type:"subflow",id:h,name:f,info:"",in:Object.keys(d).map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:d[e].x-d[e].w/2-80,y:d[e].y,z:h,i:n,id:RED.nodes.id(),wires:[{id:d[e].id}]}}),out:r.map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:e.source.x+e.source.w/2+80,y:e.source.y,z:h,i:n,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})};RED.nodes.addSubflow(g);var v={id:RED.nodes.id(),type:"subflow:"+g.id,x:c[0],y:c[1],z:RED.workspaces.active(),inputs:g.in.length,outputs:g.out.length,h:Math.max(30,15*(g.out.length||0)),changed:!0};for(v._def=RED.nodes.getType(v.type),RED.editor.validateNode(v),RED.nodes.add(v),s.forEach(function(e){var t={source:e.source,sourcePort:e.sourcePort,target:v};o.push(t),RED.nodes.addLink(t)}),r.forEach(function(e,n){e.targets.forEach(function(e){var t={source:v,sourcePort:n,target:e};o.push(t),RED.nodes.addLink(t)})}),g.in.forEach(function(n){n.wires.forEach(function(e){var t={source:n,sourcePort:0,target:RED.nodes.node(e.id)};o.push(t),RED.nodes.addLink(t)})}),g.out.forEach(function(n,e){n.wires.forEach(function(e){var t={source:RED.nodes.node(e.id),sourcePort:e.port,target:n};o.push(t),RED.nodes.addLink(t)})}),t=0;t<n.length;t++)RED.nodes.removeLink(n[t]);for(t=0;t<e.nodes.length;t++)a=e.nodes[t],/^link /.test(a.type)&&(a.links=a.links.filter(function(e){var t=i.hasOwnProperty(e);if(!t){var n=RED.nodes.node(e);if(n&&n.links){var o=n.links.indexOf(a.id);-1<o&&n.links.splice(o,1)}}return t})),a.z=g.id;RED.history.push({t:"createSubflow",nodes:[v.id],links:o,subflow:{subflow:g},activeWorkspace:RED.workspaces.active(),removedLinks:n,dirty:RED.nodes.dirty()}),RED.view.select(null),RED.editor.validateNode(g),RED.nodes.dirty(!0),RED.view.redraw(!0)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?n(t):($("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)}),RED.actions.add("core:create-subflow",e),RED.actions.add("core:convert-to-subflow",t)},createSubflow:e,convertToSubflow:t,removeSubflow:o,refresh:l,removeInput:s,removeOutput:r}}(),RED.userSettings=function(){var t=700,n=!1,r=[];function e(e){r.push(e)}function o(s){if(!n)if(RED.user.hasPermission("settings.write")){n=!0;var e={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var t=e.find(".editor-tray-body"),n=$("<div></div>").appendTo(t),o=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(n);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(o);var a=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),i=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(n);r.forEach(function(e){a.addTab({id:"user-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(i)}),n.i18n(),a.activateTab("user-settings-tab-"+(s||"view")),$("#sidebar-shade").show()},close:function(){n=!1,r.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==t&&(e.width=t),RED.tray.show(e)}else RED.notify(RED._("user.errors.settings"),"error")}var s=[{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],d={};function l(){var o=$('<div id="user-settings-tab-view" class="node-help"></div>'),a=RED.settings.get("editor")||{};return a.view=a.view||{},s.forEach(function(e){$("<h3></h3>").text(RED._(e.title)).appendTo(o),e.options.forEach(function(e){var t=a.view[e.setting],n=$('<div class="user-settings-row"></div>').appendTo(o);e.toggle?$('<label for="user-settings-'+e.setting+'"><input id="user-settings-'+e.setting+'" type="checkbox"> '+RED._(e.label)+"</label>").appendTo(n).find("input").prop("checked",t):($('<label for="user-settings-'+e.setting+'">'+RED._(e.label)+"</label>").appendTo(n),$('<input id="user-settings-'+e.setting+'" type="'+(e.type||"text")+'">').appendTo(n).val(t))})}),o}function c(e,t){var n=d[e],o=RED.settings.get("editor")||{};o.view=o.view||{},o.view[n.setting]=t,RED.settings.set("editor",o);var a=n.onchange;"string"==typeof a&&(a=RED.actions.get(a)),a&&a.call(n,t)}return{init:function(){RED.actions.add("core:show-user-settings",o),RED.actions.add("core:show-help",function(){o("keyboard")}),e({id:"view",title:RED._("menu.label.view.view"),get:l,close:function(){s.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?c(e.setting,t.prop("checked")):c(e.setting,t.val())})})}});var a=RED.settings.get("editor")||{};a.view=a.view||{};var i=!1;s.forEach(function(e){e.options.forEach(function(e){if(e.oldSetting){var t=RED.settings.get(e.oldSetting);null!=t&&(a.view[e.setting]=t,i=!0,RED.settings.remove(e.oldSetting))}if((d[e.setting]=e).onchange){var n=a.view[e.setting];null==n&&e.hasOwnProperty("default")&&(n=e.default,a.view[e.setting]=n,i=!0);var o=e.onchange;"string"==typeof o&&(o=RED.actions.get(o)),o&&o.call(e,n)}})}),i&&RED.settings.set("editor",a)},toggle:function(e){var t=d[e],n=RED.settings.get("editor")||{};n.view=n.view||{},c(e,!n.view[t.setting])},show:o,add:e}}(),RED.projects=function(){var u,i,B;function v(e){var t;"git_missing_user"===e.error?t=RED.notify("<p>You Git client is not configured with a username/email.</p>",{fixed:!0,type:"error",buttons:[{text:"Cancel",click:function(){t.close()}},{text:"Configure Git client",click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),t=RED.notify("<p>An unexpected error occurred:</p><p>"+e.message+"</p><small>code: "+e.error+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:"Close",click:function(){t.close()}}]}))}var s={};function t(){var b=$('<div class="projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(b),$("<hr>").appendTo(b);var T,k,_,C,j,S,O,L,P,N,I,A,c,d,l,y,w,D,E,R,x,z,M,f,h,r,p,g={};s={welcome:{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');b.appendTo(t);var n=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text("Hello! We have introduced 'projects' to Node-RED.").appendTo(n),$("<p>").text("This is a new way for you to manage your flow files and includes version control of your flows.").appendTo(n),$("<p>").text("To get started you can create your first project or clone an existing project from a git repository.").appendTo(n),$("<p>").text("If you are not sure, you can skip this for now. You will still be able to create your first project from the 'Projects' menu at any time.").appendTo(n);var o=$('<div style="text-align: center"></div>').appendTo(n),a=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>Create Project</button>').appendTo(o),i=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>Clone Repository</button>').appendTo(o);return a.click(function(e){e.preventDefault(),g={action:"create"},m("git-config")}),i.click(function(e){e.preventDefault(),g={action:"clone"},m("git-config")}),t},buttons:[{text:"Not right now",click:function(){g={},$(this).dialog("close")}}]},"git-config":{content:function(e){var t=!1,n=RED.settings.get("git");n&&n.user?n=n.user:RED.settings.git&&RED.settings.git.globalUser&&(t=!0,n=RED.settings.git.globalUser);var o=function(){var e=r.val().trim(),t=p.val().trim(),n=0<e.length&&0<t.length;$("#projects-dialog-git-config").prop("disabled",!n).toggleClass("disabled ui-button-disabled ui-state-disabled",!n)},a=$('<div class="projects-dialog-screen-start"></div>');b.appendTo(a);var i=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(a);$("<p>").text("Setup your version control client").appendTo(i),$("<p>").text("Node-RED uses the open source tool Git for version control. It tracks changes to your project files and lets you push them to remote repositories.").appendTo(i),$("<p>").text("When you commit a set of changes, Git records who made the changes with a username and email address. The Username can be anything you want - it does not need to be your real name.").appendTo(i),t&&$("<p>").text("Your Git client is already configured with the details below.").appendTo(i),$("<p>").text("You can change these settings later under the 'Git config' tab of the settings dialog.").appendTo(i);var s=$('<div class="form-row"></div>').appendTo(i);return $('<label for="">Username</label>').appendTo(s),(r=$('<input type="text">').val(n&&n.name||"").appendTo(s)).on("change keyup paste",o),s=$('<div class="form-row"></div>').appendTo(i),$('<label for="">Email</label>').appendTo(s),(p=$('<input type="text">').val(n&&n.email||"").appendTo(s)).on("change keyup paste",o),setTimeout(function(){r.focus(),o()},50),a},buttons:[{text:"Back",click:function(){m("welcome")}},{id:"projects-dialog-git-config",text:"Next",class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=r.val(),e.user.email=p.val(),RED.settings.set("git",e),"create"===g.action?m("project-details"):"clone"===g.action&&m("clone-project")}}]},"project-details":{content:function(e){var n=null,o=!1;$.getJSON("projects",function(e){n={},e.projects.forEach(function(e){n[e]=!0,o&&(o=!1,i())})});var t=$('<div class="projects-dialog-screen-start"></div>');b.appendTo(t);var a=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text("Create your project").appendTo(a),$("<p>").text("A project is maintained as a Git repository. It makes it much easier to share your flows with others and to collaborate on them.").appendTo(a),$("<p>").text("You can create multiple projects and quickly switch between them from the editor.").appendTo(a),$("<p>").text("To begin, your project needs a name and an optional description.").appendTo(a);var i=function(){var e=f.val(),t=!0;if(p){if(null===n)return void(o=!0);c.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||n[e]?(f.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(c),t=d=!1,n[e]?projectNameSublabel.text("Project already exists"):projectNameSublabel.text("Must contain only A-Z 0-9 _ -")):(f.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(c),projectNameSublabel.text("Must contain only A-Z 0-9 _ -"),d=!0),u=e}t=d,$("#projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},s=$('<div class="form-row"></div>').appendTo(a);$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(s);var r=$('<div style="position:relative;"></div>').appendTo(s);f=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').val(g.name||"").appendTo(r);var d,l,c=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(r),p=!1,u="";return f.on("change keyup paste",function(){if(p=f.val()!==u,l)clearTimeout(l);else if(p&&(c.empty(),$('<img src="red/images/spin.svg"/>').appendTo(c),""===f.val()))return void i();l=setTimeout(function(){i(),l=null},300)}),projectNameSublabel=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(s).find("small"),s=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(a),$('<label for="projects-dialog-screen-create-project-desc">Description</label>').appendTo(s),h=$('<input id="projects-dialog-screen-create-project-desc" type="text">').val(g.summary||"").appendTo(s),$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(s),setTimeout(function(){f.focus(),f.change()},50),t},buttons:function(e){return[{text:"Back",click:function(){m("git-config")}},{id:"projects-dialog-create-name",disabled:!0,text:"Next",class:"primary disabled",click:function(){g.name=f.val(),g.summary=h.val(),m("default-files",e)}}]}},"clone-project":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');b.appendTo(t);var n=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text("Clone a project").appendTo(n),$("<p>").text("If you already have a git repository containing a project, you can clone it to get started.").appendTo(n);var a=null,i=!1;$.getJSON("projects",function(e){a={},e.projects.forEach(function(e){a[e]=!0,i&&(i=!1,s())})});var o,s=function(){var e=y.val(),t=!0;if(p){if(null===a)return void(i=!0);c.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||a[e]?(y.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(c),t=d=!1,a[e]?x.text("Project already exists"):x.text("Must contain only A-Z 0-9 _ -")):(y.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(c),x.text("Must contain only A-Z 0-9 _ -"),d=!0),u=e}t=d;var n=D.val(),o=0<n.length&&!/\s/.test(n);/^https?:\/\/[^/]+@/i.test(n)&&($("#projects-dialog-screen-create-project-repo-label small").text("Do not include the username/password in the url"),o=!1),o?D.removeClass("input-error"):(h&&D.addClass("input-error"),t=!1),/^https?:\/\//.test(n)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(n)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide()),$("#projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};o=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(o);var r=$('<div style="position:relative;"></div>').appendTo(o);y=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(r);var d,l,c=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(r),p=!1,u="",f="";y.on("change keyup paste",function(){if(p=y.val()!==u,l)clearTimeout(l);else if(p&&(c.empty(),$('<img src="red/images/spin.svg"/>').appendTo(c),""===y.val()))return void s();l=setTimeout(function(){s(),l=null},300)}),x=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(o).find("small"),o=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-repo">Git repository URL</label>').appendTo(o),D=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(o),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(o);var h=!1,g="";D.on("change keyup paste",function(){h=!0;var e=$(this).val();g!==e&&$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://");var t=/\/([^/]+?)(?:\.git)?$/.exec(g=e);if(t){var n=y.val();""!==n&&n!==f||(f=t[1],y.val(f),y.change())}s()});var v=$('<div class="projects-dialog-screen-create-row"></div>').appendTo(n);o=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(v),$('<div><i class="fa fa-warning"></i> Authentication failed</div>').appendTo(o),o=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(v),r=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-repo-user">Username</label>').appendTo(r),E=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(r),r=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-repo-pass">Password</label>').appendTo(r),R=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(r),o=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(v),r=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-repo-passphrase">SSH Key</label>').appendTo(r),z=$("<select>",{style:"width: 100%"}).appendTo(r),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){z.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(z.addClass("input-error"),z.attr("disabled",!0),m.show()):(z.removeClass("input-error"),z.attr("disabled",!1),m.hide())}),r=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-repo-passphrase">Passphrase</label>').appendTo(r),M=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(r),r=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(v);var m=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(r);return $('<div class="form-row"><i class="fa fa-warning"></i> Before you can clone a repository over ssh you must add an SSH key to access it.</div>').appendTo(m),r=$('<div style="text-align: center">').appendTo(m),$('<button class="editor-button">Add an ssh key</button>').appendTo(r).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),o=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(n),$("<label>Credentials encryption key</label>").appendTo(o),w=$('<input type="password"></input>').appendTo(o),t},buttons:function(e){return[{text:"Back",click:function(){m("git-config")}},{id:"projects-dialog-clone-project",disabled:!0,text:"Clone project",class:"primary disabled",click:function(){$(".projects-dialog-screen-create-type.selected").data("type");var e={name:y.val()};e.credentialSecret=w.val();var t=D.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(t)){var n=z.val();if(!n)return void console.log("Error! Can't get selected SSH key path.");e.git={remotes:{origin:{url:t,keyFile:n,passphrase:M.val()}}}}else e.git={remotes:{origin:{url:t,username:E.val(),password:R.val()}}};$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://"),E.removeClass("input-error"),R.removeClass("input-error"),z.removeClass("input-error"),M.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e.name),J({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){u.dialog("close")},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){D.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Connection failed")},git_not_a_repository:function(e){D.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Not a git repository")},git_repository_not_found:function(e){D.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Repository not found")},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),E.addClass("input-error"),R.addClass("input-error"),z.addClass("input-error"),M.addClass("input-error")},missing_flow_file:function(e){u.dialog("close")},project_empty:function(e){u.dialog("close")},credentials_load_failed:function(e){u.dialog("close")},"*":function(e){v(e),$(u).dialog("close")}}}},e).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"default-files":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');b.appendTo(t);var n=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text("Create your project files").appendTo(n),$("<p>").text("A project contains your flow files, a README file and a package.json file.").appendTo(n),$("<p>").text("It can contain any other files you want to maintain in the Git repository.").appendTo(n),!e.existingProject&&RED.settings.files&&$("<p>").text("Your existing flow and credential files will be copied into the project.").appendTo(n);var o=function(){var e=!0,t=d.val();""!==t&&/\.json$/.test(t)?(d.hasClass("input-error")&&(d.removeClass("input-error"),d.next().empty()),l.hasClass("input-error")&&(l.removeClass("input-error"),l.next().empty()),l.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,d.hasClass("input-error")||(d.addClass("input-error"),d.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),l.text(""),l.hasClass("input-error")||(l.addClass("input-error"),l.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},a=$('<div class="form-row"></div>').appendTo(n);$('<label for="projects-dialog-screen-create-project-file">Flow file</label>').appendTo(a);var i=$('<div style="position:relative;"></div>').appendTo(a),s=g.files&&g.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";d=$('<input id="projects-dialog-screen-create-project-file" type="text">').val(s).on("change keyup paste",o).appendTo(i),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(i),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(a);var r=g.files&&g.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return a=$('<div class="form-row"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-credfile">Credentials file</label>').appendTo(a),i=$('<div style="position:relative;"></div>').appendTo(a),l=$('<div style="width: 100%" class="uneditable-input" id="projects-dialog-screen-create-project-credentials">').text(r).appendTo(i),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(i),setTimeout(function(){d.focus(),o()},50),t},buttons:function(e){return[{text:e.existingProject?"Cancel":"Back",click:function(){e.existingProject?$(this).dialog("close"):m("project-details",e)}},{id:"projects-dialog-create-default-files",text:"Next",class:"primary",click:function(){g.files={flow:d.val(),credentials:l.text()},e.existingProject||(g.migrateFiles=!0),m("encryption-config",e)}}]}},"encryption-config":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');b.appendTo(t);var n=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text("Setup encryption of your credentials file").appendTo(n),e.existingProject?($("<p>").text("Your flow credentials file can be encrypted to keep its contents secure.").appendTo(n),$("<p>").text("If you want to store these credentials in a public Git repository, you must encrypt them by providing a secret key phrase.").appendTo(n)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text("Your flow credentials file is not currently encrypted.").appendTo(n),$("<p>").text("That means its contents, such as passwords and access tokens, can be read by anyone with access to the file.").appendTo(n),$("<p>").text("If you want to store these credentials in a public Git repository, you must encrypt them by providing a secret key phrase.").appendTo(n)):("user"===RED.settings.flowEncryptionType?$("<p>").text("Your flow credentials file is currently encrypted using the credentialSecret property from your settings file as the key.").appendTo(n):"system"===RED.settings.flowEncryptionType&&$("<p>").text("Your flow credentials file is currently encrypted using a system-generated key. You should provide a new secret key for this project.").appendTo(n),$("<p>").text("The key will be stored separately from your project files. You will need to provide the key to use this project in another instance of Node-RED.").appendTo(n));var o=function(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==c.val()),$("#projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(n);$("<label>Credentials</label>").appendTo(a);var i=$('<div style="width: 550px">').appendTo(a),s=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(i),r=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(i),d=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(r);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">Enable encryption</span></label>').appendTo(d);var l=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(r);return $('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">Disable encryption</span></label>').appendTo(l),r.find("input[name=projects-encryption-type]").click(function(e){var t,n;"enabled"===$(this).val()?(t=d,n=l,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&c.focus()):(n=d,t=l,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),n.css({borderColor:"white",borderRightColor:"#ccc"}),o()}),a=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(s),$('<label class="projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">Copy over existing key</span></label>').appendTo(a),a=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(s),$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">Use custom key</span></label>').appendTo(a),a=$('<div class="projects-encryption-enabled-row"></div>').appendTo(s),(c=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(a)).on("change keyup paste",o),a=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(s),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> The credentials file will not be encrypted and its contents easily read</div>').appendTo(a),s.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();c.attr("disabled","default"===e),"custom"===e&&c.focus(),o()}),setTimeout(function(){r.find("input[name=projects-encryption-type][value=enabled]").click(),"user"!==RED.settings.flowEncryptionType?s.find("input[name=projects-encryption-key][value=custom]").click():s.find("input[name=projects-encryption-key][value=default]").click(),o()},100),t},buttons:function(o){return[{text:"Back",click:function(){m("default-files",o)}},{id:"projects-dialog-create-encryption",text:o.existingProject?"Create project files":"Create project",class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(g.credentialSecret=c.val()):g.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(g.name);var e="POST",t="projects";o.existingProject&&(g.initialise=!0,e="PUT",t="projects/"+B.name);var n=this;J({url:t,type:e,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){g={},o.existingProject?$(n).dialog("close"):(m("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log("git auth error",e)},"*":function(e){v(e),$(u).dialog("close")}}}},g).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"create-success":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');b.appendTo(t);var n=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);return $("<p>").text("You have successfully created your first project!").appendTo(n),$("<p>").text("You can now continue to use Node-RED just as you always have.").appendTo(n),$("<p>").text("The 'info' tab in the sidebar shows you what your current active project is. The button next to the name can be used to access the project settings view.").appendTo(n),$("<p>").text("The 'history' tab in the sidebar can be used to view files that have changed in your project and to commit them. It shows you a complete history of your commits and allows you to push your changes to a remote repository.").appendTo(n),t},buttons:[{text:"Done",click:function(){$(this).dialog("close")}}]},create:{title:"Projects",content:function(e){var s=null;A=null;var r=!1;$.getJSON("projects",function(e){s={},e.projects.forEach(function(e){s[e]=!0,r&&(r=!1,o())})});var t,n=$('<div class="projects-dialog-screen-create"></div>'),o=function(){var e=T.val(),t=!0;if(f){if(null===s)return void(r=!0);u.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||s[e]?(T.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(u),t=c=!1,s[e]?P.text("Project already exists"):P.text("Must contain only A-Z 0-9 _ -")):(T.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(u),P.text("Must contain only A-Z 0-9 _ -"),c=!0),h=e}t=c;var n=$(".projects-dialog-screen-create-type.selected").data("type");if("copy"===n)t=!1;else if("clone"===n){var o=j.val(),a=0<o.length&&!/\s/.test(o);/^https?:\/\/[^/]+@/i.test(o)&&($("#projects-dialog-screen-create-project-repo-label small").text("Do not include the username/password in the url"),a=!1),a?j.removeClass("input-error"):(D&&j.addClass("input-error"),t=!1),/^https?:\/\//.test(o)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(o)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===n){var i=_.val();""!==i&&/\.json$/.test(i)?_.hasClass("input-error")&&(_.removeClass("input-error"),_.next().empty()):(t=!1,_.hasClass("input-error")||(_.addClass("input-error"),_.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(t=t&&""!==S.val())}else"open"===n&&(t=!!A);$("#projects-dialog-create").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};t=$('<div class="form-row button-group"></div>').appendTo(n);var a=$('<button data-type="open" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>Open Project</button>').appendTo(t),i=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>Create Project</button>').appendTo(t),d=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>Clone Repository</button>').appendTo(t);t.find(".projects-dialog-screen-create-type").click(function(e){switch(e.preventDefault(),n.find(".projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),n.find(".projects-dialog-screen-create-row").hide(),n.find(".projects-dialog-screen-create-row-"+$(this).data("type")).show(),o(),T.focus(),$(this).data("type")){case"open":$("#projects-dialog-create").text("Open project");break;case"empty":$("#projects-dialog-create").text("Create project");break;case"clone":$("#projects-dialog-create").text("Clone project")}}),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-open"></div>').hide().appendTo(n),function(r){(r=r||{}).height;var o,e=$("<div></div>",{class:"projects-dialog-project-list-container"}),t="",n=$("<div>",{class:"red-ui-search-container"}).appendTo(e),a=$('<input id="projects-dialog-project-list-search" type="text" placeholder="search your projects">').appendTo(n).searchBox({delay:200,change:function(){t=$(this).val().toLowerCase(),l.editableList("filter"),o&&!o.is(":visible")&&o.children().children().removeClass("selected"),(o=l.children(":visible").first()).children().children().addClass("selected"),r.select&&r.select(o.children().data("data")),d()}});a.on("keydown",function(e){if(40===e.keyCode){e.preventDefault();var t=o;if(o){for(;0!==(t=t.next()).length&&!t.is(":visible"););if(0===t.length)return;o.children().children().removeClass("selected")}else t=l.children(":visible").first();(o=t).children().children().addClass("selected"),r.select&&r.select(o.children().data("data")),d()}else if(38===e.keyCode){e.preventDefault();var n=o;if(o){for(;0!==(n=n.prev()).length&&!n.is(":visible"););if(0===n.length)return;o.children().children().removeClass("selected")}else n=l.children(":visible").first();(o=n).children().children().addClass("selected"),r.select&&r.select(o.children().data("data")),d()}else 13===e.keyCode&&(e.preventDefault(),o&&r.dblclick&&r.dblclick(o.children().data("data")))}),a.i18n();var d=function(){var e=l.find(".projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=i,n=t.height(),o=(t.scrollTop(),e.position().top),a=e.height();n<o+a?t.animate({scrollTop:"-="+(n-o-a)},50):o<0&&t.animate({scrollTop:"+="+o},50)}},i=$("<div></div>",{class:"projects-dialog-project-list-inner-container"}).appendTo(e),l=$("<ol>",{class:"projects-dialog-project-list"}).appendTo(i).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(i,e,s){var t=$("<div></div>",{class:"projects-dialog-project-list-entry"}).appendTo(i);if($('<span class="projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(t),$('<span class="projects-dialog-project-list-entry-name" style=""></span>').text(s.name).appendTo(t),!B||B.name!==s.name||(t.addClass("projects-list-entry-current"),$('<span class="projects-dialog-project-list-entry-current">current</span>').appendTo(t),!1!==r.canSelectActive)){t.addClass("selectable");var n=$('<div class="projects-dialog-project-list-entry-tools"></div>').appendTo(t);$('<button class="editor-button editor-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(n).click(function(e){var t,n,o,a;e.stopPropagation(),e.preventDefault(),t=i,n=s.name,o=function(e){e||i.fadeOut(300,function(){l.editableList("removeItem",s),r.delete&&r.delete(s)})},a=$("<div>").css({background:"white",position:"absolute",top:0,right:0,bottom:0,left:"100%",overflow:"hidden",padding:"5px 20px",transition:"left 0.4s",whitespace:"nowrap",width:"1000px"}).click(function(e){e.stopPropagation()}).appendTo(t),$("<span>").css({lineHeight:"40px"}).text("Are you sure you want to delete this project?").appendTo(a),$('<button style="margin-left:20px" class="editor-button">Cancel</button>').appendTo(a).click(function(e){e.stopPropagation(),a.remove(),o(!0)}),$('<button style="margin-left:20px" class="editor-button primary">Delete</button>').appendTo(a).click(function(e){e.stopPropagation(),a.remove(),J({url:"projects/"+n,type:"DELETE",responses:{200:function(e){o(!1)},400:{unexpected_error:function(e){a.remove(),o(!0)}}}})}),setTimeout(function(){a.css("left",0)},50)}),i.click(function(e){$(".projects-dialog-project-list-entry").removeClass("selected"),t.addClass("selected"),o=i.parent(),r.select&&r.select(s),d(),a.focus()}),r.dblclick&&i.dblclick(function(e){e.preventDefault(),r.dblclick(s)})}},filter:function(e){return""===t||-1!==e.name.toLowerCase().indexOf(t)}});return $.getJSON("projects",function(e){e.projects.forEach(function(e){l.editableList("addItem",{name:e})})}),e}({canSelectActive:!1,dblclick:function(e){A=e,$("#projects-dialog-create").click()},select:function(e){A=e,o()},delete:function(e){s&&delete s[e.name],A=null,o()}}).appendTo(t),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(t);var l=$('<div style="position:relative;"></div>').appendTo(t);T=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(l);var c,p,u=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(l),f=!1,h="",g="";T.on("change keyup paste",function(){if(f=T.val()!==h,p)clearTimeout(p);else if(f&&(u.empty(),$('<img src="red/images/spin.svg"/>').appendTo(u),""===T.val()))return void o();p=setTimeout(function(){o(),p=null},300)}),P=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(t).find("small"),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-desc">Description</label>').appendTo(t),k=$('<input id="projects-dialog-screen-create-project-desc" type="text">').appendTo(t),$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(t),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-file">Flow file</label>').appendTo(t),l=$('<div style="position:relative;"></div>').appendTo(t),_=$('<input id="projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",o).appendTo(l),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(l),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(t),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(n),$("<label>Credentials</label>").appendTo(t);var v=$('<div style="width: 550px">').appendTo(t),m=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(v),b=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(v),y=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(b);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" checked style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">Enable encryption</span></label>').appendTo(y);var w=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(b);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">Disable encryption</span></label>').appendTo(w),b.find("input[name=projects-encryption-type]").click(function(e){var t,n;"enabled"===$(this).val()?(t=y,n=w,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&S.focus()):(n=y,t=w,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),n.css({borderColor:"white",borderRightColor:"#ccc"}),o()}),t=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(m),$('<label class="projects-edit-form-inline-label">Encryption key</label>').appendTo(t),(S=$('<input type="password"></input>').appendTo(t)).on("change keyup paste",o),$('<label class="projects-edit-form-sublabel"><small>A phrase to secure your credentials with</small></label>').appendTo(t),t=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(m),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> The credentials file will not be encrypted and its contents easily read</div>').appendTo(t),m.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();S.attr("disabled","default"===e),"custom"===e&&S.focus(),o()}),t=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-repo">Git repository URL</label>').appendTo(t),j=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(t),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(t);var D=!1,E="";j.on("change keyup paste",function(){D=!0;var e=$(this).val();E!==e&&$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://");var t=/\/([^/]+?)(?:\.git)?$/.exec(E=e);if(t){var n=T.val();""!==n&&n!==g||(g=t[1],T.val(g),T.change())}o()});var R=$('<div class="hide projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').hide().appendTo(n);t=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(R),$('<div><i class="fa fa-warning"></i> Authentication failed</div>').appendTo(t),t=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(R),l=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-user">Username</label>').appendTo(l),O=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(l),l=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-pass">Password</label>').appendTo(l),L=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(l),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(R),l=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-passphrase">SSH Key</label>').appendTo(l),N=$("<select>",{style:"width: 100%"}).appendTo(l),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){N.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(N.addClass("input-error"),N.attr("disabled",!0),x.show()):(N.removeClass("input-error"),N.attr("disabled",!1),x.hide())}),l=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-passphrase">Passphrase</label>').appendTo(l),I=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(l),l=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(R);var x=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(l);switch($('<div class="form-row"><i class="fa fa-warning"></i> Before you can clone a repository over ssh you must add an SSH key to access it.</div>').appendTo(x),l=$('<div style="text-align: center">').appendTo(x),$('<button class="editor-button">Add an ssh key</button>').appendTo(l).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),t=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(n),$("<label>Credentials encryption key</label>").appendTo(t),C=$('<input type="password"></input>').appendTo(t),e.screen||"empty"){case"empty":i.click();break;case"open":a.click();break;case"clone":d.click()}return setTimeout(function(){"open"!==(e.screen||"empty")?T.focus():$("#projects-dialog-project-list-search").focus()},50),n},buttons:function(e){var t;switch(e.screen||"empty"){case"open":t="Open project";break;case"empty":t="Create project";break;case"clone":t="Clone project"}return[{id:"projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"projects-dialog-create",text:t,class:"primary disabled",disabled:!0,click:function(){var e,t,n=$(".projects-dialog-screen-create-type.selected").data("type"),o={name:T.val()};if("empty"===n){o.summary=k.val(),o.files={flow:_.val()};var a=$("input[name=projects-encryption-type]:checked").val();o.credentialSecret="enabled"===a&&S.val()}else if("copy"===n)o.copy=(void 0).name;else if("clone"===n){o.credentialSecret=C.val();var i=j.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(i)){var s=N.val();if(!s)return void console.log("Error! Can't get selected SSH key path.");o.git={remotes:{origin:{url:i,keyFile:s,passphrase:I.val()}}}}else o.git={remotes:{origin:{url:i,username:O.val(),password:L.val()}}}}else if("open"===n)return e=A.name,t=function(e,t){u.dialog("close"),e&&"credentials_load_failed"!==e.error&&console.log("unexpected_error",e)},RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e),void J({url:"projects/"+e,type:"PUT",requireCleanWorkspace:!0,responses:{200:function(e){t(null,e)},400:{"*":t}}},{active:!0}).then(function(){RED.events.emit("project:change",{name:e})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)});$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://"),O.removeClass("input-error"),L.removeClass("input-error"),N.removeClass("input-error"),I.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(o.name),J({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){u.dialog("close")},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){j.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Connection failed")},git_not_a_repository:function(e){j.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Not a git repository")},git_repository_not_found:function(e){j.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Repository not found")},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),O.addClass("input-error"),L.addClass("input-error"),N.addClass("input-error"),I.addClass("input-error")},missing_flow_file:function(e){u.dialog("close")},project_empty:function(e){u.dialog("close")},credentials_load_failed:function(e){u.dialog("close")},"*":function(e){v(e),$(u).dialog("close")}}}},o).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}}function m(e,t){u||RED.projects.init();var n=s[e],o=n.content(t||{});i.empty();var a=n.buttons;"function"==typeof a&&(a=a(t||{})),u.dialog("option","buttons",a),i.append(o),u.dialog("option","title",n.title||""),u.dialog("open"),u.dialog({position:{my:"center top",at:"center top+10%",of:window}})}function e(e){if(RED.nodes.dirty())var t=RED.notify("<p>You have undeployed changes that will be lost.</p><p>Do you want to continue?</p>",{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.close(),e(!0)}},{text:"Continue",click:function(){t.close(),e(!1)}}]})}function J(c,p){var t,n;if(c.requireCleanWorkspace&&RED.nodes.dirty())return e(function(e){e?c.cancel&&(c.cancel(),n&&n()):(delete c.requireCleanWorkspace,J(c,p).then(function(){t&&t()}).always(function(){n&&n()}))}),{then:function(e){return t=e,{always:function(e){n=e}}},always:function(e){n=e}};var u,f,o=Date.now();return $(".projects-dialog-spinner").show(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),p&&(c.data=JSON.stringify(p),c.contentType="application/json; charset=utf-8"),$.ajax(c).done(function(e,t,n){c.responses&&c.responses[200]&&(u=c.responses[200],f=e)}).fail(function(n,e,t){if(c.responses&&c.responses[n.status]){var o=c.responses[n.status];if("function"==typeof o)return void(f={error:(u=o).statusText});if(!1!==c.handleAuthFail&&"git_auth_failed"===n.responseJSON.error){var a=B.git.remotes[n.responseJSON.remote||c.remote||"origin"].fetch,i=$('<div><div class="form-row">Authentication required for repository:</div><div class="form-row"><div style="margin-left: 20px;">'+a+"</div></div></div>"),s=!1;if(/^https?:\/\//.test(a))$('<div class="form-row"><label for="projects-user-auth-username">Username</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for=projects-user-auth-password">Password</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(i);else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(a)){s=!0;var r=$('<div class="form-row"></div>').appendTo(i);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(r);var d=$('<select id="projects-user-auth-key">').width("70%").appendTo(r);$.getJSON("settings/user/keys",function(e){e.keys.forEach(function(e){d.append($("<option></option>").val(e.name).text(e.name)),0})}),r=$('<div class="form-row"></div>').appendTo(i),$('<label for="projects-user-auth-passphrase">Passphrase</label>').appendTo(r),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(r)}var l=RED.notify(i,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){l.close()}},{text:$('<span><i class="fa fa-refresh"></i> Retry</span>'),click:function(){p=p||{};var e={};s?(e.keyFile=$("#projects-user-auth-key").val(),e.passphrase=$("#projects-user-auth-passphrase").val()):(e.username=$("#projects-user-auth-username").val(),e.password=$("#projects-user-auth-password").val());var t=function(e){e?(console.log("Failed to update auth"),console.log(e)):(J(c,p),l.close())};J({url:"projects/"+B.name+"/remotes/"+(n.responseJSON.remote||c.remote||"origin"),type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null)},400:{unexpected_error:function(e){t(e)}}}},{auth:e})}}]});return}if(o[n.responseJSON.error])return u=o[n.responseJSON.error],void(f=n.responseJSON);if(o["*"])return u=o["*"],void(f=n.responseJSON)}console.log("Unhandled error response:"),console.log(n),console.log(e),console.log(t)}).always(function(){var e=Date.now()-o;e=Math.max(0,500-e),setTimeout(function(){$(".projects-dialog-spinner").hide(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),u&&u(f)},e)})}function n(a){var i,n="",o=[],s="",r=$('<div class="projects-branch-list">').appendTo(a.container),d=$('<input type="text">').attr("placeholder",a.placeholder).appendTo(r).searchBox({delay:200,change:function(){n=$(this).val(),/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(n)?(i.hasClass("input-error")||(i.addClass("input-error"),i.find("i").addClass("fa-warning").removeClass("fa-code-fork")),i.find("span").text("Invalid branch: "+s+n)):(i.hasClass("input-error")&&(i.removeClass("input-error"),i.find("i").removeClass("fa-warning").addClass("fa-code-fork")),i.find(".sidebar-version-control-branch-list-entry-create-name").text(s+n)),l.editableList("filter")}}),l=$("<ol>",{style:"height: 130px;"}).appendTo(r);return l.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){var o=$('<div class="sidebar-version-control-branch-list-entry">').appendTo(e);n.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(o),$("<span>").text(n.name).appendTo(o),n.current&&(o.addClass("selected"),$('<span class="current"></span>').text(a.currentLabel||"current").appendTo(o))):(i=o,$('<i class="fa fa-code-fork"></i>').appendTo(o),$("<span>").text("Create branch:").appendTo(o),$('<div class="sidebar-version-control-branch-list-entry-create-name" style="margin-left: 10px;">').text(n.name).appendTo(o)),o.click(function(e){if(e.preventDefault(),!$(this).hasClass("input-error")){var t={};n.hasOwnProperty("commit")?($(this).hasClass("selected")&&(t.current=!0),t.name=n.name):(t.name=d.val(),t.create=!0,a.remote&&(t.name=a.remote()+"/"+t.name)),a.onselect&&a.onselect(t)}})},filter:function(e){var t=!e.hasOwnProperty("commit");return t&&""!==n&&-1===o.indexOf(s+n)||!t&&-1!==e.name.indexOf(n)}}),{refresh:function(e){d.searchBox("value",""),l.editableList("empty");var t=Date.now(),n=c(r).addClass("projects-dialog-spinner-contain");s=a.remote?a.remote()+"/":"",J({url:e,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){o=e.branches,e.branches.forEach(function(e){l.editableList("addItem",e)}),l.editableList("addItem",{}),setTimeout(function(){n.remove()},Math.max(300-(Date.now()-t),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){v(e)}}}})},filter:function(){l.editableList("filter")},focus:function(){d.focus()}}}function c(e){return $('<div class="projects-dialog-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function o(){createProjectOptions={},B?m("create",{screen:"empty"}):m("welcome")}return{init:function(){u=$('<div id="projects-dialog" class="hide node-red-dialog projects-edit-form"><form class="form-horizontal"></form><div class="projects-dialog-spinner hide"><img src="red/images/spin.svg"/></div></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),i=u.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var e={sendRequest:J,createBranchList:n,addSpinnerOverlay:c,reportUnexpectedError:v};RED.projects.settings.init(e),RED.projects.userSettings.init(e),RED.sidebar.versionControl.init(e),t()},showStartup:function(){RED.user.hasPermission("projects.write")?m("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?e(function(e){e||o()}):void o();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){RED.user.hasPermission("projects.write")?m("create",{screen:"open"}):RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!B)throw new Error("Cannot create default file set without an active project");if(!B.empty)throw new Error("Cannot create default file set on a non-empty project");RED.user.hasPermission("projects.write")?(createProjectOptions={},m("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(B.name),J({url:"projects/"+B.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log("git error",e)},missing_flow_file:function(e){$(u).dialog("close")},"*":function(e){v(e),$(u).dialog("close")}}}},{initialise:!0}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})},refresh:function(t){$.getJSON("projects",function(e){e.active?$.getJSON("projects/"+e.active,function(e){B=e,RED.sidebar.versionControl.refresh(!0),t&&t(B)}):t&&t(null)})},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return B}}}(),RED.projects.settings=function(){var S,O,t=700,n=!1,d=[];function o(e){d.push(e)}function s(e,t){var n,o;t.empty(),n=e.description?marked(e.description):'<span class="node-info-none">No description available</span>',(o=$('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(n)+'">'+n+"</span>"),$(o).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),o).appendTo(t).find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>")}function c(e,t){t.empty(),e?t.text(e).removeClass("node-info-node"):t.text("No summary available").addClass("node-info-none")}function a(t){var e=$('<div id="project-settings-tab-main" class="project-settings-tab-pane node-help"></div>');$("<h1>").text(t.name).appendTo(e);var n=$('<div style="position: relative">').appendTo(e),o=$("<div></div>",{style:"color: #999"}).appendTo(n);c(t.summary,o),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">edit description</button>').prependTo(n).click(function(e){e.preventDefault(),function a(i,s,r){var d=r.prev();d.hide(),r.empty();var e=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(r),l=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(s||"").appendTo(r);$('<button class="editor-button">Cancel</button>').appendTo(e).click(function(e){e.preventDefault(),c(i.summary,r),d.show()}),$('<button class="editor-button">Save</button>').appendTo(e).click(function(e){e.preventDefault();var n=l.val();c(n,r);var o=O.addSpinnerOverlay(r),t=function(e,t){if(e)return o.remove(),a(i,s,r);i.summary=n,o.remove(),c(i.summary,r),d.show()};O.sendRequest({url:"projects/"+i.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),t(null)},400:{"*":function(e){O.reportUnexpectedError(e),t(e)}}}},{summary:n})})}(t,t.summary,o)}),$("<hr>").appendTo(e);var a=$('<div class="node-help" style="position: relative"></div>').appendTo(e),i=$("<div>",{style:"min-height: 200px"}).appendTo(a);return s(t,i),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">edit README.md</button>').prependTo(a).click(function(e){e.preventDefault(),function o(a,i){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:a.description,complete:function(n){i.empty();var e=O.addSpinnerOverlay(i),t=function(e,t){if(e)return o(a,i);a.description=n,s(a,i)};O.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){O.reportUnexpectedError(e),t(e)}}}},{description:n}).always(function(){e.remove()})}})}(t,i)}),e}function r(e,t){t.editableList("empty");var n=0;for(var o in h)h.hasOwnProperty(o)&&(t.editableList("addItem",{id:h[o].module,version:h[o].version,count:h[o].count,known:e.dependencies.hasOwnProperty(o),installed:!0}),n++,0===h[o].count&&0,e.dependencies.hasOwnProperty(o)||0);if(e.dependencies)for(var o in e.dependencies)if(e.dependencies.hasOwnProperty(o)&&!h.hasOwnProperty(o)){var a=!!RED.nodes.registry.getModule(o);t.editableList("addItem",{id:o,version:e.dependencies[o],count:0,known:!0,installed:a}),n++,a?0:0}0===n&&t.editableList("addItem",{index:0,label:"None"})}function p(e,t,n,o){var a=RED.projects.getActiveProject(),i=O.addSpinnerOverlay(t).addClass("projects-dialog-spinner-contain"),s=function(e,t){if(i.remove(),e)return o(e);a.dependencies=n,RED.sidebar.versionControl.refresh(!0),o()};O.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){s(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),s(null)},400:{"*":function(e){s(e)}}}},{dependencies:n})}function i(l){var t=$('<div id="project-settings-tab-deps" class="project-settings-tab-pane node-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="margin-top:10px;float: right;">edit</button>').appendTo(t).click(function(e){e.preventDefault(),function o(a,e,i,s){var t=e||JSON.stringify(a.dependencies||{},"",4);"{}"===t&&(t="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:t,requireValid:!0,complete:function(t){try{var n=JSON.parse(t);p(0,i,n,function(e){if(e)return o(a,t,i,s);a.dependencies=n,r(a,s)})}catch(e){o(a,t,i,s)}}})}(l,null,t,c)});var c=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return c.editableList({addButton:!1,addItem:function(n,e,o){var a=$("<div>",{class:"palette-module-header"}).appendTo(n);if(o.label)0===o.index?a.addClass("red-ui-search-empty"):n.parent().addClass("palette-module-section"),a.text(o.label);else{a.addClass("palette-module-header"),o.installed?0===o.count?a.addClass("palette-module-unused"):o.known||a.addClass("palette-module-unknown"):a.addClass("palette-module-not-installed"),o.element=a;var t=$('<div class="palette-module-meta palette-module-name"></div>').appendTo(a),i="fa-cube";o.installed||(i="fa-warning");var s=$('<i class="fa '+i+'"></i>').appendTo(t);o.icon=s,$("<span>").html(o.id).appendTo(t);var r=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(a);$("<span>").html(o.version).appendTo(r);r=$('<div class="palette-module-meta"></div>').appendTo(a);var d=$('<div class="palette-module-button-group"></div>').appendTo(r);RED.user.hasPermission("projects.write")&&(o.installed||!1===RED.settings.theme("palette.editable")?o.known&&0===o.count?$('<a href="#" class="editor-button editor-button-small">remove from project</a>').appendTo(d).click(function(e){e.preventDefault();var t=$.extend(!0,{},l.dependencies);delete t[o.id],p(0,n,t,function(e){e?console.log(e):n.fadeOut(200,function(){c.editableList("removeItem",o)})})}):o.known||$('<a href="#" class="editor-button editor-button-small">add to project</a>').appendTo(d).click(function(e){e.preventDefault();var t=$.extend(!0,{},l.dependencies);t[o.id]=h[o.id].version,p(0,n,t,function(e){e?console.log(e):(d.remove(),a.removeClass("palette-module-unknown"))})}):$('<a href="#" class="editor-button editor-button-small">install</a>').appendTo(d).click(function(e){e.preventDefault(),RED.palette.editor.install(o,n,function(e){if(!e){o.installed=!0;RED.utils.addSpinnerOverlay(n,!0);setTimeout(function(){c.editableList("removeItem",o),h={},RED.nodes.eachNode(f),RED.nodes.eachConfig(f),o.count=h[o.id].count,c.editableList("addItem",o)},500)}})}))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),r(l,c),t}function L(e,t,o,i,s){var r=$('<div class="project-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),d=O.addSpinnerOverlay(r);return $.getJSON("projects/"+t.name+"/files",function(t){var e=Object.keys(t);e=e.filter(function(e){return!t[e].status||!/D/.test(t[e].status)});var n={};e.sort(),e.forEach(function(e){e.split("/").reduce(function(e,t,n,o){if(t)return n<o.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]},n)});var a=function(e,t,n){var o={name:e||"/",path:n+(n?"/":"")+e};return!0===t?o.type="f":(o.type="d",o.children=[],o.path=o.path,Object.keys(t).forEach(function(e){o.children.push(a(e,t[e],o.path))}),o.children.sort(function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)})),o};n=a("",n,"");!function s(e,t,r,d,l,n){n=n||"";var o=$("<ol>",{class:"projects-dialog-file-list",style:n}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){var o=$("<div></div>",{class:"projects-dialog-file-list-entry"}).appendTo(e);if(n.children){if($('<span class="projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(o),0<n.children.length){var a=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(e);0===r.indexOf(n.path+"/")?o.addClass("expanded"):a.hide(),s(a,n.children,r,d,l),o.addClass("selectable"),o.click(function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),a.slideUp(200)):($(this).addClass("expanded"),a.slideDown(200))})}}else{var i="fa-file-o";/\.json$/i.test(n.name)?i="fa-file-code-o":/\.md$/i.test(n.name)?i="fa-book":/^\.git/i.test(n.name)&&(i="fa-code-fork",o.addClass("projects-dialog-file-list-entry-file-type-git")),$('<span class="projects-dialog-file-list-entry-file"> <i class="fa '+i+'"></i></span>').appendTo(o),d.test(n.name)?(o.addClass("selectable"),n.path===r&&o.addClass("selected"),o.click(function(e){$(".projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),l(n.path)}),o.dblclick(function(e){e.preventDefault(),l(n.path,!0)})):o.addClass("unselectable")}$('<span class="projects-dialog-file-list-entry-name" style=""></span>').text(n.name).appendTo(o)}});n||o.parent().css("overflow-y","");t.forEach(function(e){o.editableList("addItem",e)})}(r,n.children,o,i,s,"height: 175px"),d.remove()}),r}function l(s,e){$("<h3></h3>").text("Version Control").appendTo(e),function(d,e){var t=$('<div class="user-settings-section"></div>').appendTo(e);$("<h4></h4>").text("Branches").appendTo(t);var n=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(t),l=$("<ol>").appendTo(n).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(a,e,i){var t=$('<div class="projects-dialog-list-entry">').appendTo(a);if(i.empty)return t.addClass("red-ui-search-empty"),void t.text("No branches");i.current&&t.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(t);var n=$("<span>").appendTo(t),o=$("<div>").appendTo(n);if($('<span class="entry-name">').text(i.name).appendTo(o),i.commit&&$('<span class="entry-detail">').text(i.commit.sha).appendTo(o),i.remote){var s=$("<div>").appendTo(n);$('<span class="entry-detail entry-remote-name">').text(i.remote||"").appendTo(s),0<i.status.ahead+i.status.behind&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+i.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+i.status.behind+"</span></span>").appendTo(s)}if(!i.current){var r=$('<span class="entry-tools">').appendTo(t);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).click(function(e){e.preventDefault();var n=O.addSpinnerOverlay(a).addClass("projects-dialog-spinner-contain"),o=RED.notify("Are you sure you want to delete the local branch '"+i.name+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.remove(),o.close()}},{text:"Delete branch",click:function(){o.close();var t={url:"projects/"+d.name+"/branches/"+i.name,type:"DELETE",responses:{200:function(e){a.fadeOut(200,function(){l.editableList("removeItem",i),n.remove()})},400:{git_delete_branch_unmerged:function(e){o=RED.notify("The local branch '"+i.name+"' has unmerged changes that will be lost. Are you sure you want to delete it?",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.remove(),o.close()}},{text:"Delete unmerged branch",click:function(){t.url+="?force=true",o.close(),O.sendRequest(t)}}]})},"*":function(e){O.reportUnexpectedError(e),n.remove()}}}};O.sendRequest(t)}}]})})}}});$.getJSON("projects/"+d.name+"/branches",function(e){e.branches&&(0<e.branches.length?(e.branches.sort(function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)}),e.branches.forEach(function(e){l.editableList("addItem",e)})):l.editableList("addItem",{empty:!0}))})}(s,e);var t=$('<div class="user-settings-section"></div>').appendTo(e),n=$("<h4></h4>").text("Git remotes").appendTo(t),o=$('<button class="editor-button editor-button-small" style="float: right; margin-right: 10px;">add remote</button>').appendTo(n).click(function(e){o.attr("disabled",!0),i.slideDown(200,function(){i[0].scrollIntoView(),d?(h.val("origin"),g.focus()):h.focus(),p()})}),r={empty:!0},d=!0,a=$('<div class="user-settings-row"></div>').appendTo(t),i=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(a);a=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(t);var l=$("<ol>").appendTo(a);l.editableList({addButton:!1,height:"auto",addItem:function(o,e,a){var t=$('<div class="projects-dialog-list-entry">').appendTo(o);if(a.empty)return t.addClass("red-ui-search-empty"),void t.text("No remotes");$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(t);var n=$("<span>").appendTo(t);$('<div class="entry-name">').text(a.name).appendTo(n),a.urls.fetch===a.urls.push?$('<div class="entry-detail">').text(a.urls.fetch).appendTo(n):($('<div class="entry-detail">').text("fetch: "+a.urls.fetch).appendTo(n),$('<div class="entry-detail">').text("push: "+a.urls.push).appendTo(n));var i=$('<span class="entry-tools">').appendTo(t);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(i).click(function(e){e.preventDefault();var t=O.addSpinnerOverlay(o).addClass("projects-dialog-spinner-contain"),n=RED.notify("Are you sure you want to delete the remote '"+a.name+"'?",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),n.close()}},{text:"Delete remote",click:function(){n.close(),s.git.branches.remote&&0===s.git.branches.remote.indexOf(a.name+"/")&&delete s.git.branches.remote,s.git.branches.remoteAlt&&0===s.git.branches.remoteAlt.indexOf(a.name+"/")&&delete s.git.branches.remoteAlt;var e={url:"projects/"+s.name+"/remotes/"+a.name,type:"DELETE",responses:{200:function(e){o.fadeOut(200,function(){l.editableList("removeItem",a),setTimeout(t.remove,100),0===e.remotes.length?(delete s.git.remotes,d=!0,l.editableList("addItem",r)):(s.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,s.git.remotes[t]=e})),delete s.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()})},400:{"*":function(e){O.reportUnexpectedError(e),t.remove()}}}};O.sendRequest(e)}}]})})}});var c,p=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(h.val()),t=g.val(),n=0<t.length&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(v.text("Do not include the username/password in the url"),n=!1):v.text("https://, ssh:// or file://"),y.attr("disabled",!e||!n),h.toggleClass("input-error",u&&!e),g.toggleClass("input-error",f&&!n),c&&(c.close(),c=null)},u=!1,f=!1;$('<div class="projects-dialog-list-dialog-header">').text("Add remote").appendTo(i),a=$('<div class="user-settings-row"></div>').appendTo(i),$('<label for=""></label>').text("Remote name").appendTo(a);var h=$('<input type="text">').appendTo(a).on("change keyup paste",function(){u=!0,p()});$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(a).find("small"),a=$('<div class="user-settings-row"></div>').appendTo(i),$('<label for=""></label>').text("URL").appendTo(a);var g=$('<input type="text">').appendTo(a).on("change keyup paste",function(){f=!0,p()}),v=$('<label class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(a).find("small"),m=function(){o.attr("disabled",!1),i.hide(),h.val(""),g.val(""),c&&(c.close(),c=null)},b=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(i);$('<button class="editor-button">Cancel</button>').appendTo(b).click(function(e){e.preventDefault(),m()});var y=$('<button class="editor-button">Add remote</button>').appendTo(b).click(function(e){e.preventDefault();var t=O.addSpinnerOverlay(i).addClass("projects-dialog-spinner-contain"),n={name:h.val(),url:g.val()},o=function(e){t.remove(),e||m()};RED.deploy.setDeployInflight(!0),O.sendRequest({url:"projects/"+s.name+"/remotes",type:"POST",responses:{0:function(e){o(e)},200:function(e){s.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,s.git.remotes[t]=e}),w(),RED.sidebar.versionControl.refresh(),o()},400:{git_remote_already_exists:function(e){c=RED.popover.create({target:h,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),h.addClass("input-error"),o(e)},"*":function(e){O.reportUnexpectedError(e),o(e)}}}},n)}),w=function(){l.editableList("empty");var e=0;if(s.git.hasOwnProperty("remotes"))for(var t in s.git.remotes)s.git.remotes.hasOwnProperty(t)&&(e++,l.editableList("addItem",{name:t,urls:s.git.remotes[t]}));(d=0===e)&&l.editableList("addItem",r)};w()}function u(e){var t=$('<div id="project-settings-tab-settings" class="project-settings-tab-pane node-help"></div>');return function(a,e){var t,n=$("<h3></h3>").text("Files").appendTo(e),i=$('<div class="user-settings-section"></div>').appendTo(e);if(RED.user.hasPermission("projects.write"))var o=$('<button class="editor-button editor-button-small" style="float: right;">edit</button>').appendTo(n).click(function(e){e.preventDefault(),_.show(),o.hide(),r.hide(),d.show(),l.show(),c.hide(),p.show(),d.focus(),f.addClass("uneditable-input"),$(".user-settings-row-credentials").show(),f.css("height","auto"),m.hide(),h.show()});t=$('<div class="user-settings-row"></div>').appendTo(i),$('<label for=""></label>').text("Flow").appendTo(t);var s=$('<div class="uneditable-input" style="padding:0">').appendTo(t),r=$('<span style="display:inline-block; padding: 6px">').text(a.files.flow).appendTo(s),d=$('<input id="" type="text" style="margin-bottom: 0;width: 100%; border: none;">').val(a.files.flow).hide().appendTo(s),l=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(s).click(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),s.find(".project-file-listing-container").slideUp(200,function(){$(this).remove(),s.css("height","")}),s.css("color","");else{$(this).addClass("selected"),s.css("color","inherit");var t=L(s,a,d.val(),/.*\.json$/,function(e,t){e&&d.val(e),t&&$(l).click(),u()});s.css("height","auto"),setTimeout(function(){t.slideDown(200)},50)}});t=$('<div class="user-settings-row"></div>').appendTo(i),$('<label for=""></label>').text("Credentials").appendTo(t);var c=$('<div class="uneditable-input">').text(a.files.credentials).appendTo(t),p=$('<div class="uneditable-input">').text(a.files.credentials).hide().insertAfter(c),u=function(){var e,t=d.val(),n=/^(.+?)(\.[^.]*)?$/.exec(t);n?p.text(n[1]+"_cred"+(n[2]||".json")):""===t&&p.text("");var o=""===t||/\.\./.test(t)||/\/$/.test(t);e=o||""===p.text(),E.is(":visible")&&(E.toggleClass("input-error",""===E.val()),e=e||""===E.val()),x.is(":visible")&&(x.toggleClass("input-error",""===x.val()),e=e||""===x.val()),d.toggleClass("input-error",o),p.toggleClass("input-error",""===p.text()),C.toggleClass("disabled",e),C.prop("disabled",e)};d.on("change keyup paste",u),a.files.flow||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(r),a.files.credentials||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(c),t=$('<div class="user-settings-row"></div>').appendTo(i),$("<label></label>").appendTo(t);var f=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(t),h=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(t);f.css("color","#666"),h.css("vertical-align","top");var g=$('<button class="editor-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(h).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),m.hide()):(x.val(""),D.hide(),R.show(),$(this).addClass("selected"),v.removeClass("selected"),w.show(),T.show(),b.hide(),y.hide(),m.show()),u()}),v=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(h).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),m.hide()):(E.val(""),x.val(""),a.settings.credentialSecretInvalid||!a.settings.credentialsEncrypted?(b.show(),y.hide(),D.hide()):(D.show(),b.hide(),y.show()),R.show(),v.addClass("selected"),g.removeClass("selected"),w.hide(),T.hide(),m.show()),u()});t=$('<div class="user-settings-row user-settings-row-credentials"></div>').hide().appendTo(i);var m=$("<div>",{style:"margin-top:10px"}).hide().appendTo(f),b=$('<div style="margin: 20px 0 10px 5px;">Set the encryption key:</div>').hide().appendTo(m),y=$('<div style="margin: 20px 0 10px 5px;">Change the encryption key:</div>').hide().appendTo(m),w=$('<div style="margin: 20px 0 10px 5px;">Reset the encryption key:</div>').hide().appendTo(m),D=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(m);$('<label for=""></label>').text("Current key").appendTo(D);var E=$('<input type="password">').appendTo(D).on("change keyup paste",function(){S&&(S.close(),S=null),u()}),R=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(m);$('<label for=""></label>').text("New key").appendTo(R);var x=$('<input type="password">').appendTo(R).on("change keyup paste",u),T=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i> This will delete all existing credentials</div>').hide().appendTo(m),k=function(){o.show(),_.hide(),r.show(),d.hide(),l.hide(),c.show(),p.hide(),f.removeClass("uneditable-input"),f.css("height",""),l.removeClass("selected"),s.find(".project-file-listing-container").remove(),s.css("height",""),s.css("color",""),$(".user-settings-row-credentials").hide(),m.hide(),h.hide(),g.removeClass("selected"),v.removeClass("selected")},_=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(i);$('<button class="editor-button">Cancel</button>').appendTo(_).click(function(e){e.preventDefault(),k()});var C=$('<button class="editor-button">Save</button>').appendTo(_).click(function(e){e.preventDefault();var t=O.addSpinnerOverlay(i),n=function(e){t.remove(),e?O.reportUnexpectedError(e):(r.text(d.val()),c.text(p.text()),k())},o={files:{flow:d.val(),credentials:p.text()}};g.hasClass("selected")&&(o.resetCredentialSecret=!0),(g.hasClass("selected")||v.hasClass("selected"))&&(o.credentialSecret=x.val(),E.is(":visible")&&(o.currentCredentialSecret=E.val())),RED.deploy.setDeployInflight(!0),O.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){n(e)},200:function(e){a=e,RED.sidebar.versionControl.refresh(!0),j(),n()},400:{credentials_load_failed:function(e){n(e)},missing_current_credential_key:function(e){E.addClass("input-error"),S=RED.popover.create({target:E,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),n(e)},"*":function(e){n(e)}}}},o).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),j=function(){a.settings.credentialSecretInvalid?(f.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),f.find(".user-settings-credentials-state").text("Invalid encryption key")):a.settings.credentialsEncrypted?(f.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),f.find(".user-settings-credentials-state").text("Encryption enabled")):(f.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),f.find(".user-settings-credentials-state").text("Encryption disabled")),g.toggleClass("disabled",!a.settings.credentialSecretInvalid&&!a.settings.credentialsEncrypted),g.prop("disabled",!a.settings.credentialSecretInvalid&&!a.settings.credentialsEncrypted)};u(),j()}(e,t),l(e,t),t}function f(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(h.hasOwnProperty(t)||(h[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),h[t].count++)}}var h={};return{init:function(e){O=e,o({id:"main",title:"Project",get:a,close:function(){}}),o({id:"deps",title:"Dependencies",get:i,close:function(){}}),o({id:"settings",title:"Settings",get:u,close:function(){S&&(S.close(),S=null)}}),RED.events.on("nodes:add",f),RED.events.on("nodes:remove",function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&h.hasOwnProperty(t)&&(h[t].count--,0===h[t].count&&(h[t].known||delete h[t]))}})},show:function(r){if(!n)if(RED.user.hasPermission("projects.write")){n=!0;var e={title:"Project Settings",buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var t=RED.projects.getActiveProject(),n=e.find(".editor-tray-body"),o=$("<div></div>").appendTo(n),a=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(o);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(a);var i=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),s=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(o);d.forEach(function(e){i.addTab({id:"project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(t).hide().appendTo(s)}),o.i18n(),i.activateTab("project-settings-tab-"+(r||"main")),$("#sidebar-shade").show()},close:function(){n=!1,d.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==t&&(e.width=t),RED.tray.show(e)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){h={}}}}(),RED.projects.userSettings=function(){var a,D,E;function t(e){var t=$('<div id="user-settings-tab-gitconfig" class="project-settings-tab-pane node-help"></div>');return function(e){var t=RED.settings.get("git")||{};t.user=t.user||{},$("<h3></h3>").text("Committer Details").appendTo(e);var n=$('<div class="user-settings-section"></div>').appendTo(e);$('<div style="color:#aaa;"></div>').appendTo(n).text("Leave blank to use system default");var o=$('<div class="user-settings-row"></div>').appendTo(n);$('<label for=""></label>').text("Username").appendTo(o),(a=$('<input type="text">').appendTo(o)).val(t.user.name||""),o=$('<div class="user-settings-row"></div>').appendTo(n),$('<label for=""></label>').text("Email").appendTo(o),(D=$('<input type="text">').appendTo(o)).val(t.user.email||"")}(t),function(e){var o,t=$('<div class="user-settings-section"></div>').appendTo(e),n=($("<h3></h3>").text("SSH Keys").appendTo(t),$('<div style="color:#aaa;"></div>').appendTo(t).text("Allows you to create secure connections to remote git repositories.")),a=$('<button id="user-settings-gitconfig-add-key" class="editor-button editor-button-small" style="float: right; margin-right: 10px;">add key</button>').appendTo(n).click(function(e){a.attr("disabled",!0),v.attr("disabled",!0),r.slideDown(200),c.focus()}),i=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(c.val());c.toggleClass("input-error",l&&!e);var t=u.val(),n=0===t.length||8<=t.length;u.toggleClass("input-error",!n),n?0===t.length?f.text("Optional"):f.text(""):f.text("Passphrase too short"),e=e&&n,v.attr("disabled",!e),o&&(o.close(),o=null)},s=$('<div class="user-settings-row"></div>').appendTo(t),r=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(s);$('<div class="projects-dialog-list-dialog-header">').text("Add SSH Key").appendTo(r);var d=$("<div>").appendTo(r);s=$('<div class="user-settings-row"></div>').appendTo(d),$('<div style="color:#aaa;"></div>').appendTo(s).text("Generate a new public/private key pair"),s=$('<div class="user-settings-row"></div>').appendTo(d),$('<label for=""></label>').text("Name").appendTo(s);var l=!1,c=$('<input type="text">').appendTo(s).on("change keyup paste",function(){l=!0,i()});$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(s).find("small");var p=$("<div>").appendTo(d);s=$('<div class="user-settings-row"></div>').appendTo(p),$('<label for=""></label>').text("Passphrase").appendTo(s);var u=$('<input type="password">').appendTo(s).on("change keyup paste",i),f=$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(s).find("small"),h=function(){a.attr("disabled",!1),r.hide(),c.val(""),l=!1,u.val(""),o&&(o.close(),o=null)},g=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(r);$('<button class="editor-button">Cancel</button>').appendTo(g).click(function(e){e.preventDefault(),h()});var v=$('<button class="editor-button">Generate key</button>').appendTo(g).click(function(e){e.preventDefault();var t=E.addSpinnerOverlay(r).addClass("projects-dialog-spinner-contain"),n={name:c.val(),type:"generate"};n.comment=D.val(),n.password=u.val(),n.size=4096;var o=function(e){t.remove(),e||h()};RED.deploy.setDeployInflight(!0),E.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){o(e)},200:function(e){w(n.name),o()},400:{unexpected_error:function(e){console.log(e),o(e)}}}},n)});s=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(t);var m={empty:!0},b=function(e,t){var n=$('<div class="projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),o=$("<pre>",{style:"min-height: 80px"}).appendTo(n),a=E.addSpinnerOverlay(o).addClass("projects-dialog-spinner-contain"),i={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){o.text(e.publickey),a.remove()},400:{unexpected_error:function(e){console.log(e),a.remove()}}}};E.sendRequest(i);var s=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(n);return $('<button class="editor-button editor-button-small">Copy public key to clipboard</button>').appendTo(s).click(function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(o[0]),document.execCommand("copy"),document.getSelection().empty()}catch(e){}}),n},y=$('<ol class="projects-dialog-ssh-key-list">').appendTo(s).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(o,e,a){var t=$('<div class="projects-dialog-list-entry">').appendTo(o);if(a.empty)return t.addClass("red-ui-search-empty"),void t.text("No SSH keys");var n=$('<div class="projects-dialog-ssh-key-header">').appendTo(t);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(n),$('<span class="entry-name">').text(a.name).appendTo(n);var i,s=$('<span class="button-row entry-tools">').appendTo(n);n.click(function(e){i?i.slideUp(200,function(){i.remove(),i=null}):i=b(t,a)}),a.system||$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(s).click(function(e){e.stopPropagation();var t=E.addSpinnerOverlay(o).addClass("projects-dialog-spinner-contain"),n=RED.notify("Are you sure you want to delete the SSH key '"+a.name+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),n.close()}},{text:"Delete key",click:function(){n.close();var e={url:"settings/user/keys/"+a.name,type:"DELETE",responses:{200:function(e){o.fadeOut(200,function(){y.editableList("removeItem",a),setTimeout(t.remove,100),0===y.editableList("length")&&y.editableList("addItem",m)})},400:{unexpected_error:function(e){console.log(e),t.remove()}}}};E.sendRequest(e)}}]})}),a.expand&&(i=b(t,a))}}),w=function(t){$.getJSON("settings/user/keys",function(e){e.keys&&(e.keys.sort(function(e,t){return e.name.localeCompare(t.name)}),y.editableList("empty"),e.keys.forEach(function(e){e.name===t&&(e.expand=!0),y.editableList("addItem",e)}),0===y.editableList("length")&&y.editableList("addItem",m))})};w()}(t),t}return{init:function(e){E=e,RED.userSettings.add({id:"gitconfig",title:"Git config",get:t,close:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=a.val(),e.user.email=D.val(),RED.settings.set("git",e)}})}}}(),RED.sidebar.versionControl=function(){var S,O,L,P,N,I,r,A,z,M,B,J,U,d,G,F={};function q(n,s,e,r){n.addClass("sidebar-version-control-change-entry");var o=$("<div>").appendTo(n);if(s.label){if(n.addClass("node-info-none"),o.text(s.label),s.button){o.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var t=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(o);$('<button class="editor-button editor-button-small"></button>').text(s.button.label).appendTo(t).click(s.button.click)}}else{var a,i,d=$('<i class=""></i>').appendTo(o),l=$('<a href="#">').appendTo(o).click(function(e){var o,a,i,t;e.preventDefault(),o=s,a=r,i=RED.projects.getActiveProject(),t="staged"===a?"index":"tree",G.sendRequest({url:"projects/"+i.name+"/diff/"+t+"/"+encodeURIComponent(o.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t;t="unstaged"===a?"Unstaged changes : "+o.file:"staged"===a?"Staged changes : "+o.file:"Resolve conflicts : "+o.file;var n={diff:e.diff,title:t,unmerged:"unmerged"===a,project:i};"unstaged"==a?(n.oldRevTitle=" "===o.indexStatus?"HEAD":"Staged",n.newRevTitle="Unstaged",n.oldRev=" "===o.indexStatus?"@":":0",n.newRev="_"):"staged"===a?(n.oldRevTitle="HEAD",n.newRevTitle="Staged",n.oldRev="@",n.newRev=":0"):(n.oldRevTitle="Local",n.newRevTitle="Remote",n.commonRev=":1",n.oldRev=":2",n.newRev=":3",n.onresolve=function(e){G.sendRequest({url:"projects/"+i.name+"/resolve/"+encodeURIComponent(o.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){Z(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:e.resolutions[o.file]})}),RED.diff.showUnifiedDiff(n)},400:{unexpected_error:function(e){console.log(e)}}}})}),c=$("<span>").appendTo(l),p=$('<div class="sidebar-version-control-change-entry-tools">').appendTo(n);"unstaged"===r&&(a=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(p),i=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(a).click(function(e){e.preventDefault();var t=G.addSpinnerOverlay(o).addClass("projects-dialog-spinner-contain"),n=RED.notify("Are you sure you want to revert the changes to '"+s.file+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),n.close()}},{text:"Revert changes",click:function(){n.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+s.file,type:"DELETE",responses:{200:function(e){t.remove()},400:{unexpected_error:function(e){t.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),G.sendRequest(e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]})})),a=$('<span class="button-group"></span>').appendTo(p),"unmerged"!==r&&$('<button class="editor-button editor-button-small"><i class="fa fa-'+("unstaged"===r?"plus":"minus")+'"></i></button>').appendTo(a).click(function(e){e.preventDefault();var t=RED.projects.getActiveProject();s.spinner=G.addSpinnerOverlay(n).addClass("projects-version-control-spinner-sidebar"),G.sendRequest({url:"projects/"+t.name+"/stage/"+encodeURIComponent(s.file),type:"unstaged"===r?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){Y(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})}),s["update"+("unstaged"===r?"Unstaged":"Staged")]=function(e,t){o.removeClass();var n="";"A"===t?(o.addClass("node-diff-added"),n="fa-plus-square"):"?"===t?(o.addClass("node-diff-unchanged"),n="fa-question-circle-o"):"D"===t?(o.addClass("node-diff-deleted"),n="fa-minus-square"):"M"===t?(o.addClass("node-diff-changed"),n="fa-square"):"R"===t?(o.addClass("node-diff-changed"),n="fa-toggle-right"):("U"===t&&o.addClass("node-diff-conflicted"),n="fa-exclamation-triangle"),c.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(c),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(c),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(c)),d.removeClass(),d.addClass("fa "+n),e.spinner&&(e.spinner.remove(),delete e.spinner),i&&i.toggle("?"!==t),l.toggleClass("disabled","D"===t||"?"===t)},s["update"+("unstaged"===r?"Unstaged":"Staged")](s,e)}}function V(e){var t=Date.now()/1e3-e,n=Math.floor(t/86400);if(30<n)return new Date(1e3*e).toLocaleDateString();if(0<n)return n+" day"+(1<n?"s":"")+" ago";var o=Math.floor(t/3600);if(0<o)return o+" hour"+(1<o?"s":"")+" ago";var a=Math.floor(t/60);return 0<a?a+" minute"+(1<a?"s":"")+" ago":"Seconds ago"}function W(e,t){var n=RED.projects.getActiveProject();(r=t?G.addSpinnerOverlay(L.parent()):G.addSpinnerOverlay(N.parent())).addClass("projects-dialog-spinner-sidebar");var o=t?{files:e}:void 0;G.sendRequest({url:"projects/"+n.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){Y(e)},400:{unexpected_error:function(e){console.log(e)}}}},o)}var a=!1,l={label:"None"},H={label:"All conflicts resolved. Commit the changes to complete the merge."};function K(o,a,e,i,t){var s=G.addSpinnerOverlay(e),n=o+"?limit="+(i||20);t&&(n+="&before="+t),G.sendRequest({url:n,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t;e.commits.forEach(function(e){a.editableList("addItem",e),t=e.sha}),a.loadMoreItem&&(a.editableList("removeItem",a.loadMoreItem),delete a.loadMoreItem);var n=a.editableList("length");n<e.total&&(a.loadMoreItem={totalKnown:n,total:e.total,url:o,before:t+"~1",limit:i},a.editableList("addItem",a.loadMoreItem)),s.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function Y(e){var o=e.files;r&&(r.remove(),r=null),(d=!!e.merging)?(S.addClass("sidebar-version-control-merging"),A.show()):(S.removeClass("sidebar-version-control-merging"),A.hide()),L.editableList("removeItem",l),N.editableList("removeItem",l),z.editableList("removeItem",H);var t=Object.keys(o).filter(function(e){return"f"===o[e].type});t.sort();var a=Date.now()+Math.floor(100*Math.random());t.forEach(function(e){var t=o[e],n=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),F[e]?(F[e].unmerged&&!t.unmerged?(z.editableList("removeItem",F[e]),n=!0):!F[e].unmerged&&t.unmerged&&(L.editableList("removeItem",F[e]),N.editableList("removeItem",F[e])),F[e].status!==t.status&&(" "!==F[e].treeStatus?" "===t.treeStatus?L.editableList("removeItem",F[e]):t.treeStatus!==F[e].treeStatus&&F[e].updateUnstaged(t,t.treeStatus):n=!0," "!==F[e].indexStatus&&"?"!==F[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?N.editableList("removeItem",F[e]):t.indexStatus!==F[e].indexStatus&&F[e].updateStaged(t,t.indexStatus):n=!0),F[e].status=t.status,F[e].indexStatus=t.indexStatus,F[e].treeStatus=t.treeStatus,F[e].oldName=t.oldName,F[e].unmerged=t.unmerged):(n=!0,F[e]=t),F[e].updateIndex=a,n&&(t.unmerged?z.editableList("addItem",F[e]):(" "!==t.treeStatus&&L.editableList("addItem",F[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&N.editableList("addItem",F[e]))))}),Object.keys(F).forEach(function(e){F[e].updateIndex!==a&&(L.editableList("removeItem",F[e]),N.editableList("removeItem",F[e]),delete F[e])});var n=N.editableList("length"),i=L.editableList("length"),s=z.editableList("length");M.attr("disabled",d&&0<s||!d&&0===n),P.attr("disabled",0===i),I.attr("disabled",0===n),0===n&&N.editableList("addItem",l),0===i&&L.editableList("addItem",l),0===s&&z.editableList("addItem",H)}function Z(e,t){if(!a&&(e&&(F={},L.editableList("empty"),N.editableList("empty"),z.editableList("empty")),RED.user.hasPermission("projects.write"))){a=!0,function(){J.editableList("empty");var e=RED.projects.getActiveProject();e&&K("projects/"+e.name+"/commits",J,J.parent())}();var o=RED.projects.getActiveProject();if(o){var n="projects/"+o.name+"/status";t&&(n+="?remote=true"),$.getJSON(n,function(e){Y(e),$("#sidebar-version-control-local-branch").text(e.branches.local),$("#sidebar-version-control-remote-branch").text(e.branches.remote||"none");var t=e.commits.ahead||0,n=e.commits.behind||0;o.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#sidebar-version-control-repo-status-auth-issue").show(),$("#sidebar-version-control-repo-status-stats").hide(),$("#sidebar-version-control-repo-branch").attr("disabled",!0),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0),$("#sidebar-version-control-repo-toolbar-message").hide(),$("#sidebar-version-control-repo-toolbar-error-message").show()):($("#sidebar-version-control-repo-toolbar-message").show(),$("#sidebar-version-control-repo-toolbar-error-message").hide(),$("#sidebar-version-control-repo-status-auth-issue").hide(),$("#sidebar-version-control-repo-status-stats").show(),$("#sidebar-version-control-repo-branch").attr("disabled",!1),$("#sidebar-version-control-repo-status-button").show(),e.branches.hasOwnProperty("remote")?X(t,n):($("#sidebar-version-control-commits-ahead").text(""),$("#sidebar-version-control-commits-behind").text(""),$("#sidebar-version-control-repo-toolbar-message").text("Your local branch is not currently tracking a remote branch."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))):$("#sidebar-version-control-repo-status-button").hide(),a=!1,$(".sidebar-version-control-shade").hide()}).fail(function(){a=!1})}else $(".sidebar-version-control-shade").show(),L.editableList("empty"),N.editableList("empty"),z.editableList("empty")}}function X(e,t){$("#sidebar-version-control-commits-ahead").text(e),$("#sidebar-version-control-commits-behind").text(t),d?($("#sidebar-version-control-repo-toolbar-message").text("Your repository has unmerged changes. You need to fix the conflicts and commit the result."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0)):0<e&&0===t?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+e+" commit"+(1===e?"":"s")+" ahead of the remote. You can push "+(1===e?"this commit":"these commits")+" now."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1)):0===e&&0<t?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+t+" commit"+(1===t?"":"s")+" behind of the remote. You can pull "+(1===t?"this commit":"these commits")+" now."),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):0<e&&0<t?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+t+" commit"+(1===t?"":"s")+" behind and "+e+" commit"+(1===e?"":"s")+" ahead of the remote. You must pull the remote commit"+(1===t?"":"s")+" down before pushing."),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):0===e&&0===t&&($("#sidebar-version-control-repo-toolbar-message").text("Your repository is up to date."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))}function Q(){Z(),RED.sidebar.show("version-control")}return{init:function(e){G=e,RED.actions.add("core:show-version-control-tab",Q),RED.events.on("deploy",function(){var e=RED.projects.getActiveProject();e&&(F={},L.editableList("empty"),N.editableList("empty"),z.editableList("empty"),$.getJSON("projects/"+e.name+"/status",function(e){Y(e)}))}),RED.events.on("login",function(){Z(!0)}),S=$("<div>",{class:"sidebar-version-control"});var t=$("<div>",{class:"sidebar-version-control-stack"}).appendTo(S);O=RED.stack.create({container:t,fill:!0,singleExpanded:!0}),(B=O.add({title:"Local Changes",collapsible:!0})).expand(),B.content.css({height:"100%"});var n=$('<div style="float: right"></div>').appendTo(B.header);$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(n).click(function(e){e.preventDefault(),Z(!0)});var o=$('<div class="sidebar-version-control-change-container"></div>').appendTo(B.content),a=$('<div class="sidebar-version-control-change-header">Local files</div>').appendTo(o);P=$('<button class="editor-button editor-button-small" style="float: right"><i class="fa fa-plus"></i> all</button>').appendTo(a).click(function(e){e.preventDefault(),e.stopPropagation(),W(Object.keys(F).filter(function(e){return" "!==F[e].treeStatus}),!0)}),(L=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(o)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){q(e,n,n.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),A=$('<div class="sidebar-version-control-change-container"></div>').appendTo(B.content),a=$('<div class="sidebar-version-control-change-header">Unmerged changes</div>').appendTo(A),n=$('<div style="float: right"></div>').appendTo(a);var i=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">abort merge</button>').appendTo(n).click(function(e){e.preventDefault(),e.stopPropagation();var t=G.addSpinnerOverlay(A),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),G.sendRequest({url:"projects/"+n.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),Z(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})});(z=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(A)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){n===H&&(n.button={label:"commit",click:function(e){e.preventDefault(),e.stopPropagation(),r()}}),q(e,n,n.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var s=$('<div class="sidebar-version-control-change-container"></div>').appendTo(B.content);a=$('<div class="sidebar-version-control-change-header">Changes to commit</div>').appendTo(s),n=$('<div style="float: right"></div>').appendTo(a);var r=function(){d.val(""),p.attr("disabled",!0),o.css("height","30px"),A.is(":visible")?(A.css("height","30px"),s.css("height","calc(100% - 60px - 175px)")):s.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout(function(){commitBox.css("height","175px")},10),P.attr("disabled",!0),I.attr("disabled",!0),M.attr("disabled",!0),i.attr("disabled",!0),d.focus()};M=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">commit</button>').appendTo(n).click(function(e){e.preventDefault(),e.stopPropagation(),r()}),I=$('<button class="editor-button editor-button-small"><i class="fa fa-minus"></i> all</button>').appendTo(n).click(function(e){e.preventDefault(),e.stopPropagation(),W(Object.keys(F).filter(function(e){return" "!==F[e].indexStatus&&"?"!==F[e].indexStatus}),!1)}),(N=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(s)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){q(e,n,n.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-bottom"></div>').hide().appendTo(B.content);var d=$('<textarea placeholder="Enter your commit message"></textarea>').appendTo(commitBox).on("change keyup paste",function(){p.attr("disabled",""===$(this).val().trim())}),l=$('<div class="sidebar-version-control-slide-box-toolbar button-group">').appendTo(commitBox),c=$('<button class="editor-button">Cancel</button>').appendTo(l).click(function(e){e.preventDefault(),d.val(""),o.css("height",""),A.css("height",""),s.css("height",""),commitBox.css("height",0),setTimeout(function(){commitBox.hide()},200),P.attr("disabled",!1),I.attr("disabled",!1),M.attr("disabled",!1),i.attr("disabled",!1)}),p=$('<button class="editor-button">Commit</button>').appendTo(l).click(function(e){e.preventDefault();var t=G.addSpinnerOverlay(p).addClass("projects-dialog-spinner-sidebar"),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),G.sendRequest({url:"projects/"+n.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),c.click(),Z(!0)},400:{"*":function(e){G.reportUnexpectedError(e)}}}},{message:d.val()}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),u=O.add({title:"Commit History",collapsible:!0});n=$('<div style="float: right"></div>').appendTo(u.header),$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(n).click(function(e){e.preventDefault(),Z(!0,!0)});var f=$('<div class="sidebar-version-control-change-header" style="text-align: right;"></div>').appendTo(u.content),h=$('<button class="editor-button editor-button-small"><i class="fa fa-code-fork"></i> Branch: <span id="sidebar-version-control-local-branch"></span></button>').appendTo(f).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))v();else{w(),U.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();b.refresh("projects/"+t.name+"/branches"),m.show(),setTimeout(function(){m.css("height","215px"),b.focus()},100)}}),g=$('<button class="editor-button editor-button-small" style="margin-left: 10px;" id="sidebar-version-control-repo-status-button"><span id="sidebar-version-control-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="sidebar-version-control-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="sidebar-version-control-commits-behind"></span></span><span id="sidebar-version-control-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(f).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))w();else{v(),U.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),y.show(),setTimeout(function(){y.css("height","265px")},100)}});J=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(u.content),U=$('<div class="component-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(u.content),J.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,n){if(t.addClass("sidebar-version-control-commit-entry"),n.url)t.addClass("sidebar-version-control-commit-more"),t.text("+ "+(n.total-n.totalKnown)+" more commit(s)"),t.click(function(e){e.preventDefault(),K(n.url,J,t,n.limit,n.before)});else{t.click(function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+n.sha,function(e){e.project=t,e.parents=n.parents,e.oldRev=n.sha+"~1",e.newRev=n.sha,e.oldRevTitle="Commit "+n.sha.substring(0,7)+"~1",e.newRevTitle="Commit "+n.sha.substring(0,7),e.date=V(parseInt(n.date)),RED.diff.showCommitDiff(e)})});var o=$("<div>").appendTo(t);if($('<div class="sidebar-version-control-commit-subject">').text(n.subject).appendTo(o),n.refs){var a=$('<div class="sidebar-version-control-commit-refs">').appendTo(o);n.refs.forEach(function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="sidebar-version-control-commit-ref">').text(t).appendTo(a)}),t.addClass("sidebar-version-control-commit-head")}$('<div class="sidebar-version-control-commit-sha">').text(n.sha.substring(0,7)).appendTo(o),$('<div class="sidebar-version-control-commit-date">').text(V(parseInt(n.date))).appendTo(o)}}});var v=function(e){h.removeClass("selected"),m.css("height","0"),U.hide(),setTimeout(function(){m.hide(),e&&e()},200)},m=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px;"></div>').hide().appendTo(u.content);$('<div class="sidebar-version-control-slide-box-header"></div>').text("Change local branch").appendTo(m);var b=G.createBranchList({placeholder:"Find or create a branch",container:m,onselect:function(e){if(e.current)return v();var t=G.addSpinnerOverlay(m),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),G.sendRequest({url:"projects/"+n.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){v(function(){t.remove()})},400:{git_local_overwrite:function(e){t.remove(),RED.notify("You have local changes that would be overwritten by changing the branch. You must either commit or undo those changes first.",{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}),y=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px"></div>').hide().appendTo(u.content),w=function(){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),g.removeClass("selected"),y.css("height","0"),U.hide(),setTimeout(function(){y.hide(),D()},200)},D=function(e){R.hasClass("selected")&&(R.removeClass("selected"),k.height(0),y.css("height","265px"),setTimeout(function(){k.hide(),e&&e()},200))};$('<div class="sidebar-version-control-slide-box-header"></div>').text("Manage remote branch").appendTo(y);var E=$('<div style="margin-bottom: 5px;"></div>').appendTo(y),R=$('<button id="sidebar-version-control-repo-branch" class="sidebar-version-control-repo-action editor-button"><i class="fa fa-code-fork"></i> Remote: <span id="sidebar-version-control-remote-branch"></span></button>').appendTo(E).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))D();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();_.refresh("projects/"+t.name+"/branches/remote"),k.show(),setTimeout(function(){k.height(180),y.css("height","445px"),_.focus()},100)}});$('<div id="sidebar-version-control-repo-toolbar-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').appendTo(y);var x=$('<div id="sidebar-version-control-repo-toolbar-error-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(y);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> Unable to access remote repository</div>').appendTo(x);var T=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(x);$('<button class="editor-button" style="width: 80%;"><i class="fa fa-refresh"></i> Retry</button>').appendTo(T).click(function(e){e.preventDefault();var t=RED.projects.getActiveProject(),n=G.addSpinnerOverlay(y).addClass("projects-dialog-spinner-contain");G.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){Z(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always(function(){n.remove()})}),$('<div class="sidebar-version-control-slide-box-header" style="height: 20px;"><label id="sidebar-version-control-repo-toolbar-set-upstream-row" for="sidebar-version-control-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="sidebar-version-control-repo-toolbar-set-upstream"> Set as upstream branch</label></div>').appendTo(y);var k=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(E),_=G.createBranchList({placeholder:"Find or create a remote branch",currentLabel:"upstream",remote:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)[0]},container:k,onselect:function(e){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!1),$("#sidebar-version-control-remote-branch").text(e.name+(e.create?" *":""));var o=RED.projects.getActiveProject();o.git.branches.remote===e.name?delete o.git.branches.remoteAlt:o.git.branches.remoteAlt=e.name,$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!o.git.branches.remoteAlt),D(function(){if(e.create)o.git.branches.remote?$("#sidebar-version-control-repo-toolbar-message").text("The branch will be created. Select below to set it as the tracked upstream branch."):($("#sidebar-version-control-repo-toolbar-message").text("The created branch will be set as the tracked upstream branch."),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!0),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!0)),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1);else{var t=Date.now(),n=G.addSpinnerOverlay($("#sidebar-version-control-repo-toolbar-message")).addClass("projects-dialog-spinner-contain");$.getJSON("projects/"+o.name+"/branches/remote/"+e.name+"/status",function(e){setTimeout(function(){X(e.commits.ahead,e.commits.behind),n.remove()},Math.max(400-(Date.now()-t),0))})}})}}),C=$('<div style="margin-bottom: 5px;"></div>').appendTo(y);$('<button id="sidebar-version-control-repo-push" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-up"></i> <span>push</span></button>').appendTo(C).click(function(e){e.preventDefault();var t=G.addSpinnerOverlay(y).addClass("projects-dialog-spinner-contain"),n=RED.projects.getActiveProject(),o="projects/"+n.name+"/push";n.git.branches.remoteAlt&&(o+="/"+n.git.branches.remoteAlt);var a=$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked");a&&(o+="?u=true"),G.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){a&&n.git.branches.remoteAlt&&(n.git.branches.remote=n.git.branches.remoteAlt,delete n.git.branches.remoteAlt),Z(!0),w()},400:{git_push_failed:function(e){RED.notify("NLS: Push failed as the remote has more recent commits. Pull first and write a better error message!","error")},unexpected_error:function(e){console.log(e)}}}},{}).always(function(){t.remove()})});var j=function(n){n=n||{};var e=G.addSpinnerOverlay(y).addClass("projects-dialog-spinner-contain"),t=RED.projects.getActiveProject(),o="projects/"+t.name+"/pull";t.git.branches.remoteAlt&&(o+="/"+t.git.branches.remoteAlt),(n.setUpstream||n.allowUnrelatedHistories)&&(o+="?"),n.setUpstream&&(o+="setUpstream=true",n.allowUnrelatedHistories&&(o+="&")),n.allowUnrelatedHistories&&(o+="allowUnrelatedHistories=true"),G.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){n.setUpstream&&t.git.branches.remoteAlt&&(t.git.branches.remote=t.git.branches.remoteAlt,delete t.git.branches.remoteAlt),Z(!0),w()},400:{git_local_overwrite:function(e){RED.notify('<p>Unable to pull remote changes; your unstaged local changes would be overwritten.</p><p>Commit your changes and try again.</p><p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">Show unstaged changes</a></p>',"error",!1,1e7)},git_pull_merge_conflict:function(e){Z(!0),w()},git_connection_failed:function(e){RED.notify("Could not connect to remote repository: "+e.toString(),"warning")},git_pull_unrelated_history:function(e){var t=RED.notify("<p>The remote has an unrelated history of commits.</p><p>Are you sure you want to pull the changes into your local repository?</p>",{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:"Pull changes",click:function(){t.close(),n.allowUnrelatedHistories=!0,j(n)}}]})},"*":function(e){G.reportUnexpectedError(e)}}}},{}).always(function(){e.remove()})};$('<button id="sidebar-version-control-repo-pull" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-down"></i> <span>pull</span></button>').appendTo(C).click(function(e){e.preventDefault(),j({setUpstream:$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked")})}),$('<div class="component-shade sidebar-version-control-shade">').appendTo(S),RED.sidebar.addTab({id:"version-control",label:"history",name:"Project History",content:S,enableOnEdit:!1,onchange:function(){setTimeout(function(){O.resize()},10)}})},show:Q,refresh:Z,showLocalChanges:function(){RED.sidebar.show("version-control"),B.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var f=null,h=!1,g=!1,v=null;return{show:function(e,i,t){h=!0;try{$("body").width(),$("body").height();for(var o=(f=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){u(),d3.event.preventDefault()})).append("div").style({position:"absolute",top:i[1]-80+"px",left:i[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),s=[],n=function(e,t,n){n.el=o.append("div").style({position:"absolute",top:t+80-25+"px",left:e+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),n.el.html(n.name),n.disabled&&n.el.style({"border-color":"#ccc",color:"#ccc"}),n.x=e,n.y=t,s.push(n),n.el.on("touchstart",function(){n.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),n.el.on("touchend",function(){u(),n.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},a=t.length,r=Math.max(Math.PI/(a-1),Math.PI/4),d=Math.PI,l=0;l<a;l++){var c=Math.floor(80*Math.cos(d)),p=Math.floor(80*Math.sin(d));t[l].name&&n(c,p,t[l]),d+=r}var u=function(){h=!1,v=null,f.remove(),f=null};e.on("touchend.radial",function(){if(e.on("touchend.radial",null),e.on("touchmenu.radial",null),v){try{v.onselect()}catch(e){RED._debug(e)}u()}else g&&u()}),e.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-i[0],e.pageY-i[1]],n=0;n<s.length;n++){var o=s[n];o.disabled||(t[0]>o.x-30&&t[0]<o.x+30&&t[1]>o.y-30&&t[1]<o.y+30?o!==v&&(o.el.style("background","#999"),v=o):o===v?(o.el.style("background","#fff"),v=null):o.el.style("background","#fff"))}if(!v){var a=Math.abs(t[0]*t[0]+t[1]*t[1]);g=6400<a}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return h}}}();
